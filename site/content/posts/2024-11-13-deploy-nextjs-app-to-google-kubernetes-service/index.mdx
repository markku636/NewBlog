---
featured: true
title: 從地端到雲端：使用 Google Kubernetes Engine 部署你的Next.js 應用
date:  2024-11-13 01:01:35 +0800
thumbnail:  gke.png
category:  Cloud  
tags:   ['Google Cloud','Docker','Artifact Registry','kubernetes','GKE','google kubernetes engine']
description : 從地端到雲端：使用 Google Kubernetes Engine 部署你的Next.js 應用
author : Mark Ku
slug: deploy-nextjs-app-to-google-kubernetes-service
---
## 前言
先前[有透過 Cloud Run 運行容器應用](https://blog.markkulab.net/on-prem-to-cloud-gcp-docker-deployment-artifact-registry-cloud-run/)，也有試著在[地端架了Kubernetes](https://blog.markkulab.net/enable-docker-2375-port-in-ubuntu22/)，這篇來談 GKS (google kubernetes engine)，目前市面上的雲服務，都是基於 Kubernetes 的雲端架構服務，如:AWS、AKS、GKS，因此 Kubernetes的基礎知識就顯得很重要，但Kubernetes 的官方文件也真的很多東西，只好邊實作邊學習。

## 環境準備
1. 確保本地已安裝 Docker 和 Google Cloud CLI。
2. 啟用 GCP 的 Kubernetes API。
   ![enable kubernetes api](enable-kubernetes-api.png)
3. 在 GCP 中建立 Google Artifact Registry。
4. Google Cloud CLI 登入及設定好專案。

## 首先，初始化 Next.js 專案
```bash
npx create-next-app@latest nextjs-blog --use-npm --example "https://github.com/vercel/next-learn/tree/main/basics/learn-starter"
cd nextjs-blog
```

接著，[複製官方範例的 Dockerfile 和 next.config.js 到專案根目錄](https://github.com/vercel/next.js/tree/canary/examples/with-docker)。

### 建置與推送 Docker 映像檔到 Google Artifact Registry
```powershell
docker build -t asia-east1-docker.pkg.dev/gcr-my-project01/my-registry/blog:v2 .
docker run -d -p 8888:80 asia-east1-docker.pkg.dev/gcr-my-project01/my-registry/blog:v2
docker push asia-east1-docker.pkg.dev/gcr-my-project01/my-registry/blog:v2
```

## 建立 Kubernetes Clusters
Clusters 有兩種模式
- **GKE Autopilot：**  
  - 自動管理基礎設施，使用者只需專注於應用部署和工作負載。
  - 系統會根據需求自動調整資源，並按使用量計費。
  - 適合希望簡化管理的團隊，無需手動配置節點。

- **GKE Standard：**  
  - 需手動配置節點資源和管理叢集，提供更高的靈活性。
  - 使用者可進行更深入的自訂控制，但管理負擔較高。
  - 適合需要細節控制和自訂設定的使用者。  

可以使用網頁或腳本指令建立 Kubernetes clusters。
### Kubernetes Engine > Cluster > Create
![create cluster](create-cluster.png)

### 使用指令建立
** 標準 (Standard)**
```bash
gcloud container clusters create blog-cluster --num-nodes 2 --machine-type n1-standard-1 --zone asia-east1-a
```

**GKE Autopilot**
```bash
gcloud container clusters create-auto blog-autopilot-cluster --region asia-east1
```
## 部署應用
### 使用網頁部署容器
1. 回到 GCP 後台，選擇 Kubernetes Engine > Workloads > Deploy。
2. 設定伺服器節點與部署名稱。
   ![deployment by web ui](deployment-by-web-ui.png)
3. 選擇先前上傳的 Google Artifact Registry 映像檔。
   ![select docker image](select-docker-image.png)
4. 設定內外部連接埠。
   ![change mapping port](change-mapping-port.png)
5. 查看 YAML 配置後點擊 Deploy。
   ![check yaml file](check-yaml.png)

### 使用腳本指令部署
**連線至叢集**：從 Cloud Shell 使用 kubectl 操作。
![use kubectl in cloud shell](use-kubectl-in-cloud-shell.png)
```bash
kubectl get nodes
```

![kubectl get nodes in cloud shell](kubectl-get-nodes-in-cloud-shell.png)

**建立 Deployment**
```bash
vim nextjs-blog-deployment.yaml
```

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-blog
  labels:
    app: nextjs-blog
spec:
  selector:
    matchLabels:
      app: nextjs-blog
      tier: web
  template:
    metadata:
      labels:
        app: nextjs-blog
        tier: web
    spec:
      containers:
      - name: nextjs-blog-app
        image: asia-east1-docker.pkg.dev/gcr-my-project01/my-registry/blog:v2
        ports:
        - containerPort: 3000
```

應用 Deployment：
```bash
kubectl apply -f nextjs-blog-deployment.yaml
kubectl get deploy nextjs-blog
```

**網路設定 - Load Balancer**
**自動建立外部服務、 Load Balancer 設定、挷定外部 IP **
```bash
kubectl expose deployment nextjs-blog-deployment --type="LoadBalancer"
```

**也可以指定連接埠的方式建立**
```bash
kubectl expose deployment nextjs-blog-deployment --name=nextjs-blog-service --port=80 --target-port=3000 --type=LoadBalancer
```
[指定連接埠相關文件](https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/)

#### 部署完成後訪問服務
點選服務進行訪問。
![deployment finish](deployment-finish)
訪問 Next.js 網站：
![check accessible](check-accessible.png)

#### 其他操作
若需要額外的連接埠映射，可使用下方Expose 按鈕：
![manual expose](manual-expose.png)

## 參考資料
[How to deploy NextJS app to Kubernetes Cluster in GCP with Custom Domain?](https://walkthrough.so/pblc/FHQPWEGGWSPT/how-to-deploy-nextjs-app-to-kubernetes-cluster-in-gcp-with-custom-domain?sn=7)






