---
featured: true
title: æ‰“é€ é«˜æ•ˆ API ç®¡ç†å¹³å°ï¼šå¾ 0 é–‹å§‹éƒ¨ç½² Kong Gateway - Part 1
date: 2025-06-19 01:01:35 +0800
thumbnail: kong-api-gateway-overview.png
category: API Management
tags: ['kong', 'api gateway', 'reverse proxy', 'rate limiting', 'docker']
description: æœ¬ç¯‡å°‡å¸¶ä½ å¾é›¶é–‹å§‹å®‰è£ä¸¦éƒ¨ç½² Kong API Gatewayï¼Œä¸¦ä»‹ç´¹å…¶æ ¸å¿ƒåŠŸèƒ½ã€å¸¸ç”¨è¨­å®šã€Docker éƒ¨ç½²ç¯„ä¾‹èˆ‡é€²éšå¯¦æˆ°ï¼Œå¦‚é™æµã€åå‘ä»£ç†èˆ‡é«˜å¯ç”¨æ¶æ§‹ç­‰ã€‚
author: Mark Ku
slug: kong-api-gateway-part1-setup
---

# ğŸ’¡ Kong æ˜¯ä»€éº¼ï¼Ÿ

Kong æ˜¯ä¸€å¥—åŸºæ–¼ Nginx å’Œ OpenResty çš„é«˜æ•ˆèƒ½ API Gatewayï¼Œæ ¸å¿ƒä»¥ Lua ç·¨å¯«ï¼Œå…·å‚™åå‘ä»£ç†ã€API ç®¡ç†èˆ‡æ’ä»¶æ“´å……ç­‰åŠŸèƒ½ã€‚Kong å¯æ­é… PostgreSQL ä½œç‚ºè¨­å®šå„²å­˜ï¼Œä¹Ÿæ”¯æ´ç„¡è³‡æ–™åº«ï¼ˆDB-lessï¼‰æ¨¡å¼ï¼Œé€ééœæ…‹ YAML æˆ– JSON æª”ç›´æ¥è¼‰å…¥é…ç½®ã€‚

ğŸ“Œ **DB-less æ¨¡å¼èªªæ˜**ï¼šKong åœ¨å•Ÿå‹•æ™‚å¾è¨­å®šæª”è¼‰å…¥æ‰€æœ‰è¨­å®šï¼ˆå¦‚è·¯ç”±ã€æœå‹™ã€æ’ä»¶ï¼‰ï¼Œä¸éœ€è³‡æ–™åº«å³å¯é‹è¡Œï¼Œé©åˆéƒ¨ç½²åœ¨ CI/CD ç’°å¢ƒä¸­ã€‚


---

# ğŸ”§ Kong å¯ä»¥åšä»€éº¼ï¼Ÿ

* ğŸ” è² è¼‰å¹³è¡¡ï¼ˆåå‘ä»£ç†ï¼‰
* ğŸšª çµ±ä¸€ API é€²å…¥é»ï¼ˆAPI Gatewayï¼‰
* ğŸš€ æ”¯æ´å¤šç’°å¢ƒèˆ‡ç‰ˆæœ¬éƒ¨ç½²
* ğŸ“Š API ä½¿ç”¨çµ±è¨ˆèˆ‡è¨ˆè²»
* ğŸ” å®‰å…¨é©—è­‰ï¼ˆAPI Keyã€JWTã€OAuth2 ç­‰ï¼‰


---

# ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

* ç®¡ç†èˆ‡éƒ¨ç½² RESTful API è®Šå¾—ç°¡å–®é«˜æ•ˆ
* æ”¯æ´ API ç‰ˆæœ¬æ§ç®¡èˆ‡æ¬Šé™é©—è­‰
* å¯ä¾ä½¿ç”¨è€…ç­‰ç´šè¨­å®šè«‹æ±‚é™åˆ¶ï¼ˆRate Limitingï¼‰
* è®Šæ›´è¨­å®šæ™‚ï¼ŒåŸºæ–¼ Nginx æ¶æ§‹ç„¡é ˆé‡å•Ÿæœå‹™
* å¼·å¤§çš„æ’ä»¶æ©Ÿåˆ¶ï¼Œå¯æ“´å……åŠŸèƒ½æˆ–è‡ªè¨‚é–‹ç™¼


---

# ğŸŒ å®˜æ–¹æ–‡ä»¶

<https://docs.konghq.com/gateway/latest/>


---

# ğŸ› ï¸ é¡ä¼¼å·¥å…·æ¯”è¼ƒ

* **Apache APISIX**
* **Tyk**
* **NGINX Plusï¼ˆå•†ç”¨ï¼‰**


---

# ğŸš€ å®‰è£ Kongï¼ˆDocker  with  db ç‰ˆï¼‰

```yaml
version: '3.8'

services:
  kong-database:
    image: postgres:13
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kong
    ports:
      - "5432:5432"

  kong-migrations:
    image: kong:3.6.0
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kong
    depends_on:
      - kong-database

  kong:
    image: kong:3.6.0
    container_name: kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PASSWORD: kong
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_ADMIN_GUI_API_URL: http://localhost:8001
    ports:
      - "8000:8000"   # Proxy
      - "8443:8443"   # Proxy SSL
      - "8001:8001"   # Admin API
      - "8002:8002"   # Kong Dashboard
    depends_on:
      - kong-database
      - kong-migrations
```

å•Ÿå‹•æŒ‡ä»¤ï¼š

```bash
docker-compose up -d
```

é–‹å•Ÿ Dashboard: <http://localhost:8002>
![Dashboard](dashboard.png)

é è¨­å°±å®‰è£äº†å¾ˆå¤šæ–¹ä¾¿å¥—ä»¶ï¼Œä¸å¤ æ™‚ä¹Ÿèƒ½è‡ªå·±åšæ“´å……
![Plugins](plugins.png)

---

# ğŸ§­ å¸¸ç”¨ Port èªªæ˜

| Port | ç”¨é€” | å”å®š | æè¿° |
|----|----|----|----|
| `8000` | Proxy (HTTP) | HTTP | å¤–éƒ¨ API è«‹æ±‚å…¥å£ |
| `8443` | Proxy (HTTPS) | HTTPS | åŠ å¯†è«‹æ±‚å…¥å£ |
| `8001` | Admin API | HTTP | ç®¡ç†è·¯ç”±ã€æœå‹™ã€æ’ä»¶ç­‰ |
| `8002` | Kong Dashboard | HTTP | åœ–å½¢åŒ–ç®¡ç†ä»‹é¢ |


---

# âœ… å¿«é€Ÿæ¸¬è©¦ - å»ºç«‹åå‘ä»£ç†

å»ºç«‹æœå‹™ï¼š

```bash
POST http://localhost:8001/services
Content-Type: application/json

{
  "name": "my-service",
  "url": "https://blog.markkulab.net/"
}
```

å»ºç«‹è·¯ç”±ï¼š

```bash
POST http://localhost:8001/services/my-service/routes
Content-Type: application/json

{
  "paths": ["/blog"]
}
```

æ¸¬è©¦çµæœï¼š

```
http://localhost:8000/blog -> https://blog.markkulab.net/
```


---

# ğŸ”„ è² è¼‰å¹³è¡¡ç­–ç•¥

| ç­–ç•¥åç¨± | èªªæ˜ | é–‹æºæ”¯æ´ |
|----|----|----|
| Round-robin | è¼ªè©¢åˆ†é…è«‹æ±‚ | âœ… |
| Weighted round-robin | æŒ‰æ¬Šé‡åˆ†é…è«‹æ±‚ | âœ… |
| Least-connections | é€£ç·šæ•¸æœ€å°‘å„ªå…ˆ | âŒï¼ˆéœ€ä¼æ¥­ç‰ˆï¼‰ |

ğŸ” **è£œå……**ï¼š

* æ”¯æ´å¥åº·æª¢æŸ¥ï¼Œè‡ªå‹•æ’é™¤æ•…éšœç¯€é»
* æ”¯æ´ DNS å‹•æ…‹ç™¼ç¾ target


---

# ğŸ“ˆ è«‹æ±‚é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

é€é Consumer èˆ‡ Key Auth æ­é… Rate Limiting æ’ä»¶ï¼Œå¯æ ¹æ“šç”¨æˆ¶ç­‰ç´šè¨­å®šé »ç‡ã€‚

| ç­‰ç´š | é™åˆ¶ |
|----|----|
| åŸºç¤æœƒå“¡ | æ¯åˆ†é˜ 5 æ¬¡ |
| éŠ…ç´š | æ¯ç§’ 5 æ¬¡ |
| éŠ€ç´š | æ¯ç§’ 10 æ¬¡ |
| é‡‘ç´š | æ¯ç§’ 30 æ¬¡ |
| ç™½é‡‘ç´š/å°ˆæ¡ˆ | æ¯ç§’ 50 æ¬¡ |

åŸºæœ¬æµç¨‹ï¼š


1. å»ºç«‹ Consumer
2. å»ºç«‹ key-auth æ†‘è­‰
3. å¥—ç”¨ rate-limiting æ’ä»¶

ç¯„ä¾‹ï¼š

```bash
POST /consumers
{ "username": "gold" }

POST /consumers/gold/key-auth

POST /consumers/gold/plugins
{
  "name": "rate-limiting",
  "config": {
    "second": 30,
    "policy": "local"
  }
}
...
```

API è«‹æ±‚æ™‚å¸¶ä¸Š keyï¼š

```bash
GET /your-api
apikey: <your-key>
```


---

# ğŸ§ª æ€§èƒ½èˆ‡å£“åŠ›æ¸¬è©¦

ğŸ“Œ å®˜æ–¹å¯¦æ¸¬ï¼šå–®å° 8 vCPU æ©Ÿå™¨ï¼ŒQPS å¯é” 10\~20 è¬ï¼Œå»¶é²ä½æ–¼ 10msã€‚

ğŸ”— è©³ç´°å ±å‘Šï¼š[Kong Gateway Performance Benchmark](https://docs.konghq.com/gateway/latest/production/performance/performance-testing/)

ğŸ“Œ æ›´å¤§æµé‡å ´æ™¯å»ºè­°è€ƒæ…®ç¡¬é«”è¨­å‚™ï¼ˆå¦‚ F5ï¼‰ã€‚


---

# ğŸ›¡ï¸ é«˜å¯ç”¨æ¶æ§‹ï¼ˆHAï¼‰

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ LoadBalancer â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
 â”‚ Kong #1 â”‚...â”‚ Kong #N â”‚
 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚    â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ PostgreSQL  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

# ğŸ“Š å£“æ¸¬å·¥å…·ï¼šK6

å®‰è£ï¼š

```bash
npm install -g k6
```

æ¸¬è©¦è…³æœ¬ï¼š

```js
import http from 'k6/http';
import { sleep } from 'k6';

export default function () {
  http.get('http://localhost:8000/v1/users');
  sleep(1);
}
```

åŸ·è¡Œï¼š

```bash
k6 run script.js
```


---

# ğŸ“Œ å°å…¥è©•ä¼°å»ºè­°


1. **API ç®¡ç†éœ€æ±‚**
   * API æ•¸é‡ã€é¡å‹ï¼ˆRESTã€GraphQLã€gRPCï¼‰
   * æ˜¯å¦éœ€ç‰ˆæœ¬æ§åˆ¶ã€æ–‡ä»¶ç”Ÿæˆ
2. **å®‰å…¨éœ€æ±‚**
   * èªè­‰æ–¹å¼ï¼ˆOAuth2ã€JWTã€API Keyï¼‰
   * æ¬Šé™æ§ç®¡èˆ‡æ³•è¦éµå¾ªï¼ˆå¦‚ GDPRã€PCIï¼‰
3. **æµé‡éœ€æ±‚**
   * æ˜¯å¦éœ€è² è¼‰å¹³è¡¡
   * é€Ÿç‡é™åˆ¶èˆ‡æµé‡æ•´å½¢


---

# ğŸ“š å»¶ä¼¸é–±è®€èˆ‡è³‡æº

* [Kong Kubernetes Ingress Controller](https://docs.konghq.com/kubernetes-ingress-controller/latest/)
* [CSDNï¼šKongå¯¦æˆ°æ•™å­¸](https://blog.csdn.net/zhangshenglu1/article/details/145325419)


