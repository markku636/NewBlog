---
featured: true
title: ç”¨ Argo CD å¯¦ä½œ GitOpsï¼šå¾ Helm å®‰è£åˆ° GitLab SSO ä¸€æ¬¡æå®š
slug: argocd-gitops-helm-installation-and-gitlab-sso-setup
category: DevOps
thumbnail: argocd-gitops-helm-installation-and-gitlab-sso-setup.png
date: 2025-11-20 10:00:00 +0800
tags: ['Kubernetes', 'Argo CD', 'GitOps', 'Helm', 'GitLab', 'DevOps']
description: ä»¥å¯¦å‹™æ­¥é©Ÿç¤ºç¯„å¦‚ä½•ç”¨ Helm å®‰è£ Argo CDï¼Œä¸¦çµåˆ GitOps èˆ‡ GitLab SSOï¼Œè®“å¤šå¢é›† K8s éƒ¨ç½²ç®¡ç†è‡ªå‹•åŒ–åˆå¯å›æº¯ã€‚
author: Mark Ku
---

## å‰è¨€

ç•¶ä½ åŒæ™‚ç®¡ç† **10ï½20 å€‹ Kubernetes é›†ç¾¤**æ™‚ï¼Œä½¿ç”¨ kubectl æ‰‹å‹•éƒ¨ç½²ä¸åƒ…è€—æ™‚ï¼Œä¹Ÿå®¹æ˜“å‡ºéŒ¯ã€‚å°±åƒè¦åœ¨ 20 å°æ‰‹æ©Ÿä¸Šå®‰è£åŒä¸€å€‹ Appï¼Œé€ä¸€æ“ä½œé²æ—©æœƒæ¼æ‰æŸä¸€å°ã€‚

**Argo CD** æ­é… **GitOps** å¯ä»¥è§£æ±ºé€™å€‹å•é¡Œï¼Œä½†å­¸ç¿’æ›²ç·šç¢ºå¯¦æ¯” kubectl é™¡å³­ã€‚ä½ éœ€è¦ç†è§£ï¼š

- GitOps çš„å®£å‘Šå¼æ€ç¶­èˆ‡å–®ä¸€çœŸç›¸ä¾†æºæ¦‚å¿µ
- Argo CD çš„ Applicationã€Projectã€Sync é‹ä½œæ©Ÿåˆ¶
- Helmã€OAuthã€Registryã€RBAC ç­‰æ•´åˆæŠ€è¡“

ä¸éï¼Œä¸€æ—¦æŒæ¡é€™äº›çŸ¥è­˜ï¼Œå¤šå¢é›†èˆ‡å¤šç’°å¢ƒçš„ç¶­é‹æ•ˆç‡å°‡å¤§å¹…æå‡ã€‚

æœ¬æ–‡å°‡å¸¶ä½ å®Œæˆä»¥ä¸‹ä¸‰å€‹ç›®æ¨™ï¼š

1. ç†è§£ Argo CD åœ¨ GitOps æ¶æ§‹ä¸­çš„å®šä½
2. ä½¿ç”¨ Helm å®‰è£èˆ‡é…ç½® Argo CD
3. æ•´åˆ GitLab SSO å¯¦ç¾å®‰å…¨çš„ç™»å…¥èˆ‡æ¬Šé™ç®¡ç†

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€éº¼æ˜¯ GitOpsï¼Ÿ

**GitOps** æ˜¯ä¸€ç¨®ä»¥ Git ç‚ºä¸­å¿ƒçš„é‹ç¶­æ–¹æ³•è«–ï¼š

- **Git ä½œç‚ºå”¯ä¸€çœŸç›¸ä¾†æº**ï¼šæ‰€æœ‰ Kubernetes è¨­å®šæª”éƒ½å­˜æ”¾åœ¨ Git å€‰åº«ä¸­
- **è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶**ï¼šç³»çµ±è‡ªå‹•å°‡ Git ä¸­çš„è¨­å®šå¥—ç”¨åˆ°æ‰€æœ‰ç’°å¢ƒ
- **ç‰ˆæœ¬å¯è¿½æº¯**ï¼šæ¯æ¬¡è®Šæ›´éƒ½æœ‰å®Œæ•´çš„ Git æ­·å²è¨˜éŒ„ï¼Œå‡ºéŒ¯æ™‚å¯å¿«é€Ÿå›æ»¾

æ¯”å–»ä¾†èªªï¼ŒGit å°±åƒä¸€æœ¬æ¨™æº–é£Ÿè­œï¼Œè€Œ GitOps å·¥å…·æœƒç¢ºä¿æ‰€æœ‰å»šæˆ¿ï¼ˆé›†ç¾¤ï¼‰éƒ½æŒ‰ç…§åŒä¸€ä»½é£Ÿè­œçƒ¹é£ªã€‚

### Argo CD çš„è§’è‰²
![](how-argocd-work.png)

Argo CD æ˜¯ GitOps çš„å¯¦è¸å·¥å…·ï¼Œè² è²¬ï¼š

- æŒçºŒç›£æ§ Git å€‰åº«çš„è®Šæ›´
- è‡ªå‹•å°‡è®Šæ›´åŒæ­¥åˆ° Kubernetes é›†ç¾¤
- ç¢ºä¿å¯¦éš›ç‹€æ…‹èˆ‡ Git å®šç¾©ä¿æŒä¸€è‡´
- é€é UI å’Œ Git æ­·å²è¨˜éŒ„è¿½è¹¤æ‰€æœ‰è®Šæ›´

å…¶æ ¸å¿ƒåƒ¹å€¼åœ¨æ–¼è®“åŸºç¤è¨­æ–½ç®¡ç†è®Šå¾—**æ›´å®‰å…¨ã€æ›´ä¸€è‡´ã€æ›´æ˜“æ–¼ç¶­è­·**ã€‚

### ç†è§£ GitLab Token é¡å‹

åœ¨ Argo CD èˆ‡ GitLab çš„æ•´åˆä¸­ï¼Œå¸¸ç”¨å…©ç¨® Tokenï¼š

#### Personal Access Token (PAT)
- **ç¶å®šå°è±¡**ï¼šå€‹äººå¸³è™Ÿ
- **æ¬Šé™ç¯„åœ**ï¼šç¹¼æ‰¿ä½¿ç”¨è€…æ¬Šé™
- **é©ç”¨å ´æ™¯**ï¼šå€‹äººå¯¦é©—ã€PoCã€å°å‹å°ˆæ¡ˆ

#### Group Access Token
- **ç¶å®šå°è±¡**ï¼šGitLab Group
- **æ¬Šé™ç¯„åœ**ï¼šåƒ…é™è©² Group çš„ `read_repository`ã€`read_api` ç­‰
- **é©ç”¨å ´æ™¯**ï¼šåœ˜éšŠå”ä½œã€ç”Ÿç”¢ç’°å¢ƒ

**å®‰å…¨æ€§æ¯”è¼ƒ**ï¼š

- PAT å¦‚åŒã€Œå€‹äººè¬ç”¨é‘°åŒ™ã€ï¼Œå¤–æ´©æ™‚å½±éŸ¿ç¯„åœå¤§
- Group Access Token å¦‚åŒã€Œå°ˆæ¡ˆæœå‹™é‘°åŒ™ã€ï¼Œå¯ç¨ç«‹ç®¡ç†èˆ‡è¼ªæ›¿ï¼Œä¸ç¶å®šå€‹äººå¸³è™Ÿ

æœ¬æ–‡æ¡ç”¨ **Group Access Token**ï¼Œè®“ Argo CD è®€å–æ•´å€‹ Group çš„å€‰åº«ï¼Œç¶­è­·æ›´ç°¡æ½”ä¸”ç¬¦åˆåœ˜éšŠä½¿ç”¨æƒ…å¢ƒã€‚
---

## å®‰è£æµç¨‹

### Step 1ï¼šæº–å‚™ Helm ç’°å¢ƒ

åŠ å…¥ Argo CD çš„ Helm repository ä¸¦åŒ¯å‡ºé è¨­è¨­å®šæª”ï¼š

```bash
# æ–°å¢ Helm repository
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

# åŒ¯å‡ºé è¨­ values ä¾›ä¿®æ”¹ä½¿ç”¨
helm show values argo/argo-cd --version 8.3.2 > values.yaml
```

### Step 2ï¼šå»ºç«‹ GitLab OAuth Application

å‰å¾€ GitLab è¨­å®š SSO æ•´åˆï¼š

1. ç™»å…¥ GitLab â†’ é»é¸å³ä¸Šè§’é ­åƒ â†’ `Settings â†’ Applications`
2. é»é¸ **New Application** ä¸¦å¡«å¯«ï¼š
   - **Name**ï¼š`ArgoCD SSO`
   - **Redirect URI**ï¼š`http://<your-node-ip>:32009/api/dex/callback`
   - **Scopes**ï¼šå‹¾é¸ `openid`, `read_user`, `email`
3. å„²å­˜å¾Œå–å¾— **Application ID** å’Œ **Secret**

> âš ï¸ è«‹å¦¥å–„ä¿å­˜ Client ID å’Œ Secretï¼Œä¸è¦æäº¤åˆ° Git å€‰åº«ä¸­ã€‚

### Step 3ï¼šå»ºç«‹ GitLab Group Access Token

ç‚º Argo CD å»ºç«‹å€‰åº«è®€å–æ¬Šé™ï¼š

1. å‰å¾€ GitLab Group â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹æ–° Tokenï¼š
   - **Name**ï¼š`argocd-group-readonly`
   - **Scopes**ï¼šå‹¾é¸ `read_repository` å’Œ `read_api`
   - **Role**ï¼šé¸æ“‡ `Reporter`
3. å„²å­˜å¾Œè¤‡è£½ Tokenï¼ˆåªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼‰

### Step 4ï¼šé…ç½® values.yaml

ç·¨è¼¯ `values.yaml`ï¼Œæ•´åˆæ‰€æœ‰è¨­å®šï¼š

```yaml
configs:
  cm:
    # Argo CD å°å¤– URL
    url: http://<your-node-ip>:32009
    
    # GitLab SSO è¨­å®š
    dex.config: |
      connectors:
        - type: gitlab
          id: gitlab
          name: GitLab
          config:
            baseURL: https://gitlab.example.com
            clientID: <your-gitlab-oauth-client-id>
            clientSecret: <your-gitlab-oauth-client-secret>
            redirectURI: http://<your-node-ip>:32009/api/dex/callback
    
  # GitLab Repository èªè­‰ï¼ˆä½¿ç”¨ Group Access Tokenï¼‰
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
      
  # é å…ˆè¨»å†Šçš„ Repository
  repositories:
    kong-api-gateway:
      url: https://gitlab.example.com/your-group/kong-api-gateway.git
      type: git
    argocd-deployment:
      url: https://gitlab.example.com/your-group/argocd-deployment.git
      type: git

# Server ç¶²è·¯è¨­å®š
server:
  service:
    type: NodePort
    nodePortHttp: 32009
    nodePortHttps: 32010
  
  # å…è¨± HTTPï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼‰
  extraArgs:
    - --insecure
```

> ğŸ’¡ **ç”Ÿç”¢ç’°å¢ƒå»ºè­°**ï¼šä½¿ç”¨ Ingress + TLS å–ä»£ NodePortï¼Œä¸¦ç§»é™¤ `--insecure` åƒæ•¸ã€‚

### Step 5ï¼šåŸ·è¡Œå®‰è£

å¥—ç”¨è¨­å®šæª”ä¸¦å®‰è£ Argo CDï¼š

```bash
# å®‰è£ Argo CD
helm upgrade --install homelab-argo argo/argo-cd \
  --version 8.3.2 \
  -f values.yaml \
  -n argocd --create-namespace

# ç­‰å¾… Pod å°±ç·’
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/name=argocd-server \
  -n argocd --timeout=300s

# å–å¾—åˆå§‹ admin å¯†ç¢¼
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

ç™»å…¥å¾Œè«‹ç«‹å³ä¿®æ”¹ admin å¯†ç¢¼ã€‚

---

## æ¬Šé™ç®¡ç†

### Step 6ï¼šè¨­å®š RBAC èˆ‡ AppProject

å®‰è£å®Œæˆå¾Œï¼Œéœ€è¦é…ç½® AppProject ä¾†ç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„æ¬Šé™ç¯„åœã€‚

å»ºç«‹ `argocd-projects.yaml`ï¼š

```yaml
apiVersion: v1
kind: List
items:
# Default Project - åŸºæœ¬æ¬Šé™
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: default
    namespace: argocd
  spec:
    # å…è¨±æ‰€æœ‰ä¾†æº repo
    sourceRepos:
    - '*'
    
    # å…è¨±éƒ¨ç½²åˆ°æ‰€æœ‰å¢é›†èˆ‡ namespace
    destinations:
    - namespace: '*'
      server: '*'
    
    # å…è¨±æ“ä½œé›†ç¾¤ç´šè³‡æº
    clusterResourceWhitelist:
    - group: '*'
      kind: '*'
    
    # å…è¨±æ“ä½œå‘½åç©ºé–“ç´šè³‡æº
    namespaceResourceWhitelist:
    - group: '*'
      kind: '*'

# è‡ªè¨‚ Project - ä¾éœ€æ±‚èª¿æ•´
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: your-project
    namespace: argocd
  spec:
    description: ä½ çš„å°ˆæ¡ˆæè¿°
    
    sourceRepos:
    - 'https://gitlab.example.com/your-group/*'
    
    destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
    
    # é›†ç¾¤ç´šè³‡æºç™½åå–®
    clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRole
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRoleBinding
    - group: 'apiextensions.k8s.io'
      kind: CustomResourceDefinition
    
    # å‘½åç©ºé–“ç´šè³‡æºç™½åå–®
    namespaceResourceWhitelist:
    - group: ''
      kind: ConfigMap
    - group: ''
      kind: Secret
    - group: ''
      kind: Service
    - group: ''
      kind: ServiceAccount
    - group: 'apps'
      kind: Deployment
    - group: 'apps'
      kind: StatefulSet
    - group: 'batch'
      kind: Job
    - group: 'batch'
      kind: CronJob
    - group: 'networking.k8s.io'
      kind: Ingress

# Argo CD Controller é¡å¤–çš„ RBAC æ¬Šé™ï¼ˆæ”¯æ´ metrics-server ç­‰ï¼‰
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: argocd-application-controller-auth-delegator
    labels:
      app.kubernetes.io/component: application-controller
      app.kubernetes.io/name: argocd-application-controller
      app.kubernetes.io/part-of: argocd
  rules:
  # Auth delegation for metrics-server
  - apiGroups: ["authentication.k8s.io"]
    resources: ["tokenreviews"]
    verbs: ["create"]
  - apiGroups: ["authorization.k8s.io"]
    resources: ["subjectaccessreviews"]
    verbs: ["create"]
  # API Services management
  - apiGroups: ["apiregistration.k8s.io"]
    resources: ["apiservices"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: argocd-application-controller-auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: argocd-application-controller-auth-delegator
  subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: argocd
```

### å¥—ç”¨è¨­å®š

```bash
# å¥—ç”¨ AppProject èˆ‡ RBAC è¨­å®š
kubectl apply -f argocd-projects.yaml -n argocd

# é©—è­‰ Project æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get appprojects -n argocd

# é©—è­‰ RBAC æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get clusterrole | grep argocd
kubectl get clusterrolebinding | grep argocd
```

### ç†è§£æ¬Šé™æ¶æ§‹

Argo CD èˆ‡ GitLab æ•´åˆæ¶‰åŠä¸‰å±¤æ¬Šé™ç®¡ç†ï¼š

**1. SSO ç™»å…¥ï¼ˆGitLab OAuthï¼‰**
- æ§åˆ¶ä½¿ç”¨è€…èº«åˆ†é©—è­‰èˆ‡æˆæ¬Š
- æ±ºå®šèª°å¯ä»¥å­˜å– Argo CD UI åŠå¯è¦‹çš„ Application ç¯„åœ
- æœ¬æ–‡å·²åœ¨ Step 4 çš„ `values.yaml` ä¸­å®Œæˆè¨­å®š

**2. Repository å­˜å–ï¼ˆGroup Access Tokenï¼‰**
- è®“ Argo CD è®€å– GitLab å€‰åº«çš„ç¨‹å¼ç¢¼èˆ‡ Helm Chart
- æ¡ç”¨ Group Access Token çµ±ä¸€ç®¡ç†æ•´å€‹ Group çš„æ¬Šé™
- å·²åœ¨ Step 4 çš„ `credentialTemplates` ä¸­å®Œæˆè¨­å®š

**3. Container Registryï¼ˆé¸ç”¨ï¼‰**
- è‹¥ä½¿ç”¨ GitLab Container Registry æ‹‰å–æ˜ åƒæª”ï¼Œéœ€é¡å¤–è¨­å®š
- å¯ä½¿ç”¨ Deploy Token å»ºç«‹ `imagePullSecrets`

![](attachments/abaaa408-6162-44e9-996f-8a1db2e70fba.png)

> ğŸ’¡ **ç°¡å–®è¨˜æ†¶**ï¼šSSO ç®¡ã€Œäººã€ï¼ŒGroup Token ç®¡ã€Œç¨‹å¼ç¢¼ã€ï¼ŒRegistry Token ç®¡ã€Œæ˜ åƒæª”ã€ã€‚

---

## é¸ç”¨é…ç½®

ä»¥ä¸‹æ˜¯ä¸€äº›æ›¿ä»£æ–¹æ¡ˆèˆ‡é€²éšè¨­å®šï¼Œå¦‚æœæ‚¨åœ¨å‰é¢çš„æ­¥é©Ÿä¸­å·²ç¶“é€é `values.yaml` å®Œæˆè¨­å®šï¼Œå¯ä»¥è·³éé€™äº›ç« ç¯€ã€‚

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ UI è¨­å®š SSOï¼ˆæ›¿ä»£ Step 4 çš„ values.yaml è¨­å®šï¼‰

è‹¥å®‰è£æ™‚æœªåœ¨ `values.yaml` ä¸­è¨­å®š OAuthï¼Œå¯é€é UI ä»‹é¢è£œå……ï¼š

1. ç™»å…¥ Argo CD UI â†’ `Settings â†’ SSO / OAuth`
2. é¸æ“‡ GitLab ä¸¦å¡«å¯«ï¼š
   - **Client ID**ï¼šGitLab OAuth Application ID
   - **Client Secret**ï¼šGitLab OAuth Secret
   - **Redirect URI**ï¼š`http://<your-node-ip>:32009/api/dex/callback`
3. å„²å­˜è¨­å®š

![](attachments/b8ce9bbd-f83d-4715-96e8-ca016638d3ef.png " =1874x907")
![](attachments/5a1836e9-f936-4e9c-9762-55b5eb67285e.png " =1548x674")

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ CLI ç®¡ç† Repositoryï¼ˆæ›¿ä»£ Step 4 çš„ credentialTemplates è¨­å®šï¼‰

è‹¥åå¥½ä½¿ç”¨ CLI è€Œé `values.yaml` ç®¡ç†å€‰åº«ï¼š

```bash
# å»ºç«‹ Kubernetes Secret
kubectl create secret generic argocd-gitlab-group-token \
  --from-literal=username=oauth2 \
  --from-literal=password=<your-gitlab-group-access-token> \
  -n argocd

# ä½¿ç”¨ Argo CD CLI æ–°å¢å€‰åº«
argocd repo add https://gitlab.example.com/your-group/your-repo.git \
  --username oauth2 \
  --password <your-gitlab-group-access-token>
```

### æ–¹æ¡ˆ Cï¼šé…ç½® GitLab Container Registry

è‹¥éœ€å¾ GitLab Container Registry æ‹‰å–æ˜ åƒæª”ï¼š

**1. å»ºç«‹ Deploy Token**

å‰å¾€ GitLab Project â†’ `Settings â†’ Repository â†’ Deploy Tokens`ï¼š
- Scopeï¼šå‹¾é¸ `read_registry`
- è¨˜éŒ„ Username å’Œ Token

**2. å»ºç«‹ Kubernetes Secret**

```bash
kubectl create secret docker-registry gitlab-registry \
  --docker-server=registry.gitlab.com \
  --docker-username=<Deploy-Token-Username> \
  --docker-password=<Deploy-Token> \
  --docker-email=<your-email@example.com> \
  -n <namespace>
```

**3. åœ¨ Deployment ä¸­å¼•ç”¨**

```yaml
spec:
  template:
    spec:
      containers:
        - name: my-app
          image: registry.gitlab.com/<group>/<project>/<image>:<tag>
      imagePullSecrets:
        - name: gitlab-registry
```

---

## å¯¦æˆ°ç¯„ä¾‹

### æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç¸½è¦½

åœ–è¡¨èªªæ˜ ![](attachments/37293e96-21b9-4734-b8b8-8f657ecd65e6.png)

é€™å¼µåœ–ç‰‡æ˜¯ [Argo CD](https://argo-cd.readthedocs.io/en/stable/) çš„æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç•«é¢ï¼Œç”¨ä¾†ç®¡ç† Kubernetes æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²ç‹€æ…‹ï¼š


* **æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š** `testapp`
* **APP HEALTHï¼ˆå¥åº·ç‹€æ…‹ï¼‰ï¼š** âœ… **Healthy** â†’ ä»£è¡¨æ‡‰ç”¨ç¨‹å¼ç›®å‰çš„æ‰€æœ‰è³‡æºéƒ½é‹ä½œæ­£å¸¸ã€‚
* **SYNC STATUSï¼ˆåŒæ­¥ç‹€æ…‹ï¼‰ï¼š** âœ… **Synced to HEAD (d227ef5)** â†’ è¡¨ç¤º Git å€‰åº«è£¡çš„è¨­å®šæª”å·²æˆåŠŸåŒæ­¥åˆ°å¢é›†ï¼Œæ²’æœ‰åå·®ã€‚
* **LAST SYNCï¼š** âœ… **Sync OK** â†’ æœ€è¿‘ä¸€æ¬¡åŒæ­¥æˆåŠŸï¼Œæ˜¯åœ¨ `18 hours ago`ï¼ˆ18 å°æ™‚å‰ï¼‰ç”± `mark.ku` å®Œæˆçš„ã€‚ â†’ æäº¤å‚™è¨»ç‚º `update config`ã€‚
* **Auto syncï¼š** âŒ **æœªå•Ÿç”¨è‡ªå‹•åŒæ­¥**ï¼ˆAuto sync is not enabledï¼‰


---

### ğŸŒ³ æ‡‰ç”¨ç¨‹å¼è³‡æºæ¶æ§‹åœ–è§£

é€™æ˜¯ä»¥ GitOps æ¨¡å¼éƒ¨ç½²çš„ Kubernetes æ‡‰ç”¨è³‡æºæ¨¹ç‹€åœ–ï¼š


1. **testappï¼ˆæ‡‰ç”¨ç¨‹å¼ï¼‰**
   * **nginx-contentï¼ˆConfigMapï¼‰**
   * **test-appï¼ˆNamespaceï¼‰**
   * **nginx-test-serviceï¼ˆServiceï¼‰**
   * **nginx-testï¼ˆDeploymentï¼‰**
     * **nginx-test-554867cd4bï¼ˆReplicaSetï¼‰**
       * **nginx-test-554867cd4b-65gtpï¼ˆPodï¼‰**
       * **nginx-test-554867cd4b-xgs9xï¼ˆPodï¼‰**

ğŸ“Œ æ‰€æœ‰è³‡æºå³ä¸Šè§’éƒ½æœ‰ âœ…ï¼Œè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€ç‹€æ…‹æ­£å¸¸ã€‚

---

## å¸¸ç”¨æŒ‡ä»¤åƒè€ƒ

### Helm ç›¸é—œ

```bash
# å®‰è£ Helmï¼ˆWindowsï¼‰
choco install kubernetes-helm

# å®‰è£/å‡ç´š Argo CD
helm upgrade --install argocd argo/argo-cd \
  --namespace argocd --create-namespace \
  -f values.yaml

# åŒ¯å‡ºç•¶å‰è¨­å®š
helm get values argocd -n argocd -o yaml > current-values.yaml
```

### Kubernetes ç›¸é—œ

```bash
# æŸ¥è©¢ Argo CD Service
kubectl get svc argocd-server -n argocd

# å°‡ Service æ”¹ç‚º NodePort
kubectl patch svc argocd-server -n argocd -p '{
  "spec": {
    "type": "NodePort",
    "ports": [
      {
        "port": 80,
        "targetPort": 8080,
        "nodePort": 32009
      }
    ]
  }
}'

# å–å¾—åˆå§‹ admin å¯†ç¢¼
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d

# åŒ¯å‡º AppProject è¨­å®š
kubectl get appprojects -n argocd -o yaml > argocd-projects.yaml
```

> âš ï¸ å–å¾— admin å¯†ç¢¼å¾Œï¼Œè«‹ç«‹å³ç™»å…¥ä¸¦ä¿®æ”¹å¯†ç¢¼ä»¥ç¢ºä¿å®‰å…¨ã€‚

---

## ç¸½çµ

é€éæœ¬æ–‡ï¼Œæ‚¨å·²ç¶“å®Œæˆï¼š

1. âœ… ç†è§£ GitOps èˆ‡ Argo CD çš„æ ¸å¿ƒæ¦‚å¿µ
2. âœ… ä½¿ç”¨ Helm å®Œæ•´å®‰è£èˆ‡é…ç½® Argo CD
3. âœ… æ•´åˆ GitLab SSO å¯¦ç¾å®‰å…¨çš„èº«åˆ†é©—è­‰
4. âœ… ä½¿ç”¨ Group Access Token ç®¡ç†å€‰åº«å­˜å–æ¬Šé™
5. âœ… è¨­å®š RBAC èˆ‡ AppProject æ§åˆ¶è³‡æºæ¬Šé™

**ä¸‹ä¸€æ­¥å»ºè­°**ï¼š

- å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ Applicationï¼Œå¯¦éš›é«”é©— GitOps å·¥ä½œæµç¨‹
- å•Ÿç”¨è‡ªå‹•åŒæ­¥åŠŸèƒ½ï¼Œå¯¦ç¾å®Œå…¨è‡ªå‹•åŒ–éƒ¨ç½²
- æ•´åˆ CI/CD Pipelineï¼Œå»ºç«‹å®Œæ•´çš„ DevOps æµç¨‹
- åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é…ç½® Ingress + TLSï¼Œæå‡å®‰å…¨æ€§

## åƒè€ƒè³‡æ–™

- [Argo CD å®˜æ–¹æ–‡ä»¶](https://argo-cd.readthedocs.io/)
- [Argo CD Helm Chart](https://github.com/argoproj/argo-helm)
- [GitLab OAuth è¨­å®š](https://docs.gitlab.com/ee/integration/oauth_provider.html)
- [Argo CD å¯¦ä½œç¯„ä¾‹](https://blog.csdn.net/cr7258/article/details/122028096)
- [GitOps æœ€ä½³å¯¦è¸](https://ithelp.ithome.com.tw/articles/10266761)