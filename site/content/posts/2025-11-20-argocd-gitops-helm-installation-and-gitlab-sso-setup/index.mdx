---
featured: true
title: ç”¨ Argo CD å¯¦ä½œ GitOpsï¼šå¾ Helm å®‰è£åˆ° GitLab SSO ä¸€æ¬¡æå®š
slug: argocd-gitops-helm-installation-and-gitlab-sso-setup
category: DevOps
thumbnail: argocd-gitops-helm-installation-and-gitlab-sso-setup.png
date: 2025-11-20 10:00:00 +0800
tags: ['Kubernetes', 'Argo CD', 'GitOps', 'Helm', 'GitLab', 'DevOps']
description: ä»¥å¯¦å‹™æ­¥é©Ÿç¤ºç¯„å¦‚ä½•ç”¨ Helm å®‰è£ Argo CDï¼Œä¸¦çµåˆ GitOps èˆ‡ GitLab SSOï¼Œè®“å¤šå¢é›† K8s éƒ¨ç½²ç®¡ç†è‡ªå‹•åŒ–åˆå¯å›æº¯ã€‚
author: Mark Ku
---

## å‰è¨€

ç•¶ä½ åŒæ™‚ç®¡ç† **10ï½20 å€‹ Kubernetes é›†ç¾¤**æ™‚ï¼Œä½¿ç”¨ kubectl æ‰‹å‹•éƒ¨ç½²ä¸åƒ…è€—æ™‚ï¼Œä¹Ÿå®¹æ˜“å‡ºéŒ¯ã€‚å°±åƒè¦åœ¨ 20 å°æ‰‹æ©Ÿä¸Šå®‰è£åŒä¸€å€‹ Appï¼Œé€ä¸€æ“ä½œé²æ—©æœƒæ¼æ‰æŸä¸€å°ã€‚

**Argo CD** æ­é… **GitOps** å¯ä»¥è§£æ±ºé€™å€‹å•é¡Œï¼Œä½†å­¸ç¿’æ›²ç·šç¢ºå¯¦æ¯” kubectl é™¡å³­ã€‚ä½ éœ€è¦ç†è§£ï¼š

- GitOps çš„å®£å‘Šå¼æ€ç¶­èˆ‡å–®ä¸€çœŸç›¸ä¾†æºæ¦‚å¿µ
- Argo CD çš„ Applicationã€Projectã€Sync é‹ä½œæ©Ÿåˆ¶
- Helmã€OAuthã€Registryã€RBAC ç­‰æ•´åˆæŠ€è¡“

ä¸éï¼Œä¸€æ—¦æŒæ¡é€™äº›çŸ¥è­˜ï¼Œå¤šå¢é›†èˆ‡å¤šç’°å¢ƒçš„ç¶­é‹æ•ˆç‡å°‡å¤§å¹…æå‡ã€‚

æœ¬æ–‡å°‡å¸¶ä½ å®Œæˆä»¥ä¸‹ä¸‰å€‹ç›®æ¨™ï¼š

1. ç†è§£ Argo CD åœ¨ GitOps æ¶æ§‹ä¸­çš„å®šä½
2. ä½¿ç”¨ Helm å®‰è£èˆ‡é…ç½® Argo CD
3. æ•´åˆ GitLab SSO å¯¦ç¾å®‰å…¨çš„ç™»å…¥èˆ‡æ¬Šé™ç®¡ç†

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€éº¼æ˜¯ GitOpsï¼Ÿ

**GitOps** æ˜¯ä¸€ç¨®ä»¥ Git ç‚ºä¸­å¿ƒçš„é‹ç¶­æ–¹æ³•è«–ï¼š

- **Git ä½œç‚ºå”¯ä¸€çœŸç›¸ä¾†æº**ï¼šæ‰€æœ‰ Kubernetes è¨­å®šæª”éƒ½å­˜æ”¾åœ¨ Git å€‰åº«ä¸­
- **è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶**ï¼šç³»çµ±è‡ªå‹•å°‡ Git ä¸­çš„è¨­å®šå¥—ç”¨åˆ°æ‰€æœ‰ç’°å¢ƒ
- **ç‰ˆæœ¬å¯è¿½æº¯**ï¼šæ¯æ¬¡è®Šæ›´éƒ½æœ‰å®Œæ•´çš„ Git æ­·å²è¨˜éŒ„ï¼Œå‡ºéŒ¯æ™‚å¯å¿«é€Ÿå›æ»¾

æ¯”å–»ä¾†èªªï¼ŒGit å°±åƒä¸€æœ¬æ¨™æº–é£Ÿè­œï¼Œè€Œ GitOps å·¥å…·æœƒç¢ºä¿æ‰€æœ‰å»šæˆ¿ï¼ˆé›†ç¾¤ï¼‰éƒ½æŒ‰ç…§åŒä¸€ä»½é£Ÿè­œçƒ¹é£ªã€‚

### Argo CD çš„è§’è‰²
![](how-argocd-work.png)

Argo CD æ˜¯ GitOps çš„å¯¦è¸å·¥å…·ï¼Œè² è²¬ï¼š

- æŒçºŒç›£æ§ Git å€‰åº«çš„è®Šæ›´
- è‡ªå‹•å°‡è®Šæ›´åŒæ­¥åˆ° Kubernetes é›†ç¾¤
- ç¢ºä¿å¯¦éš›ç‹€æ…‹èˆ‡ Git å®šç¾©ä¿æŒä¸€è‡´
- é€é UI å’Œ Git æ­·å²è¨˜éŒ„è¿½è¹¤æ‰€æœ‰è®Šæ›´

å…¶æ ¸å¿ƒåƒ¹å€¼åœ¨æ–¼è®“åŸºç¤è¨­æ–½ç®¡ç†è®Šå¾—**æ›´å®‰å…¨ã€æ›´ä¸€è‡´ã€æ›´æ˜“æ–¼ç¶­è­·**ã€‚

### ç†è§£ GitLab Token é¡å‹

åœ¨ Argo CD èˆ‡ GitLab çš„æ•´åˆä¸­ï¼Œå¸¸ç”¨å…©ç¨® Tokenï¼š

#### Personal Access Token (PAT)
- **ç¶å®šå°è±¡**ï¼šå€‹äººå¸³è™Ÿ
- **æ¬Šé™ç¯„åœ**ï¼šç¹¼æ‰¿ä½¿ç”¨è€…æ¬Šé™
- **é©ç”¨å ´æ™¯**ï¼šå€‹äººå¯¦é©—ã€PoCã€å°å‹å°ˆæ¡ˆ

#### Group Access Token
- **ç¶å®šå°è±¡**ï¼šGitLab Group
- **æ¬Šé™ç¯„åœ**ï¼šåƒ…é™è©² Group çš„ `read_repository`ã€`read_api` ç­‰
- **é©ç”¨å ´æ™¯**ï¼šåœ˜éšŠå”ä½œã€ç”Ÿç”¢ç’°å¢ƒ

**å®‰å…¨æ€§æ¯”è¼ƒ**ï¼š

- PAT å¦‚åŒã€Œå€‹äººè¬ç”¨é‘°åŒ™ã€ï¼Œå¤–æ´©æ™‚å½±éŸ¿ç¯„åœå¤§
- Group Access Token å¦‚åŒã€Œå°ˆæ¡ˆæœå‹™é‘°åŒ™ã€ï¼Œå¯ç¨ç«‹ç®¡ç†èˆ‡è¼ªæ›¿ï¼Œä¸ç¶å®šå€‹äººå¸³è™Ÿ

æœ¬æ–‡æ¡ç”¨ **Group Access Token**ï¼Œè®“ Argo CD è®€å–æ•´å€‹ Group çš„å€‰åº«ï¼Œç¶­è­·æ›´ç°¡æ½”ä¸”ç¬¦åˆåœ˜éšŠä½¿ç”¨æƒ…å¢ƒã€‚
---

## å®‰è£æµç¨‹

### Step 1ï¼šæº–å‚™ Helm ç’°å¢ƒ

åŠ å…¥ Argo CD çš„ Helm repository ä¸¦åŒ¯å‡ºé è¨­è¨­å®šæª”ï¼š

```bash
# æ–°å¢ Helm repository
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

# åŒ¯å‡ºé è¨­ values ä¾›ä¿®æ”¹ä½¿ç”¨
helm show values argo/argo-cd --version 8.3.2 > values.yaml
```

### Step 2ï¼šå»ºç«‹ GitLab OAuth Application

å‰å¾€ GitLab è¨­å®š SSO æ•´åˆï¼š

1. ç™»å…¥ GitLab â†’ é»é¸å³ä¸Šè§’é ­åƒ â†’ `Settings â†’ Applications`
2. é»é¸ **New Application** ä¸¦å¡«å¯«ï¼š
   - **Name**ï¼š`ArgoCD SSO`
   - **Redirect URI**ï¼š`http://<your-node-ip>:32009/api/dex/callback`
   - **Scopes**ï¼šå‹¾é¸ `openid`, `read_user`, `email`
3. å„²å­˜å¾Œå–å¾— **Application ID** å’Œ **Secret**

> âš ï¸ è«‹å¦¥å–„ä¿å­˜ Client ID å’Œ Secretï¼Œä¸è¦æäº¤åˆ° Git å€‰åº«ä¸­ã€‚

### Step 3ï¼šå»ºç«‹ GitLab Group Access Token

ç‚º Argo CD å»ºç«‹å€‰åº«è®€å–æ¬Šé™ï¼š

1. å‰å¾€ GitLab Group â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹æ–° Tokenï¼š
   - **Name**ï¼š`argocd-group-readonly`
   - **Scopes**ï¼šå‹¾é¸ `read_repository` å’Œ `read_api`
   - **Role**ï¼šé¸æ“‡ `Reporter`
3. å„²å­˜å¾Œè¤‡è£½ Tokenï¼ˆåªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼‰

### Step 4ï¼šé…ç½® values.yaml

ç·¨è¼¯ `values.yaml`ï¼Œæ•´åˆæ‰€æœ‰è¨­å®šï¼š

```yaml
configs:
  cm:
    # Argo CD å°å¤– URL
    url: http://<your-node-ip>:32009
    
    # GitLab SSO è¨­å®š
    dex.config: |
      connectors:
        - type: gitlab
          id: gitlab
          name: GitLab
          config:
            baseURL: https://gitlab.example.com
            clientID: <your-gitlab-oauth-client-id>
            clientSecret: <your-gitlab-oauth-client-secret>
            redirectURI: http://<your-node-ip>:32009/api/dex/callback
    
  # GitLab Repository èªè­‰ï¼ˆä½¿ç”¨ Group Access Tokenï¼‰
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
      
  # é å…ˆè¨»å†Šçš„ Repository
  repositories:
    kong-api-gateway:
      url: https://gitlab.example.com/your-group/kong-api-gateway.git
      type: git
    argocd-deployment:
      url: https://gitlab.example.com/your-group/argocd-deployment.git
      type: git

# Server ç¶²è·¯è¨­å®š
server:
  service:
    type: NodePort
    nodePortHttp: 32009
    nodePortHttps: 32010
  
  # å…è¨± HTTPï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼‰
  extraArgs:
    - --insecure
```

> ğŸ’¡ **ç”Ÿç”¢ç’°å¢ƒå»ºè­°**ï¼šä½¿ç”¨ Ingress + TLS å–ä»£ NodePortï¼Œä¸¦ç§»é™¤ `--insecure` åƒæ•¸ã€‚

### Step 5ï¼šåŸ·è¡Œå®‰è£

å¥—ç”¨è¨­å®šæª”ä¸¦å®‰è£ Argo CDï¼š

```bash
# å®‰è£ Argo CD
helm upgrade --install homelab-argo argo/argo-cd \
  --version 8.3.2 \
  -f values.yaml \
  -n argocd --create-namespace

# ç­‰å¾… Pod å°±ç·’
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/name=argocd-server \
  -n argocd --timeout=300s

# å–å¾—åˆå§‹ admin å¯†ç¢¼
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

ç™»å…¥å¾Œè«‹ç«‹å³ä¿®æ”¹ admin å¯†ç¢¼ã€‚

---

## æ¬Šé™ç®¡ç†

### Step 6ï¼šè¨­å®š RBAC èˆ‡ AppProject

å®‰è£å®Œæˆå¾Œï¼Œéœ€è¦é…ç½® AppProject ä¾†ç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„æ¬Šé™ç¯„åœã€‚

å»ºç«‹ `argocd-projects.yaml`ï¼š

```yaml
apiVersion: v1
kind: List
items:
# Default Project - åŸºæœ¬æ¬Šé™
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: default
    namespace: argocd
  spec:
    # å…è¨±æ‰€æœ‰ä¾†æº repo
    sourceRepos:
    - '*'
    
    # å…è¨±éƒ¨ç½²åˆ°æ‰€æœ‰å¢é›†èˆ‡ namespace
    destinations:
    - namespace: '*'
      server: '*'
    
    # å…è¨±æ“ä½œé›†ç¾¤ç´šè³‡æº
    clusterResourceWhitelist:
    - group: '*'
      kind: '*'
    
    # å…è¨±æ“ä½œå‘½åç©ºé–“ç´šè³‡æº
    namespaceResourceWhitelist:
    - group: '*'
      kind: '*'

# è‡ªè¨‚ Project - ä¾éœ€æ±‚èª¿æ•´
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: your-project
    namespace: argocd
  spec:
    description: ä½ çš„å°ˆæ¡ˆæè¿°
    
    sourceRepos:
    - 'https://gitlab.example.com/your-group/*'
    
    destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
    
    # é›†ç¾¤ç´šè³‡æºç™½åå–®
    clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRole
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRoleBinding
    - group: 'apiextensions.k8s.io'
      kind: CustomResourceDefinition
    
    # å‘½åç©ºé–“ç´šè³‡æºç™½åå–®
    namespaceResourceWhitelist:
    - group: ''
      kind: ConfigMap
    - group: ''
      kind: Secret
    - group: ''
      kind: Service
    - group: ''
      kind: ServiceAccount
    - group: 'apps'
      kind: Deployment
    - group: 'apps'
      kind: StatefulSet
    - group: 'batch'
      kind: Job
    - group: 'batch'
      kind: CronJob
    - group: 'networking.k8s.io'
      kind: Ingress

# Argo CD Controller é¡å¤–çš„ RBAC æ¬Šé™ï¼ˆæ”¯æ´ metrics-server ç­‰ï¼‰
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: argocd-application-controller-auth-delegator
    labels:
      app.kubernetes.io/component: application-controller
      app.kubernetes.io/name: argocd-application-controller
      app.kubernetes.io/part-of: argocd
  rules:
  # Auth delegation for metrics-server
  - apiGroups: ["authentication.k8s.io"]
    resources: ["tokenreviews"]
    verbs: ["create"]
  - apiGroups: ["authorization.k8s.io"]
    resources: ["subjectaccessreviews"]
    verbs: ["create"]
  # API Services management
  - apiGroups: ["apiregistration.k8s.io"]
    resources: ["apiservices"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: argocd-application-controller-auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: argocd-application-controller-auth-delegator
  subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: argocd
```

### å¥—ç”¨è¨­å®š

```bash
# å¥—ç”¨ AppProject èˆ‡ RBAC è¨­å®š
kubectl apply -f argocd-projects.yaml -n argocd

# é©—è­‰ Project æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get appprojects -n argocd

# é©—è­‰ RBAC æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get clusterrole | grep argocd
kubectl get clusterrolebinding | grep argocd
```

## GitLab æ¬Šé™èˆ‡ Argo CD çš„é—œä¿‚

åœ¨é€™å€‹å¯¦ä½œè£¡ï¼Œæ¬Šé™å¯ä»¥ç°¡åŒ–æˆä¸‰å€‹å±¤é¢ï¼š

1ï¸âƒ£ **SSO ç™»å…¥ï¼ˆGitLab OAuthï¼‰**ï¼šè®“ä½¿ç”¨è€…ç™»å…¥ Argo CDï¼Œæ±ºå®šã€Œèª°å¯ä»¥é€²ä¾†ã€èƒ½çœ‹åˆ°å“ªäº› Applicationã€ã€‚

2ï¸âƒ£ **å­˜å– Repoï¼ˆPersonal Access Token / Group Access Tokenï¼‰**ï¼š
   - è®“ Argo CD å»è®€ GitLab ä¸Šçš„ **Git repo / Helm chart repo**ã€‚
   - æœ¬æ–‡æ¡ç”¨ **Group Access Token**ï¼Œçµ±ä¸€ç®¡ç†æ•´å€‹ group ä¸‹é¢çš„ repo æ¬Šé™ï¼Œç¶­è­·è¼ƒç°¡å–®ã€‚

3ï¸âƒ£ **ï¼ˆå¯é¸ï¼‰Registry æ¬Šé™**ï¼šå¦‚æœä½ çš„ image æ”¾åœ¨ GitLab Container Registryï¼Œå¯ä»¥å¦å¤–ç”¨ Deploy Token æˆ– Registry å°ˆç”¨å¸³è™Ÿï¼Œ
   ä½†é€™ç¯‡å¯¦ä½œä¸­æ²’æœ‰ä¾è³´ Deploy Tokenï¼Œåªç¤ºç¯„ Git repo è®€å–çš„éƒ¨åˆ†ã€‚

> **ç¸½çµ ï¼šSSO â†’ äººï¼›Group Access Token / PAT â†’ æ‹‰ç¨‹å¼/Chartï¼›Registry æ¬Šé™ â†’ æ‹‰ imageï¼ˆæœ¬ç¯‡æœªä½¿ç”¨ Deploy Tokenï¼‰ã€‚**

æ¥ä¸‹ä¾†çš„ä¸‰å€‹ç« ç¯€ï¼ŒæœƒæŠŠé€™ä¸‰ç¨®æ¬Šé™å°æ‡‰åˆ°å¯¦éš›æ“ä½œï¼š

1. è¨­å®š SSO ç™»å…¥ï¼ˆå°æ‡‰ä¸Šé¢çš„ 1ï¸âƒ£ï¼‰
2. è®“ Argo CD è®€ GitLab Repoï¼ˆå°æ‡‰ 2ï¸âƒ£ï¼‰
3. ï¼ˆå¯é¸ï¼‰æ‹‰ GitLab Registry Imageï¼ˆå°æ‡‰ 3ï¸âƒ£ï¼‰

![](attachments/abaaa408-6162-44e9-996f-8a1db2e70fba.png)

---

## Step 8ï¼šè¨­å®š SSO ç™»å…¥ï¼ˆUI æ“ä½œç‰ˆï¼‰

å¦‚æœä½ åœ¨ Step 5 å®‰è£æ™‚ **æ²’æœ‰** æŠŠ OAuth å¯«é€² values.yamlï¼Œæˆ–æ˜¯æƒ³ç”¨ **åœ–å½¢ä»‹é¢ï¼ˆUIï¼‰** è€Œä¸æ˜¯è¨­å®šæª”ä¾†è¨­å®š GitLab SSOï¼Œå¯ä»¥åƒè€ƒä»¥ä¸‹æ­¥é©Ÿã€‚

> **æé†’**ï¼šå¦‚æœä½ å·²ç¶“åœ¨ Step 5 çš„ values.yaml ä¸­è¨­å®šå¥½ Dex GitLab connectorï¼Œå¯ä»¥è·³éé€™ä¸€ç¯€ã€‚

### GitLab ç«¯ï¼šå»ºç«‹ OAuth Application

1. ç™»å…¥ GitLab â†’ é»å³ä¸Šé ­åƒ â†’ `Settings â†’ Applications`
2. é» **New Application**
3. å¡«å¯«ï¼š
  * Nameï¼šä¾‹å¦‚ `ArgoCD SSO`
  * Redirect URIï¼š`https://<argo-cd-domain>/auth/callback`
  * Scopesï¼šå‹¾é¸ `read_user`
4. é» **Save Application**
5. å–å¾— **Application IDï¼ˆClient IDï¼‰** å’Œ **Secretï¼ˆClient Secretï¼‰**

### Argo CD ç«¯ï¼šå•Ÿç”¨ GitLab SSO

1. é€² Argo CD UI â†’ `Settings â†’ SSO / OAuth`
2. é¸ GitLabï¼Œå¡«å¯«ï¼š
  * Client ID â†’ GitLab OAuth App çš„ ID
  * Client Secret â†’ GitLab OAuth App çš„ Secret
  * Redirect URI â†’ åŒä¸Š
3. å„²å­˜è¨­å®šï¼Œæ­¤æ™‚ä½¿ç”¨è€…å¯é€é GitLab å¸³è™Ÿç™»å…¥ Argo CD UI æˆ– CLI

 ![](attachments/b8ce9bbd-f83d-4715-96e8-ca016638d3ef.png " =1874x907")

 ![](attachments/5a1836e9-f936-4e9c-9762-55b5eb67285e.png " =1548x674")

---

## Step 9ï¼šè®“ Argo CD è®€å– GitLab Repoï¼ˆUI / CLI æ“ä½œç‰ˆï¼‰

é€™ä¸€æ®µç¤ºç¯„å¦‚ä½•åœ¨ **å·²ç¶“å®‰è£å¥½ Argo CD** ä¹‹å¾Œï¼Œç”¨ UI æˆ– CLI çš„æ–¹å¼è¨­å®š Repository å­˜å–æ¬Šé™ã€‚

å¦‚æœä½ åœ¨ Step 4 å·²ç¶“å»ºç«‹å¥½ Group Access Tokenï¼Œä¸¦åœ¨ Step 5 çš„ values.yaml ä¸­è¨­å®šäº† `credentialTemplates`ï¼Œç†è«–ä¸Š Argo CD å·²ç¶“å¯ä»¥è®€å– GitLab Repoã€‚é€™ä¸€ç¯€é©åˆï¼š
- æƒ³ç”¨ UI / CLI è€Œä¸æ˜¯ Helm values ç®¡ç† Repo çš„äºº
- éœ€è¦è‡¨æ™‚æ–°å¢å–®å€‹ Repo çš„æƒ…å¢ƒ

### GitLab ç«¯ï¼šå»ºç«‹ Group Access Tokenï¼ˆå¦‚æœé‚„æ²’åšï¼‰

å¦‚æœä½ åœ¨ Step 4 é‚„æ²’å»ºç«‹ Group Access Tokenï¼Œè«‹åƒè€ƒä»¥ä¸‹æ­¥é©Ÿï¼ˆèˆ‡ Step 4-1 ç›¸åŒï¼‰ï¼š

1. åˆ° GitLab Group é é¢ â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹ä¸€çµ„ **Group Access Token**ï¼š
  * Nameï¼šä¾‹å¦‚ `argocd-group-readonly`
  * Scopesï¼šå‹¾é¸ `read_repository`ï¼ˆå¿…è¦ï¼‰ï¼Œå¿…è¦æ™‚å¯åŠ  `read_api`
3. è«‹**å¦¥å–„ä¿å­˜**é€™çµ„ Token

> å¦‚æœä½ å·²ç¶“åœ¨ Step 4 å»ºç«‹éï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ä¸‹ä¸€å°ç¯€ã€‚

### Argo CD ç«¯ï¼ˆè¨­å®š Repository Credentialsï¼‰

å¦‚æœä½ èµ°ã€Œ**å…ˆè£å¥½ Argo CDï¼Œå†ç”¨ CLI / UI åŠ  Repo**ã€çš„æµç¨‹ï¼Œå¯ä»¥é€™æ¨£åšï¼š

1. å…ˆåœ¨ Kubernetes å»ºä¸€å€‹ Secretï¼ˆå»ºè­°åšæ³•ï¼‰ï¼š

```bash
kubectl create secret generic argocd-gitlab-group-token \
  --from-literal=username=oauth2 \
  --from-literal=password=<your-gitlab-group-access-token> \
  -n argocd
```

2. åœ¨ Argo CD UI ä¸­è¨­å®š Repository Credentialsï¼Œæˆ–ç”¨ CLI æŒ‡å®šï¼ˆä»¥ä¸‹ç‚º CLI ç¯„ä¾‹ï¼Œå¯¦å‹™ä¸Šå»ºè­°æ­é…ä¸Šé¢çš„ Secret æˆ– Helm values ç®¡ç†ï¼‰ï¼š

```bash
argocd repo add https://gitlab.example.com/your-group/your-repo.git \
  --username oauth2 --password <your-gitlab-group-access-token>
```

3. å»ºç«‹ Applicationï¼ŒæŒ‡å®šï¼š
  * `repoURL` â†’ GitLab å°ˆæ¡ˆ URLï¼ˆä¾‹å¦‚ `https://gitlab.example.com/your-group/argocd-deployment.git`ï¼‰
  * `targetRevision` â†’ åˆ†æ”¯æˆ– tagï¼ˆä¾‹å¦‚ `main`ï¼‰
  * `path` â†’ manifests æˆ– Helm chart ç›®éŒ„ï¼ˆä¾‹å¦‚ `overlays/prod` æˆ– `charts/argocd`ï¼‰


---

## Step 10ï¼šï¼ˆå¯é¸ï¼‰æ‹‰ GitLab Registry Image


1. ### å–å¾— Registry ç”¨çš„ Deploy Token

   â†’ å·¦å´é¸å–® â†’ Settings â†’ Repository â†’ å¾€ä¸‹æ‹‰ï¼Œæ‰¾åˆ° Deploy Tokens å€å¡Š

* Scope: `read_registry`
* GitLab æœƒçµ¦ä½ ï¼š
  * Usernameï¼ˆé€šå¸¸æ˜¯ `gitlab+deploy-token-XX`ï¼‰
  * Tokenï¼ˆå¯†ç¢¼ï¼‰


---


2. ### ç”¨ kubectl å»º Secretï¼ˆRegistry ç”¨ï¼‰

```bash
kubectl create secret docker-registry gitlab-registry \
  --docker-server=registry.gitlab.com \
  --docker-username=<Deploy Token Username> \
  --docker-password=<Deploy Token Token> \
  --docker-email=<your-email@example.com> \
  -n <namespace>
```

* `gitlab-registry` â†’ Secret åç¨±
* `registry.gitlab.com` â†’ GitLab Container Registry åœ°å€
* `<namespace>` â†’ ä½ è¦éƒ¨ç½²çš„ namespace

> å»ºå¥½ Secret å¾Œï¼ŒKubernetes Pod å°±å¯ä»¥ç”¨é€™å€‹ Secret æ‹‰ imageã€‚


---

3. Deployment æˆ– Helm æŒ‡å®š imagePullSecrets

```yaml
spec:
  template:
    spec:
      containers:
        - name: my-app
          image: registry.gitlab.com/<group>/<project>/<image>:<tag>
      imagePullSecrets:
        - name: gitlab-registry
```

> é€™æ¨£ Argo CD åŒæ­¥ Application æ™‚ï¼ŒKubernetes å°±èƒ½æ‹‰ GitLab Container Registry çš„ imageã€‚

## Helm åˆå§‹åŒ–ï¼šæŠŠè¨­å®šæ”¾é€² values.yamlï¼ˆé€²éšåƒè€ƒï¼‰

å¦‚æœä½ æƒ³åœ¨é–±è®€å‰é¢æ­¥é©Ÿä¹‹å‰ï¼Œå…ˆçœ‹ä¸€å€‹ **å®Œæ•´çš„ values.yaml ç¯„ä¾‹**ï¼Œæˆ–æ˜¯æƒ³äº†è§£æ›´å¤š Helm è¨­å®šé¸é …ï¼Œå¯ä»¥åƒè€ƒé€™ä¸€ç¯€ã€‚

é€™è£¡æ•´ç†çš„æ˜¯ã€ŒæŠŠæ‰€æœ‰è¨­å®šï¼ˆSSOã€Repoã€Registryï¼‰éƒ½å¯«é€² values.yamlã€çš„å®Œæ•´ç‰ˆæœ¬ï¼Œé©åˆå–œæ­¡ Infrastructure as Codeã€æƒ³æŠŠè¨­å®šå®Œå…¨ç‰ˆæ§çš„é€²éšä½¿ç”¨è€…ã€‚

> **æ³¨æ„**ï¼šé€™ä¸€ç¯€çš„å…§å®¹èˆ‡å‰é¢ Step 5 çš„ values.yaml æœ‰éƒ¨åˆ†é‡ç–Šï¼Œä½ å¯ä»¥é¸æ“‡å…¶ä¸­ä¸€ç¨®æ–¹å¼ä½¿ç”¨ã€‚

### ä¸€ã€è¨­å®š SSO ç™»å…¥ï¼ˆHelm Valuesï¼‰

åœ¨ `values.yaml` è£¡å¯ä»¥åŠ ï¼š

```yaml
configs:
  cm:
    url: https://<argo-cd-domain>
    # OAuth / SSO è¨­å®š
    oidc.config: |
      name: GitLab
      issuer: https://gitlab.com
      clientID: <GitLab OAuth App Client ID>
      clientSecret: <GitLab OAuth App Client Secret>
      requestedScopes: ["openid", "profile", "email", "groups"]
```


### äºŒã€è®€å– GitLab Repositoryï¼ˆHelm Valuesï¼‰

åœ¨ `values.yaml` è£¡å¯ä»¥é å…ˆåŠ  Repo Credentialï¼š

```yaml
configs:
  # ä½¿ç”¨ credentialTemplates å¯ä»¥è®“æ•´å€‹ Group å…±ç”¨åŒä¸€çµ„æ†‘è­‰
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
  
  # æˆ–æ˜¯ç›´æ¥æŒ‡å®šå€‹åˆ¥ Repo
  repositories:
    - url: https://gitlab.com/<group>/<repo>.git
      username: oauth2
      password: <your-gitlab-group-access-token>
```

> **æ¨è–¦**ï¼šä½¿ç”¨ `credentialTemplates` æ­é… Group Access Tokenï¼Œç¶­è­·æ›´æ–¹ä¾¿ã€‚


### ä¸‰ã€æ‹‰ GitLab Container Registry Imageï¼ˆHelm Values / Secretï¼‰

Helm é›–ç„¶ç„¡æ³•ç›´æ¥åœ¨ `values.yaml` è£¡å‰µå»º Kubernetes Secretï¼Œä½†å¯ä»¥ç”¨å…©ç¨®æ–¹å¼ï¼š

1ï¸âƒ£ **ç”¨ `extraSecrets`ï¼ˆArgo CD Helm chart æ”¯æ´ï¼‰**

```yaml
configs:
  secret:
    extraSecrets:
      gitlab-registry:
        type: kubernetes.io/dockerconfigjson
        data:
          .dockerconfigjson: <base64-encoded-docker-config>
```

2ï¸âƒ£ **æˆ–å®‰è£å®Œ Argo CD å¾Œï¼Œç”¨ kubectl å»º Secret**ï¼ˆå‰é¢æ•™çš„æ–¹æ³•ï¼‰ï¼Œç„¶å¾Œåœ¨ `values.yaml` æŒ‡å®š `imagePullSecrets`ï¼š

```yaml
controller:
  extraArgs:
    - --kube-secret-name=gitlab-registry
```

---
### ğŸ” æ•´é«”ç‹€æ³ç¸½è¦½

åœ–è¡¨èªªæ˜ ![](attachments/37293e96-21b9-4734-b8b8-8f657ecd65e6.png)

é€™å¼µåœ–ç‰‡æ˜¯ [Argo CD](https://argo-cd.readthedocs.io/en/stable/) çš„æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç•«é¢ï¼Œç”¨ä¾†ç®¡ç† Kubernetes æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²ç‹€æ…‹ï¼š


* **æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š** `testapp`
* **APP HEALTHï¼ˆå¥åº·ç‹€æ…‹ï¼‰ï¼š** âœ… **Healthy** â†’ ä»£è¡¨æ‡‰ç”¨ç¨‹å¼ç›®å‰çš„æ‰€æœ‰è³‡æºéƒ½é‹ä½œæ­£å¸¸ã€‚
* **SYNC STATUSï¼ˆåŒæ­¥ç‹€æ…‹ï¼‰ï¼š** âœ… **Synced to HEAD (d227ef5)** â†’ è¡¨ç¤º Git å€‰åº«è£¡çš„è¨­å®šæª”å·²æˆåŠŸåŒæ­¥åˆ°å¢é›†ï¼Œæ²’æœ‰åå·®ã€‚
* **LAST SYNCï¼š** âœ… **Sync OK** â†’ æœ€è¿‘ä¸€æ¬¡åŒæ­¥æˆåŠŸï¼Œæ˜¯åœ¨ `18 hours ago`ï¼ˆ18 å°æ™‚å‰ï¼‰ç”± `mark.ku` å®Œæˆçš„ã€‚ â†’ æäº¤å‚™è¨»ç‚º `update config`ã€‚
* **Auto syncï¼š** âŒ **æœªå•Ÿç”¨è‡ªå‹•åŒæ­¥**ï¼ˆAuto sync is not enabledï¼‰


---

### ğŸŒ³ æ‡‰ç”¨ç¨‹å¼è³‡æºæ¶æ§‹åœ–è§£

é€™æ˜¯ä»¥ GitOps æ¨¡å¼éƒ¨ç½²çš„ Kubernetes æ‡‰ç”¨è³‡æºæ¨¹ç‹€åœ–ï¼š


1. **testappï¼ˆæ‡‰ç”¨ç¨‹å¼ï¼‰**
   * **nginx-contentï¼ˆConfigMapï¼‰**
   * **test-appï¼ˆNamespaceï¼‰**
   * **nginx-test-serviceï¼ˆServiceï¼‰**
   * **nginx-testï¼ˆDeploymentï¼‰**
     * **nginx-test-554867cd4bï¼ˆReplicaSetï¼‰**
       * **nginx-test-554867cd4b-65gtpï¼ˆPodï¼‰**
       * **nginx-test-554867cd4b-xgs9xï¼ˆPodï¼‰**

ğŸ“Œ æ‰€æœ‰è³‡æºå³ä¸Šè§’éƒ½æœ‰ âœ…ï¼Œè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€ç‹€æ…‹æ­£å¸¸ã€‚


---

### âœ… æ•´é«”çµè«–

é€™ä»£è¡¨ `testapp` æ‡‰ç”¨åœ¨ Kubernetes ä¸­ï¼š

* çµæ§‹æ¸…æ™°ï¼ŒåŒ…å«éƒ¨ç½²ã€æœå‹™ã€ConfigMap ç­‰
* å·²æ­£ç¢ºåŒæ­¥åˆ° Git å€‰åº«ä¸­çš„å®šç¾©
* æ‰€æœ‰ Pods æ­£å¸¸åŸ·è¡Œä¸­
* æ²’æœ‰éŒ¯èª¤æˆ–ç•°å¸¸ç‹€æ³

---

## è£œå……ï¼šå¸¸ç”¨æŒ‡ä»¤

### å®‰è£ Helmï¼ˆWindows ç¯„ä¾‹ï¼‰

```bash
choco install kubernetes-helm
```

### æŸ¥è©¢ Argo CD Service

```bash
kubectl get svc argocd-server -n argocd
kubectl get svc -A | grep argocd
```

### å°‡ Service æ”¹æˆ NodePortï¼ˆç¯„ä¾‹ï¼‰

```bash
kubectl patch svc argocd-server -n argocd -p '{
  "spec": {
    "type": "NodePort",
    "ports": [
      {
        "port": 80,
        "targetPort": 8080,
        "nodePort": 32009
      }
    ]
  }
}'
```

### ä»¥ Helm å®‰è£ / å‡ç´š Argo CDï¼ˆç°¡åŒ–ç‰ˆï¼‰

```bash
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

helm upgrade --install argocd argo/argo-cd \
  --namespace argocd --create-namespace \
  -f values.yaml
```

### å–å¾—åˆå§‹ admin å¯†ç¢¼ï¼ˆå»ºè­°ç«‹å³ä¿®æ”¹ï¼‰

```bash
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

å–å¾—å¾Œï¼Œè«‹ç«‹åˆ»ç™»å…¥ Argo CD UI / CLI ä¿®æ”¹ admin å¯†ç¢¼ã€‚

### åŒ¯å‡º Helm èˆ‡ Argo CD è¨­å®š

```bash
helm get values argocd -n argocd -o yaml > current-values.yaml
kubectl get appprojects -n argocd -o yaml > argocd-projects.yaml
```

## åƒè€ƒè³‡æ–™

- <https://blog.csdn.net/cr7258/article/details/122028096>
- <https://ithelp.ithome.com.tw/articles/10266761>