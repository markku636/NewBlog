---
featured: true
title: ç”¨ Argo CD å¯¦ä½œ GitOpsï¼šå¾ Helm å®‰è£åˆ° GitLab SSO ä¸€æ¬¡æå®š
slug: argocd-gitops-helm-installation-and-gitlab-sso-setup
category: DevOps
thumbnail: argocd-gitops-helm-installation-and-gitlab-sso-setup.png
date: 2025-11-20 10:00:00 +0800
tags: ['Kubernetes', 'Argo CD', 'GitOps', 'Helm', 'GitLab', 'DevOps']
description: ä»¥å¯¦å‹™æ­¥é©Ÿç¤ºç¯„å¦‚ä½•ç”¨ Helm å®‰è£ Argo CDï¼Œä¸¦çµåˆ GitOps èˆ‡ GitLab SSOï¼Œè®“å¤šå¢é›† K8s éƒ¨ç½²ç®¡ç†è‡ªå‹•åŒ–åˆå¯å›æº¯ã€‚
author: Mark Ku
---

## å‰è¨€

å¹³å¸¸ç”¨ **kubectl** æœ€å¤§çš„éº»ç…©ï¼Œå°±æ˜¯è¦ä¸€ç›´åˆ‡æ›ç’°å¢ƒã€‚å¦‚æœä½ åŒæ™‚ç®¡ç† **10ï½20 å€‹ Kubernetes é›†ç¾¤ï¼ˆClusterï¼‰**ï¼Œæ¯æ¬¡éƒ½è¦æ‰‹å‹•ä¸€å€‹ä¸€å€‹ä¸‹æŒ‡ä»¤ï¼Œæ—©æ™šæœƒå‡ºéŒ¯ã€‚

æƒ³åƒä¸€ä¸‹ï¼Œä½ è¦å¹« **20 å°æ‰‹æ©Ÿ** å®‰è£åŒä¸€å€‹ Appï¼Œå¦‚æœä¸€å°ä¸€å°è‡ªå·±æ“ä½œï¼Œç¸½æœ‰ä¸€å¤©æœƒè£éŒ¯æˆ–æ¼è£ã€‚

å¦ä¸€æ–¹é¢ï¼Œ**Argo CD / GitOps çš„å­¸ç¿’æ›²ç·šæœƒæ¯”å–®ç´”ç”¨ kubectl é«˜å¾ˆå¤š**ï¼Œå› ç‚ºä½ éœ€è¦ï¼š

- ç†è§£ GitOps æ€ç¶­ï¼ˆå®£å‘Šå¼ã€å–®ä¸€çœŸç›¸ä¾†æºï¼‰
- æœƒçœ‹ Argo CD çš„ Application / Project / Sync ç‹€æ…‹
- ç†Ÿæ‚‰ Helmã€OAuthã€Registryã€RBAC ç­‰æ•´åˆ

ä½†ä¸€æ—¦è·¨éé€™å€‹é–€æª»ï¼Œå¤šå¢é›†ã€å¤šç’°å¢ƒçš„ç¶­é‹æ•ˆç‡æœƒå¤§å¹…æå‡ã€‚

é€™ç¯‡æ–‡ç« æœƒå¸¶ä½ å¾é›¶é–‹å§‹ï¼Œå®Œæˆä¸‰ä»¶äº‹ï¼š

- äº†è§£ Argo CD åœ¨ GitOps è£¡æ‰®æ¼”çš„è§’è‰²
- ç”¨ Helm å®‰è£èˆ‡è¨­å®š Argo CD
- é…ç½® GitLab SSOï¼Œå¯¦ä½œæ›´å®‰å…¨çš„ç™»å…¥èˆ‡æ¬Šé™ç®¡ç†

---

## ç‚ºä»€éº¼è¦ç”¨ Argo CD
![](how-argocd-work.png)

Argo CD çš„ä¸Šæ‰‹æˆæœ¬é›–ç„¶æ¯”è¼ƒé«˜ï¼Œä½†å®ƒå¯ä»¥ï¼š

- æŠŠæ‰€æœ‰ç’°å¢ƒçš„è¨­å®šé›†ä¸­åœ¨ Git è£¡ç®¡ç†
- è‡ªå‹•æ¯”å°ã€ŒGit å®šç¾©ã€èˆ‡ã€Œå¯¦éš›å¢é›†ç‹€æ…‹ã€
- ç”¨ UI / Git Commit è¿½è¹¤èª°æ”¹äº†ä»€éº¼ã€ä»€éº¼æ™‚å€™æ”¹

æ›å¥è©±èªªï¼Œä½ ä»˜å‡ºçš„ï¼Œæ˜¯ä¸€é–‹å§‹å¤šèŠ±ä¸€é»æ™‚é–“å­¸ç¿’ï¼›æ›å›ä¾†çš„ï¼Œæ˜¯ä¹‹å¾Œæ—¥å¸¸ç¶­é‹çš„å¤§é‡ç¯€çœã€‚

---

## ä»€éº¼æ˜¯ GitOpsï¼Ÿ

**GitOps** çš„æƒ³æ³•å¾ˆç°¡å–®ï¼š

* **Git = è¨­å®šçš„å”¯ä¸€çœŸç›¸**ï¼šä½ æŠŠæ‰€æœ‰ Kubernetes è¨­å®šæª”æ”¾åœ¨ Git è£¡ï¼Œå°±åƒã€Œé£Ÿè­œã€ä¸€æ¨£ã€‚
* **è‡ªå‹•åŒæ­¥**ï¼šç³»çµ±æœƒè‡ªå‹•æ ¹æ“š Git çš„å…§å®¹ï¼Œå¹«ä½ æŠŠè¨­å®šå¥—ç”¨åˆ°æ‰€æœ‰ç’°å¢ƒã€‚
* **å¯å›æº¯**ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½æœ‰ Git è¨˜éŒ„ï¼Œå°±ç®—å‡ºéŒ¯ï¼Œä¹Ÿèƒ½å¿«é€Ÿå›åˆ°å‰ä¸€ç‰ˆã€‚

å°±åƒä½ å¯«å¥½é£Ÿè­œï¼ˆGitï¼‰ï¼Œå»šæˆ¿ï¼ˆClusterï¼‰å°±æœƒç…§è‘—é£Ÿè­œè‡ªå‹•ç…®èœï¼Œè€Œä¸æ˜¯ä½ è¦ä¸€ç›¤ä¸€ç›¤ç«¯ä¸Šæ¡Œã€‚

---

## Argo CD åœ¨ GitOps è£¡çš„è§’è‰²

Argo CD å°±æ˜¯é‚£å€‹ã€Œå»šå¸«ã€ï¼Œå®ƒå°ˆé–€ï¼š

* ç›¯è‘— Gitï¼Œçœ‹é£Ÿè­œæœ‰æ²’æœ‰æ›´æ–°
* ç™¼ç¾é£Ÿè­œè®Šäº†ï¼Œå°±è‡ªå‹•æ›´æ–°æ‰€æœ‰èœï¼ˆClusterï¼‰
* å¹«ä½ ä¿è­‰æ¯ç›¤èœå‘³é“ä¸€è‡´ï¼Œä¸æœƒæœ‰äººç…®éŒ¯æˆ–åŠ éŒ¯æ–™

æ‰€ä»¥ï¼ŒArgo CD çš„åƒ¹å€¼ä¸åªæ˜¯ã€Œçœéº»ç…©ã€ï¼Œè€Œæ˜¯è®“ä½ çš„ç’°å¢ƒ **æ›´å®‰å…¨ã€æ›´ä¸€è‡´ã€æ›´å¥½ç®¡ç†**ã€‚

## GitLab PAT vs Group Access Token æ˜¯ä»€éº¼ï¼Ÿ

åœ¨ Argo CD + GitLab çš„æ•´åˆè£¡ï¼Œæœ€å¸¸è¦‹çš„å…©ç¨® Token æ˜¯ï¼š

- **Personal Access Tokenï¼ˆPATï¼‰**ï¼š
  - ç¶å®šåœ¨ã€Œå€‹äººå¸³è™Ÿã€ä¸Š
  - æ¬Šé™é€šå¸¸è·Ÿä½ çš„ä½¿ç”¨è€…ç›¸åŒ
  - é©åˆå€‹äººå¯¦é©—ã€PoCï¼Œæˆ–æ˜¯å°‘é‡ Repo çš„æƒ…å¢ƒ

- **Group Access Tokenï¼ˆç¾¤çµ„å­˜å– Tokenï¼‰**ï¼š
  - ç¶å®šåœ¨ã€ŒGitLab Groupã€ä¸Š
  - å¯ä»¥åªçµ¦é€™å€‹ Group ç›¸é—œçš„ `read_repository` / `read_api` ç­‰æ¬Šé™
  - é©åˆåœ˜éšŠ / å°ˆæ¡ˆç¾¤çµ„ï¼Œå…±äº«çµ¦ Argo CD æˆ– CI/CD ä½¿ç”¨

**å·®ç•°é‡é»ï¼š**

- PAT æ¯”è¼ƒåƒæ˜¯ã€ŒæŸå€‹äººçš„è¬ç”¨é‘°åŒ™ã€ï¼Œå¦‚æœå¤–æ´©ï¼Œé¢¨éšªç¶åœ¨å€‹äººå¸³è™Ÿä¸Š
- Group Access Token æ¯”è¼ƒåƒæ˜¯ã€Œé€™å€‹å°ˆæ¡ˆç¾¤çµ„çš„æœå‹™é‘°åŒ™ã€ï¼Œå¯ä»¥ç¨ç«‹ç®¡ç†ã€è¼ªæ›¿ï¼Œ
  è€Œä¸”ä¸æœƒç›´æ¥ç¶åœ¨æŸå€‹å·¥ç¨‹å¸«çš„å€‹äººå¸³è™Ÿ

åœ¨é€™ç¯‡å¯¦ä½œè£¡ï¼Œæˆ‘é¸æ“‡ç”¨ **Group Access Token** è®“ Argo CD è®€å–åŒä¸€å€‹ Group åº•ä¸‹çš„æ‰€æœ‰ Repoï¼Œ
ç¶­è­·ä¸Šæœƒæ¯”åˆ°è™•æ•£è½çš„å€‹äºº PAT æ›´ä¹¾æ·¨ã€ä¹Ÿæ¯”è¼ƒç¬¦åˆåœ˜éšŠä½¿ç”¨æƒ…å¢ƒã€‚


## Step 1ï¼šç”¨ Helm å®‰è£ Argo CD

1ï¸âƒ£ åŠ å…¥ Argo CD çš„ Helm repo ä¸¦æ›´æ–°ï¼š

```bash
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update
```

2ï¸âƒ£ï¼ˆå¯é¸ï¼‰æŸ¥è©¢ç›®å‰å®‰è£ç‹€æ…‹ï¼š

```bash
helm list -n argocd
```

3ï¸âƒ£ï¼ˆå¯é¸ï¼‰åŒ¯å‡ºæŒ‡å®šç‰ˆæœ¬çš„é è¨­ valuesï¼ˆæ–¹ä¾¿ä¿®æ”¹ï¼‰ï¼š

```bash
helm show values argo/argo-cd --version 8.3.2 > values.yaml
```

æ¥ä¸‹ä¾†æœƒä¸€æ­¥æ­¥è£œä¸Šç¶²è·¯è¨­å®šã€GitLab OAuthã€Group Access Token ç­‰è¨­å®šåˆ°é€™å€‹ `values.yaml` ä¸­ã€‚

---

## Step 2ï¼šè¨­å®š Argo CD å°å¤–ç¶²è·¯ï¼ˆNodePort ç¯„ä¾‹ï¼‰

åœ¨å¯¦é©—æˆ–å…§ç¶²ç’°å¢ƒï¼Œä½ å¯ä»¥ç”¨ **NodePort** ç›´æ¥æŠŠ Argo CD æš´éœ²å‡ºä¾†ï¼Œä¾‹å¦‚ï¼š

```bash
type: NodePort
nodePortHttp: 32009
nodePortHttps: 32010
argocdUrl: http://<your-node-ip>:32009
```

> å»ºè­°æ­£å¼ç’°å¢ƒé‚„æ˜¯æ­é… Ingress æˆ– Nginx + HTTPSï¼ŒNodePort åªé©åˆ PoC æˆ– Labã€‚

---

## Step 3ï¼šåœ¨ GitLab å»ºç«‹ OAuthï¼ˆSSO ç”¨ï¼‰

é€™ä¸€æ­¥åªå°ˆæ³¨åœ¨ **GitLab OAuth / SSO**ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç”¨ GitLab å¸³è™Ÿç™»å…¥ Argo CDã€‚

è¨­å®š GitLab ä½œç‚º Argo CD çš„ OAuth Providerï¼Œå¤§è‡´æœƒéœ€è¦ï¼š

- GitLab URLï¼Œä¾‹å¦‚ï¼š`https://gitlab.example.com`
- Application IDï¼ˆClient IDï¼‰
- Secretï¼ˆClient Secretï¼‰
- Callback URLï¼š`https://<argo-cd-domain>/auth/callback`

> è«‹åœ¨ GitLab ä»‹é¢ä¸­å»ºç«‹ OAuth Applicationï¼Œä¸è¦æŠŠå¯¦éš›çš„ ID / Secret å¯«åœ¨ç¨‹å¼ç¢¼æˆ– Git ç‰ˆæœ¬åº«è£¡ã€‚

## Step 4ï¼šè¨­å®šå­˜å–åŠæ¬Šé™ï¼ˆå®‰å…¨åšæ³•ï¼‰

é€™ä¸€æ­¥çš„ç›®æ¨™æ˜¯ï¼š**è®“ Argo CD èƒ½å®‰å…¨åœ°è®€å– GitLab ä¸ŠåŒä¸€å€‹ Group åº•ä¸‹çš„æ‰€æœ‰ Repo**ï¼Œè€Œä¸”ä¸è¦ç¶åœ¨å€‹äººå¸³è™Ÿä¸Šã€‚

åšæ³•æ˜¯ä½¿ç”¨ **GitLab Group Access Token**ï¼Œæµç¨‹å¯ä»¥æ‹†æˆå…©æ®µï¼š

1. åœ¨ GitLab Group å»ºç«‹ Group Access Token
2. åœ¨ Kubernetes / Argo CD é€™é‚Šä½¿ç”¨é€™å€‹ Token

### 4-1 GitLabï¼šå»ºç«‹ Group Access Tokenï¼ˆä¸€æ¬¡è¨­å®šï¼Œå¤šå°ˆæ¡ˆå…±ç”¨ï¼‰

åˆ° **GitLab Group** é é¢æ“ä½œï¼š

1. é€²å…¥ä½ çš„ Group â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹ä¸€çµ„ Tokenï¼Œä¾‹å¦‚ï¼š

   - **Name**ï¼š`argocd-group-readonly`
   - **Scopes**ï¼šå‹¾é¸ `read_repository`ï¼ˆå¿…è¦ï¼‰ï¼Œå¿…è¦æ™‚å¯åŠ  `read_api`

3. å»ºç«‹å¾Œï¼Œè«‹**è¤‡è£½ä¸¦å¦¥å–„ä¿å­˜**é€™çµ„ Tokenï¼ˆä¹‹å¾Œå°±çœ‹ä¸åˆ°æ˜ç¢¼ï¼‰ã€‚

> å»ºè­°ä¸è¦ç”¨å€‹äºº PAT ä¾†è®“ Argo CD è®€ Repoï¼Œæ”¹ç”¨ Group Access Token æœƒæ¯”è¼ƒå¥½ç®¡ç†ã€ä¹Ÿè¼ƒä¸ç¶å€‹äººå¸³è™Ÿã€‚

### 4-2 Kubernetes / Argo CDï¼šä½¿ç”¨ Group Access Tokenï¼ˆç¯„ä¾‹ï¼‰

åœ¨é€™å€‹æ¶æ§‹ä¸­ï¼Œæˆ‘ **æ²’æœ‰ä½¿ç”¨ Deploy Token**ï¼Œè€Œæ˜¯çµ±ä¸€ç”¨ **GitLab Group Access Token** è®“ Argo CD è®€å–æ‰€æœ‰ç›¸é—œ repoï¼ˆä¾‹å¦‚ manifest repoã€Helm chart repoï¼‰ã€‚

ä¸‹é¢æ˜¯ä¸€å€‹å…·é«”ç¯„ä¾‹ï¼Œç¤ºç¯„å¦‚ä½•æŠŠé€™å€‹ Token å®‰å…¨åœ°äº¤çµ¦ Argo CD ä½¿ç”¨ï¼š

```bash
# 1. åœ¨ Kubernetes å»ºç«‹ Secretï¼Œå­˜æ”¾ GitLab Group Access Token
kubectl create secret generic argocd-gitlab-group-token \
  --from-literal=username=oauth2 \
  --from-literal=password=<your-gitlab-group-access-token> \
  -n argocd

# 2.ï¼ˆå¯é¸ï¼‰ä½ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ CLI æ–°å¢ Repoï¼Œç¤ºæ„å¦‚ä¸‹ï¼š
#    å¯¦å‹™ä¸Šå»ºè­°æ­é…ä¸Šé¢çš„ Secret æˆ– Helm values ç®¡ç†ï¼Œè€Œä¸è¦æŠŠ Token å¯«æ­»åœ¨æŒ‡ä»¤ç´€éŒ„è£¡ã€‚
argocd repo add https://gitlab.example.com/your-group/your-repo.git \
  --username oauth2 --password <your-gitlab-group-access-token>
```

å¦‚æœä½ åå¥½ **å®Œå…¨ç”¨ Helm ç®¡ç†**ï¼Œå¯ä»¥åœ¨å¾Œé¢ `Step 5` çš„ `values.yaml` ä¸­åˆ©ç”¨ `credentialTemplates`ï¼Œçµ±ä¸€å®šç¾©ä¸€çµ„çµ¦æ•´å€‹ Group ä½¿ç”¨çš„æ†‘è­‰ï¼š

```yaml
configs:
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
```

ä¹‹å¾Œåªè¦æ˜¯ `https://gitlab.example.com/your-group/*` ä¹‹ä¸‹çš„ repoï¼Œéƒ½å¯ä»¥å…±ç”¨é€™çµ„ Credentialï¼Œä¸éœ€è¦æ¯å€‹ Repo å„è‡ªè¨­å®šä¸€æ¬¡ã€‚

> å®‰å…¨æ€§æé†’ï¼šè«‹å‹¿å°‡å¯¦éš›çš„ GitLab Token æˆ–å¯†ç¢¼å¯«å…¥ Git ç‰ˆæœ¬åº«ï¼Œå»ºè­°æ”¹ç”¨ K8s Secretã€ç’°å¢ƒè®Šæ•¸æˆ– CI/CD è®Šæ•¸ä¾†ç®¡ç†æ•æ„Ÿè³‡è¨Šã€‚

---

## Step 5ï¼šåœ¨ Helm values.yaml ä¸­è¨­å®š GitLab æ•´åˆ

ä»¥ä¸‹æ˜¯å¯¦éš›çš„ `values.yaml` è¨­å®šç¯„ä¾‹ï¼Œæ•´åˆ GitLab OAuthã€Group Access Token èˆ‡ Repository è¨­å®šï¼š

```yaml
configs:
  cm:
    url: http://<your-node-ip>:32009
    # å¦‚æœä½¿ç”¨ HTTPï¼Œéœ€è¦è¨­å®š insecure
    # æ­£å¼ç’°å¢ƒå»ºè­°æ”¹ç”¨ HTTPS + Ingress
    
    # GitLab OAuth / SSO è¨­å®š
    dex.config: |
      connectors:
        - type: gitlab
          id: gitlab
          name: GitLab
          config:
            baseURL: https://gitlab.example.com
            clientID: <your-gitlab-oauth-client-id>
            clientSecret: <your-gitlab-oauth-client-secret>
            redirectURI: http://<your-node-ip>:32009/api/dex/callback
    
  # Repository Credentials - ä½¿ç”¨ GitLab Group Access Token
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
      
  # è¨­å®šè¦åŒæ­¥çš„ Repository
  repositories:
    kong-api-gateway:
      url: https://gitlab.example.com/your-group/kong-api-gateway.git
      type: git
    argocd-deployment:
      url: https://gitlab.example.com/your-group/argocd-deployment.git
      type: git

# Server è¨­å®š
server:
  # NodePort è¨­å®šï¼ˆå¯¦é©—ç’°å¢ƒï¼‰
  service:
    type: NodePort
    nodePortHttp: 32009
    nodePortHttps: 32010
  
  # å…è¨± HTTPï¼ˆåƒ…é™é–‹ç™¼/æ¸¬è©¦ç’°å¢ƒï¼‰
  extraArgs:
    - --insecure
```

> **èªªæ˜**ï¼šä¸Šé¢çš„ OAuth è¨­å®šä½¿ç”¨ Argo CD å…§å»ºçš„ Dex åš SSOã€‚å¦‚æœä½ ä¸æƒ³åœ¨å®‰è£æ™‚å°±è¨­å®š OAuthï¼Œä¹Ÿå¯ä»¥è·³éé€™éƒ¨åˆ†ï¼Œä¹‹å¾Œé€é Step 8 çš„ UI æ–¹å¼è£œè¨­å®šã€‚

### Step 6ï¼šå®Œæ•´å®‰è£æŒ‡ä»¤ï¼ˆå¥—ç”¨ values.yamlï¼‰

å‡è¨­ä½ å·²ç¶“å®Œæˆ Step 1 çš„ Helm repo è¨­å®šï¼Œä¸¦åœ¨ Step 2ï½5 ç·¨è¼¯å¥½ `values.yaml`ï¼Œç¾åœ¨å¯ä»¥åŸ·è¡Œå®‰è£ï¼š

```bash
# å®‰è£ Argo CD
helm upgrade --install homelab-argo argo/argo-cd \
  --version 8.3.2 \
  -f values.yaml \
  -n argocd --create-namespace

# ç­‰å¾…æ‰€æœ‰ Pod å•Ÿå‹•ï¼ˆå¯é¸ï¼Œä½†å»ºè­°ï¼‰
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s
```

> **æé†’**ï¼šå¦‚æœä½ é‚„æ²’åš Step 1ï¼Œè«‹å…ˆåŸ·è¡Œ `helm repo add argo https://argoproj.github.io/argo-helm` å’Œ `helm repo update`ã€‚

---

## Step 7ï¼šè¨­å®š RBAC èˆ‡ AppProject

å®‰è£å®Œæˆå¾Œï¼Œéœ€è¦å»ºç«‹ AppProject ä¾†ç®¡ç†æ‡‰ç”¨æ¬Šé™ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ RBAC èˆ‡ Project è¨­å®šï¼š

### å»ºç«‹ AppProject è¨­å®šæª”

å»ºç«‹ `argocd-projects.yaml`ï¼š

```yaml
apiVersion: v1
kind: List
items:
# Default Project - åŸºæœ¬æ¬Šé™
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: default
    namespace: argocd
  spec:
    # å…è¨±æ‰€æœ‰ä¾†æº repo
    sourceRepos:
    - '*'
    
    # å…è¨±éƒ¨ç½²åˆ°æ‰€æœ‰å¢é›†èˆ‡ namespace
    destinations:
    - namespace: '*'
      server: '*'
    
    # å…è¨±æ“ä½œé›†ç¾¤ç´šè³‡æº
    clusterResourceWhitelist:
    - group: '*'
      kind: '*'
    
    # å…è¨±æ“ä½œå‘½åç©ºé–“ç´šè³‡æº
    namespaceResourceWhitelist:
    - group: '*'
      kind: '*'

# è‡ªè¨‚ Project - ä¾éœ€æ±‚èª¿æ•´
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: your-project
    namespace: argocd
  spec:
    description: ä½ çš„å°ˆæ¡ˆæè¿°
    
    sourceRepos:
    - 'https://gitlab.example.com/your-group/*'
    
    destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
    
    # é›†ç¾¤ç´šè³‡æºç™½åå–®
    clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRole
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRoleBinding
    - group: 'apiextensions.k8s.io'
      kind: CustomResourceDefinition
    
    # å‘½åç©ºé–“ç´šè³‡æºç™½åå–®
    namespaceResourceWhitelist:
    - group: ''
      kind: ConfigMap
    - group: ''
      kind: Secret
    - group: ''
      kind: Service
    - group: ''
      kind: ServiceAccount
    - group: 'apps'
      kind: Deployment
    - group: 'apps'
      kind: StatefulSet
    - group: 'batch'
      kind: Job
    - group: 'batch'
      kind: CronJob
    - group: 'networking.k8s.io'
      kind: Ingress

# Argo CD Controller é¡å¤–çš„ RBAC æ¬Šé™ï¼ˆæ”¯æ´ metrics-server ç­‰ï¼‰
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: argocd-application-controller-auth-delegator
    labels:
      app.kubernetes.io/component: application-controller
      app.kubernetes.io/name: argocd-application-controller
      app.kubernetes.io/part-of: argocd
  rules:
  # Auth delegation for metrics-server
  - apiGroups: ["authentication.k8s.io"]
    resources: ["tokenreviews"]
    verbs: ["create"]
  - apiGroups: ["authorization.k8s.io"]
    resources: ["subjectaccessreviews"]
    verbs: ["create"]
  # API Services management
  - apiGroups: ["apiregistration.k8s.io"]
    resources: ["apiservices"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: argocd-application-controller-auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: argocd-application-controller-auth-delegator
  subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: argocd
```

### å¥—ç”¨è¨­å®š

```bash
# å¥—ç”¨ AppProject èˆ‡ RBAC è¨­å®š
kubectl apply -f argocd-projects.yaml -n argocd

# é©—è­‰ Project æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get appprojects -n argocd

# é©—è­‰ RBAC æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get clusterrole | grep argocd
kubectl get clusterrolebinding | grep argocd
```

## GitLab æ¬Šé™èˆ‡ Argo CD çš„é—œä¿‚

åœ¨é€™å€‹å¯¦ä½œè£¡ï¼Œæ¬Šé™å¯ä»¥ç°¡åŒ–æˆä¸‰å€‹å±¤é¢ï¼š

1ï¸âƒ£ **SSO ç™»å…¥ï¼ˆGitLab OAuthï¼‰**ï¼šè®“ä½¿ç”¨è€…ç™»å…¥ Argo CDï¼Œæ±ºå®šã€Œèª°å¯ä»¥é€²ä¾†ã€èƒ½çœ‹åˆ°å“ªäº› Applicationã€ã€‚

2ï¸âƒ£ **å­˜å– Repoï¼ˆPersonal Access Token / Group Access Tokenï¼‰**ï¼š
   - è®“ Argo CD å»è®€ GitLab ä¸Šçš„ **Git repo / Helm chart repo**ã€‚
   - æœ¬æ–‡æ¡ç”¨ **Group Access Token**ï¼Œçµ±ä¸€ç®¡ç†æ•´å€‹ group ä¸‹é¢çš„ repo æ¬Šé™ï¼Œç¶­è­·è¼ƒç°¡å–®ã€‚

3ï¸âƒ£ **ï¼ˆå¯é¸ï¼‰Registry æ¬Šé™**ï¼šå¦‚æœä½ çš„ image æ”¾åœ¨ GitLab Container Registryï¼Œå¯ä»¥å¦å¤–ç”¨ Deploy Token æˆ– Registry å°ˆç”¨å¸³è™Ÿï¼Œ
   ä½†é€™ç¯‡å¯¦ä½œä¸­æ²’æœ‰ä¾è³´ Deploy Tokenï¼Œåªç¤ºç¯„ Git repo è®€å–çš„éƒ¨åˆ†ã€‚

> **ç¸½çµ ï¼šSSO â†’ äººï¼›Group Access Token / PAT â†’ æ‹‰ç¨‹å¼/Chartï¼›Registry æ¬Šé™ â†’ æ‹‰ imageï¼ˆæœ¬ç¯‡æœªä½¿ç”¨ Deploy Tokenï¼‰ã€‚**

æ¥ä¸‹ä¾†çš„ä¸‰å€‹ç« ç¯€ï¼ŒæœƒæŠŠé€™ä¸‰ç¨®æ¬Šé™å°æ‡‰åˆ°å¯¦éš›æ“ä½œï¼š

1. è¨­å®š SSO ç™»å…¥ï¼ˆå°æ‡‰ä¸Šé¢çš„ 1ï¸âƒ£ï¼‰
2. è®“ Argo CD è®€ GitLab Repoï¼ˆå°æ‡‰ 2ï¸âƒ£ï¼‰
3. ï¼ˆå¯é¸ï¼‰æ‹‰ GitLab Registry Imageï¼ˆå°æ‡‰ 3ï¸âƒ£ï¼‰

![](attachments/abaaa408-6162-44e9-996f-8a1db2e70fba.png)

---

## Step 8ï¼šè¨­å®š SSO ç™»å…¥ï¼ˆUI æ“ä½œç‰ˆï¼‰

å¦‚æœä½ åœ¨ Step 5 å®‰è£æ™‚ **æ²’æœ‰** æŠŠ OAuth å¯«é€² values.yamlï¼Œæˆ–æ˜¯æƒ³ç”¨ **åœ–å½¢ä»‹é¢ï¼ˆUIï¼‰** è€Œä¸æ˜¯è¨­å®šæª”ä¾†è¨­å®š GitLab SSOï¼Œå¯ä»¥åƒè€ƒä»¥ä¸‹æ­¥é©Ÿã€‚

> **æé†’**ï¼šå¦‚æœä½ å·²ç¶“åœ¨ Step 5 çš„ values.yaml ä¸­è¨­å®šå¥½ Dex GitLab connectorï¼Œå¯ä»¥è·³éé€™ä¸€ç¯€ã€‚

### GitLab ç«¯ï¼šå»ºç«‹ OAuth Application

1. ç™»å…¥ GitLab â†’ é»å³ä¸Šé ­åƒ â†’ `Settings â†’ Applications`
2. é» **New Application**
3. å¡«å¯«ï¼š
  * Nameï¼šä¾‹å¦‚ `ArgoCD SSO`
  * Redirect URIï¼š`https://<argo-cd-domain>/auth/callback`
  * Scopesï¼šå‹¾é¸ `read_user`
4. é» **Save Application**
5. å–å¾— **Application IDï¼ˆClient IDï¼‰** å’Œ **Secretï¼ˆClient Secretï¼‰**

### Argo CD ç«¯ï¼šå•Ÿç”¨ GitLab SSO

1. é€² Argo CD UI â†’ `Settings â†’ SSO / OAuth`
2. é¸ GitLabï¼Œå¡«å¯«ï¼š
  * Client ID â†’ GitLab OAuth App çš„ ID
  * Client Secret â†’ GitLab OAuth App çš„ Secret
  * Redirect URI â†’ åŒä¸Š
3. å„²å­˜è¨­å®šï¼Œæ­¤æ™‚ä½¿ç”¨è€…å¯é€é GitLab å¸³è™Ÿç™»å…¥ Argo CD UI æˆ– CLI

 ![](attachments/b8ce9bbd-f83d-4715-96e8-ca016638d3ef.png " =1874x907")

 ![](attachments/5a1836e9-f936-4e9c-9762-55b5eb67285e.png " =1548x674")

---

## Step 9ï¼šè®“ Argo CD è®€å– GitLab Repoï¼ˆUI / CLI æ“ä½œç‰ˆï¼‰

é€™ä¸€æ®µç¤ºç¯„å¦‚ä½•åœ¨ **å·²ç¶“å®‰è£å¥½ Argo CD** ä¹‹å¾Œï¼Œç”¨ UI æˆ– CLI çš„æ–¹å¼è¨­å®š Repository å­˜å–æ¬Šé™ã€‚

å¦‚æœä½ åœ¨ Step 4 å·²ç¶“å»ºç«‹å¥½ Group Access Tokenï¼Œä¸¦åœ¨ Step 5 çš„ values.yaml ä¸­è¨­å®šäº† `credentialTemplates`ï¼Œç†è«–ä¸Š Argo CD å·²ç¶“å¯ä»¥è®€å– GitLab Repoã€‚é€™ä¸€ç¯€é©åˆï¼š
- æƒ³ç”¨ UI / CLI è€Œä¸æ˜¯ Helm values ç®¡ç† Repo çš„äºº
- éœ€è¦è‡¨æ™‚æ–°å¢å–®å€‹ Repo çš„æƒ…å¢ƒ

### GitLab ç«¯ï¼šå»ºç«‹ Group Access Tokenï¼ˆå¦‚æœé‚„æ²’åšï¼‰

å¦‚æœä½ åœ¨ Step 4 é‚„æ²’å»ºç«‹ Group Access Tokenï¼Œè«‹åƒè€ƒä»¥ä¸‹æ­¥é©Ÿï¼ˆèˆ‡ Step 4-1 ç›¸åŒï¼‰ï¼š

1. åˆ° GitLab Group é é¢ â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹ä¸€çµ„ **Group Access Token**ï¼š
  * Nameï¼šä¾‹å¦‚ `argocd-group-readonly`
  * Scopesï¼šå‹¾é¸ `read_repository`ï¼ˆå¿…è¦ï¼‰ï¼Œå¿…è¦æ™‚å¯åŠ  `read_api`
3. è«‹**å¦¥å–„ä¿å­˜**é€™çµ„ Token

> å¦‚æœä½ å·²ç¶“åœ¨ Step 4 å»ºç«‹éï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ä¸‹ä¸€å°ç¯€ã€‚

### Argo CD ç«¯ï¼ˆè¨­å®š Repository Credentialsï¼‰

å¦‚æœä½ èµ°ã€Œ**å…ˆè£å¥½ Argo CDï¼Œå†ç”¨ CLI / UI åŠ  Repo**ã€çš„æµç¨‹ï¼Œå¯ä»¥é€™æ¨£åšï¼š

1. å…ˆåœ¨ Kubernetes å»ºä¸€å€‹ Secretï¼ˆå»ºè­°åšæ³•ï¼‰ï¼š

```bash
kubectl create secret generic argocd-gitlab-group-token \
  --from-literal=username=oauth2 \
  --from-literal=password=<your-gitlab-group-access-token> \
  -n argocd
```

2. åœ¨ Argo CD UI ä¸­è¨­å®š Repository Credentialsï¼Œæˆ–ç”¨ CLI æŒ‡å®šï¼ˆä»¥ä¸‹ç‚º CLI ç¯„ä¾‹ï¼Œå¯¦å‹™ä¸Šå»ºè­°æ­é…ä¸Šé¢çš„ Secret æˆ– Helm values ç®¡ç†ï¼‰ï¼š

```bash
argocd repo add https://gitlab.example.com/your-group/your-repo.git \
  --username oauth2 --password <your-gitlab-group-access-token>
```

3. å»ºç«‹ Applicationï¼ŒæŒ‡å®šï¼š
  * `repoURL` â†’ GitLab å°ˆæ¡ˆ URLï¼ˆä¾‹å¦‚ `https://gitlab.example.com/your-group/argocd-deployment.git`ï¼‰
  * `targetRevision` â†’ åˆ†æ”¯æˆ– tagï¼ˆä¾‹å¦‚ `main`ï¼‰
  * `path` â†’ manifests æˆ– Helm chart ç›®éŒ„ï¼ˆä¾‹å¦‚ `overlays/prod` æˆ– `charts/argocd`ï¼‰


---

## Step 10ï¼šï¼ˆå¯é¸ï¼‰æ‹‰ GitLab Registry Image


1. ### å–å¾— Registry ç”¨çš„ Deploy Token

   â†’ å·¦å´é¸å–® â†’ Settings â†’ Repository â†’ å¾€ä¸‹æ‹‰ï¼Œæ‰¾åˆ° Deploy Tokens å€å¡Š

* Scope: `read_registry`
* GitLab æœƒçµ¦ä½ ï¼š
  * Usernameï¼ˆé€šå¸¸æ˜¯ `gitlab+deploy-token-XX`ï¼‰
  * Tokenï¼ˆå¯†ç¢¼ï¼‰


---


2. ### ç”¨ kubectl å»º Secretï¼ˆRegistry ç”¨ï¼‰

```bash
kubectl create secret docker-registry gitlab-registry \
  --docker-server=registry.gitlab.com \
  --docker-username=<Deploy Token Username> \
  --docker-password=<Deploy Token Token> \
  --docker-email=<your-email@example.com> \
  -n <namespace>
```

* `gitlab-registry` â†’ Secret åç¨±
* `registry.gitlab.com` â†’ GitLab Container Registry åœ°å€
* `<namespace>` â†’ ä½ è¦éƒ¨ç½²çš„ namespace

> å»ºå¥½ Secret å¾Œï¼ŒKubernetes Pod å°±å¯ä»¥ç”¨é€™å€‹ Secret æ‹‰ imageã€‚


---

3\. Deployment æˆ– Helm æŒ‡å®š imagePullSecrets

```yaml
spec:
  template:
    spec:
      containers:
        - name: my-app
          image: registry.gitlab.com/<group>/<project>/<image>:<tag>
      imagePullSecrets:
        - name: gitlab-registry
```

> é€™æ¨£ Argo CD åŒæ­¥ Application æ™‚ï¼ŒKubernetes å°±èƒ½æ‹‰ GitLab Container Registry çš„ imageã€‚

## Helm åˆå§‹åŒ–ï¼šæŠŠè¨­å®šæ”¾é€² values.yamlï¼ˆé€²éšåƒè€ƒï¼‰

å¦‚æœä½ æƒ³åœ¨é–±è®€å‰é¢æ­¥é©Ÿä¹‹å‰ï¼Œå…ˆçœ‹ä¸€å€‹ **å®Œæ•´çš„ values.yaml ç¯„ä¾‹**ï¼Œæˆ–æ˜¯æƒ³äº†è§£æ›´å¤š Helm è¨­å®šé¸é …ï¼Œå¯ä»¥åƒè€ƒé€™ä¸€ç¯€ã€‚

é€™è£¡æ•´ç†çš„æ˜¯ã€ŒæŠŠæ‰€æœ‰è¨­å®šï¼ˆSSOã€Repoã€Registryï¼‰éƒ½å¯«é€² values.yamlã€çš„å®Œæ•´ç‰ˆæœ¬ï¼Œé©åˆå–œæ­¡ Infrastructure as Codeã€æƒ³æŠŠè¨­å®šå®Œå…¨ç‰ˆæ§çš„é€²éšä½¿ç”¨è€…ã€‚

> **æ³¨æ„**ï¼šé€™ä¸€ç¯€çš„å…§å®¹èˆ‡å‰é¢ Step 5 çš„ values.yaml æœ‰éƒ¨åˆ†é‡ç–Šï¼Œä½ å¯ä»¥é¸æ“‡å…¶ä¸­ä¸€ç¨®æ–¹å¼ä½¿ç”¨ã€‚

### ä¸€ã€è¨­å®š SSO ç™»å…¥ï¼ˆHelm Valuesï¼‰

åœ¨ `values.yaml` è£¡å¯ä»¥åŠ ï¼š

```yaml
configs:
  cm:
    url: https://<argo-cd-domain>
    # OAuth / SSO è¨­å®š
    oidc.config: |
      name: GitLab
      issuer: https://gitlab.com
      clientID: <GitLab OAuth App Client ID>
      clientSecret: <GitLab OAuth App Client Secret>
      requestedScopes: ["openid", "profile", "email", "groups"]
```


### äºŒã€è®€å– GitLab Repositoryï¼ˆHelm Valuesï¼‰

åœ¨ `values.yaml` è£¡å¯ä»¥é å…ˆåŠ  Repo Credentialï¼š

```yaml
configs:
  # ä½¿ç”¨ credentialTemplates å¯ä»¥è®“æ•´å€‹ Group å…±ç”¨åŒä¸€çµ„æ†‘è­‰
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
  
  # æˆ–æ˜¯ç›´æ¥æŒ‡å®šå€‹åˆ¥ Repo
  repositories:
    - url: https://gitlab.com/<group>/<repo>.git
      username: oauth2
      password: <your-gitlab-group-access-token>
```

> **æ¨è–¦**ï¼šä½¿ç”¨ `credentialTemplates` æ­é… Group Access Tokenï¼Œç¶­è­·æ›´æ–¹ä¾¿ã€‚


### ä¸‰ã€æ‹‰ GitLab Container Registry Imageï¼ˆHelm Values / Secretï¼‰

Helm é›–ç„¶ç„¡æ³•ç›´æ¥åœ¨ `values.yaml` è£¡å‰µå»º Kubernetes Secretï¼Œä½†å¯ä»¥ç”¨å…©ç¨®æ–¹å¼ï¼š

1ï¸âƒ£ **ç”¨ `extraSecrets`ï¼ˆArgo CD Helm chart æ”¯æ´ï¼‰**

```yaml
configs:
  secret:
    extraSecrets:
      gitlab-registry:
        type: kubernetes.io/dockerconfigjson
        data:
          .dockerconfigjson: <base64-encoded-docker-config>
```

2ï¸âƒ£ **æˆ–å®‰è£å®Œ Argo CD å¾Œï¼Œç”¨ kubectl å»º Secret**ï¼ˆå‰é¢æ•™çš„æ–¹æ³•ï¼‰ï¼Œç„¶å¾Œåœ¨ `values.yaml` æŒ‡å®š `imagePullSecrets`ï¼š

```yaml
controller:
  extraArgs:
    - --kube-secret-name=gitlab-registry
```


---

## è£œå……ï¼šå¸¸ç”¨æŒ‡ä»¤èˆ‡ç¶­é‹å°æŠ„

### å®‰è£ Helmï¼ˆWindows ç¯„ä¾‹ï¼‰

```bash
choco install kubernetes-helm
```

### æŸ¥è©¢ Argo CD Service

```bash
kubectl get svc argocd-server -n argocd
kubectl get svc -A | grep argocd
```

### å°‡ Service æ”¹æˆ NodePortï¼ˆç¯„ä¾‹ï¼‰

```bash
kubectl patch svc argocd-server -n argocd -p '{
  "spec": {
    "type": "NodePort",
    "ports": [
      {
        "port": 80,
        "targetPort": 8080,
        "nodePort": 32009
      }
    ]
  }
}'
```

### ä»¥ Helm å®‰è£ / å‡ç´š Argo CDï¼ˆç°¡åŒ–ç‰ˆï¼‰

```bash
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

helm upgrade --install argocd argo/argo-cd \
  --namespace argocd --create-namespace \
  -f values.yaml
```

### å–å¾—åˆå§‹ admin å¯†ç¢¼ï¼ˆå»ºè­°ç«‹å³ä¿®æ”¹ï¼‰

```bash
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

å–å¾—å¾Œï¼Œè«‹ç«‹åˆ»ç™»å…¥ Argo CD UI / CLI ä¿®æ”¹ admin å¯†ç¢¼ã€‚

### åŒ¯å‡º Helm èˆ‡ Argo CD è¨­å®š

```bash
helm get values argocd -n argocd -o yaml > current-values.yaml
kubectl get appprojects -n argocd -o yaml > argocd-projects.yaml
```


\
åœ–è¡¨èªªæ˜ ![](attachments/37293e96-21b9-4734-b8b8-8f657ecd65e6.png)


\
é€™å¼µåœ–ç‰‡æ˜¯ [Argo CD](https://argo-cd.readthedocs.io/en/stable/) çš„æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç•«é¢ï¼Œç”¨ä¾†ç®¡ç† Kubernetes æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²ç‹€æ…‹ï¼š


---

### ğŸ” æ•´é«”ç‹€æ³ç¸½è¦½

* **æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š** `testapp`
* **APP HEALTHï¼ˆå¥åº·ç‹€æ…‹ï¼‰ï¼š** âœ… **Healthy** â†’ ä»£è¡¨æ‡‰ç”¨ç¨‹å¼ç›®å‰çš„æ‰€æœ‰è³‡æºéƒ½é‹ä½œæ­£å¸¸ã€‚
* **SYNC STATUSï¼ˆåŒæ­¥ç‹€æ…‹ï¼‰ï¼š** âœ… **Synced to HEAD (d227ef5)** â†’ è¡¨ç¤º Git å€‰åº«è£¡çš„è¨­å®šæª”å·²æˆåŠŸåŒæ­¥åˆ°å¢é›†ï¼Œæ²’æœ‰åå·®ã€‚
* **LAST SYNCï¼š** âœ… **Sync OK** â†’ æœ€è¿‘ä¸€æ¬¡åŒæ­¥æˆåŠŸï¼Œæ˜¯åœ¨ `18 hours ago`ï¼ˆ18 å°æ™‚å‰ï¼‰ç”± `mark.ku` å®Œæˆçš„ã€‚ â†’ æäº¤å‚™è¨»ç‚º `update config`ã€‚
* **Auto syncï¼š** âŒ **æœªå•Ÿç”¨è‡ªå‹•åŒæ­¥**ï¼ˆAuto sync is not enabledï¼‰


---

### ğŸŒ³ æ‡‰ç”¨ç¨‹å¼è³‡æºæ¶æ§‹åœ–è§£

é€™æ˜¯ä»¥ GitOps æ¨¡å¼éƒ¨ç½²çš„ Kubernetes æ‡‰ç”¨è³‡æºæ¨¹ç‹€åœ–ï¼š


1. **testappï¼ˆæ‡‰ç”¨ç¨‹å¼ï¼‰**
   * **nginx-contentï¼ˆConfigMapï¼‰**
   * **test-appï¼ˆNamespaceï¼‰**
   * **nginx-test-serviceï¼ˆServiceï¼‰**
   * **nginx-testï¼ˆDeploymentï¼‰**
     * **nginx-test-554867cd4bï¼ˆReplicaSetï¼‰**
       * **nginx-test-554867cd4b-65gtpï¼ˆPodï¼‰**
       * **nginx-test-554867cd4b-xgs9xï¼ˆPodï¼‰**

ğŸ“Œ æ‰€æœ‰è³‡æºå³ä¸Šè§’éƒ½æœ‰ âœ…ï¼Œè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€ç‹€æ…‹æ­£å¸¸ã€‚


---

### âœ… æ•´é«”çµè«–

é€™ä»£è¡¨ `testapp` æ‡‰ç”¨åœ¨ Kubernetes ä¸­ï¼š

* çµæ§‹æ¸…æ™°ï¼ŒåŒ…å«éƒ¨ç½²ã€æœå‹™ã€ConfigMap ç­‰
* å·²æ­£ç¢ºåŒæ­¥åˆ° Git å€‰åº«ä¸­çš„å®šç¾©
* æ‰€æœ‰ Pods æ­£å¸¸åŸ·è¡Œä¸­
* æ²’æœ‰éŒ¯èª¤æˆ–ç•°å¸¸ç‹€æ³

## åƒè€ƒè³‡æ–™

- <https://blog.csdn.net/cr7258/article/details/122028096>
- <https://ithelp.ithome.com.tw/articles/10266761>