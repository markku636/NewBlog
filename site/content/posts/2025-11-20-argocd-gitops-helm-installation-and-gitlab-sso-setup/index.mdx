---
featured: true
title: ç”¨ Argo CD å¯¦ä½œ GitOpsï¼šå¾ Helm å®‰è£åˆ° GitLab SSO ä¸€æ¬¡æå®š
slug: argocd-gitops-helm-installation-and-gitlab-sso-setup
category: DevOps
thumbnail: argocd-gitops-helm-installation-and-gitlab-sso-setup.png
date: 2025-11-20 10:00:00 +0800
tags: ['Kubernetes', 'Argo CD', 'GitOps', 'Helm', 'GitLab', 'DevOps']
description: ä»¥å¯¦å‹™æ­¥é©Ÿç¤ºç¯„å¦‚ä½•ç”¨ Helm å®‰è£ Argo CDï¼Œä¸¦çµåˆ GitOps èˆ‡ GitLab SSOï¼Œè®“å¤šå¢é›† K8s éƒ¨ç½²ç®¡ç†è‡ªå‹•åŒ–åˆå¯å›æº¯ã€‚
author: Mark Ku
---

## å‰è¨€

å¦‚æœä½ ç¾åœ¨æ‰‹ä¸Šæœ‰ **10ï½20 å€‹ Kubernetes é›†ç¾¤** è¦é¡§ï¼Œé‚„åœ¨é‚£é‚Šæ¯ä¸€å€‹ç”¨ kubectl æ‰‹å‹•åˆ‡ contextã€apply YAMLï¼Œå…¶å¯¦æ»¿æŠ˜é¨°çš„ã€‚

æœ‰é»åƒä½ æœ‰ 20 æ”¯æ‰‹æ©Ÿï¼Œè¦è£åŒä¸€å€‹ Appï¼Œçµæœä½ ä¸€æ”¯ä¸€æ”¯æ‰“é–‹å•†åº—æœå°‹ã€ä¸‹è¼‰ã€ç™»å…¥â€”â€”æŸä¸€å¤©ä¸€å®šæœƒæ¼è£ã€è£éŒ¯ï¼Œæˆ–æ˜¯å°‘æ”¹ä¸€å€‹è¨­å®šã€‚

**Argo CD** æ­é… **GitOps** å°±æ˜¯åœ¨è§£æ±ºé€™ç¨®ã€Œäººæ‰‹æ“ä½œä¸€å®šæœƒå‡ºåŒ…ã€çš„å ´æ™¯ã€‚ç¼ºé»æ˜¯ï¼Œå®ƒçš„å­¸ç¿’æ›²ç·šçš„ç¢ºæ¯”å–®ç´”ç”¨ kubectl é™¡ä¸€é»ï¼Œä½ è¦å…ˆç†è§£ï¼š

- GitOps åœ¨è¬›çš„ã€Œå®£å‘Šå¼ã€è·Ÿã€Œå”¯ä¸€çœŸç›¸ä¾†æºã€åˆ°åº•æ˜¯ä»€éº¼
- Argo CD è£¡çš„ Applicationã€Projectã€Sync é€™äº›æ±è¥¿åœ¨ç©ä»€éº¼
- Helmã€OAuthã€Registryã€RBAC é€™äº›å…ƒä»¶è¦æ€éº¼ä¸²åœ¨ä¸€èµ·

ä½†ä¸€æ—¦é€™äº›æ‹¼åœ–æ‹¼èµ·ä¾†ï¼Œå¤šå¢é›†ã€å¤šç’°å¢ƒçš„æ—¥å¸¸ç¶­é‹çœŸçš„æœƒè¼•é¬†éå¸¸å¤šã€‚

é€™ç¯‡æ–‡ç« æœƒå¸¶ä½ ä¸€æ­¥ä¸€æ­¥åšå®Œä¸‰ä»¶äº‹ï¼š

1. å…ˆææ¸…æ¥š Argo CD åœ¨æ•´å€‹ GitOps æ¶æ§‹è£¡æ˜¯èª°ã€åœ¨å¹¹å˜›  
2. ç”¨ Helm æŠŠ Argo CD å®‰è£èµ·ä¾†ã€å¿…è¦è¨­å®šè£œå¥½  
3. æŠŠ GitLab SSO ä¸²é€²ä¾†ï¼Œè®“ç™»å…¥ã€æ¬Šé™éƒ½ç”¨åŒä¸€å¥—å¸³è™Ÿç³»çµ±ç®¡  

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€éº¼æ˜¯ GitOpsï¼Ÿ

å…ˆæŠŠ GitOps è¬›ç™½è©±ä¸€é»ï¼Œå®ƒå…¶å¯¦å°±æ˜¯ä¸€å¥è©±ï¼š

> **ã€ŒæŠŠåŸºç¤è¨­æ–½ç•¶ç¨‹å¼ç¢¼ç®¡ï¼Œç„¶å¾Œä¸€åˆ‡ä»¥ Git ç‚ºæº–ã€‚ã€**

ç´°æ‹†æœƒé•·é€™æ¨£ï¼š

- **Git æ˜¯å”¯ä¸€çœŸç›¸ä¾†æº**ï¼šæ‰€æœ‰ Kubernetes è¨­å®šæª”ï¼ˆYAMLã€Helm valuesâ€¦ï¼‰éƒ½ä¸Ÿåœ¨ Git è£¡ï¼ŒGit å°±æ˜¯ã€Œç’°å¢ƒè©²é•·ä»€éº¼æ¨£å­ã€çš„æ¨™æº–ç­”æ¡ˆã€‚
- **è‡ªå‹•åŒæ­¥**ï¼šä¸æ˜¯ä½ è‡ªå·±å»ä¸‹ `kubectl apply`ï¼Œè€Œæ˜¯ç³»çµ±è‡ªå‹•å»çœ‹ Gitï¼Œå¹«ä½ æŠŠé›†ç¾¤èª¿æ•´æˆé‚£å€‹ç‹€æ…‹ã€‚
- **ç‰ˆæœ¬å¯å›æº¯**ï¼šèª°æ”¹äº†ä»€éº¼ã€ä»€éº¼æ™‚å€™æ”¹ï¼Œåªè¦æœ‰ commit è¨˜éŒ„å°±æŸ¥å¾—åˆ°ï¼ŒçœŸçš„ç‚¸æ‰äº†ä¹Ÿå¯ä»¥ç›´æ¥å›æ»¾ã€‚

å¯ä»¥æŠŠå®ƒæƒ³æˆï¼š  
ä»¥å‰å¤§å®¶åœ¨å»šæˆ¿è£¡éƒ½æ†‘æ„Ÿè¦ºç…®ï¼Œæ¯å€‹äººå¿ƒä¸­éƒ½æœ‰è‡ªå·±çš„ç‰ˆæœ¬ï¼Œä½†æœ‰äº†ArgoCDï¼Œå¤§å®¶ä¾æ“šé£Ÿè­œåšèœ

## å®‰è£ç›¸é—œç’°å¢ƒ

### Step 1ï¼šæº–å‚™ Helm ç’°å¢ƒ

åœ¨é–‹å§‹å®‰è£ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆæŠŠ Helm çš„ã€Œè»Ÿé«”ä¾†æºã€è¨­å®šå¥½ã€‚å°±åƒä½ è¦è£ App å‰è¦å…ˆç¢ºèªæ‡‰ç”¨å•†åº—èƒ½é€£ä¸Šä¸€æ¨£ï¼Œé€™è£¡è¦è®“ Helm çŸ¥é“å»å“ªè£¡æŠ“ Argo CD çš„å®‰è£åŒ…ï¼Œç„¶å¾ŒæŠŠé è¨­è¨­å®šæª”åŒ¯å‡ºä¾†æ–¹ä¾¿æˆ‘å€‘å¾ŒçºŒä¿®æ”¹ã€‚

åŠ å…¥ Argo CD çš„ Helm repository ä¸¦åŒ¯å‡ºé è¨­è¨­å®šæª”ï¼š

```bash
# æ–°å¢ Helm repository
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

# åŒ¯å‡ºé è¨­ values ä¾›ä¿®æ”¹ä½¿ç”¨
helm show values argo/argo-cd --version 8.3.2 > values.yaml
```

### Step 2ï¼šå»ºç«‹ GitLab OAuth Application

é€™ä¸€æ­¥æ˜¯è¦è®“ Argo CD è·Ÿ GitLab ä¹‹é–“å»ºç«‹ã€Œä¿¡ä»»é—œä¿‚ã€ã€‚ä½ å¯ä»¥æƒ³åƒæˆæ˜¯åœ¨ GitLab è£¡å¹« Argo CD è¾¦ä¸€å¼µã€Œé€šè¡Œè­‰ã€ï¼Œä»¥å¾Œä½¿ç”¨è€…å°±å¯ä»¥ç”¨ GitLab å¸³è™Ÿç›´æ¥ç™»å…¥ Argo CDï¼Œä¸ç”¨å†è¨˜ä¸€çµ„æ–°çš„å¸³è™Ÿå¯†ç¢¼ã€‚

å‰å¾€ GitLab è¨­å®š SSO æ•´åˆï¼š

1. ç™»å…¥ GitLab â†’ é»é¸å³ä¸Šè§’é ­åƒ â†’ `Settings â†’ Applications`
2. é»é¸ **New Application** ä¸¦å¡«å¯«ï¼š
   - **Name**ï¼š`ArgoCD SSO`
   - **Redirect URI**ï¼š`http://<your-node-ip>:32009/api/dex/callback`
   - **Scopes**ï¼šå‹¾é¸ `openid`, `read_user`, `email`
3. å„²å­˜å¾Œå–å¾— **Application ID** å’Œ **Secret**

> âš ï¸ è«‹å¦¥å–„ä¿å­˜ Client ID å’Œ Secretï¼Œä¸è¦æäº¤åˆ° Git å€‰åº«ä¸­ã€‚

![](attachments/5a1836e9-f936-4e9c-9762-55b5eb67285e.png " =1548x674")

**å…©ç¨®è¨­å®šæ–¹å¼ï¼š**

**æ–¹æ¡ˆ Aï¼šé€é values.yaml è¨­å®šï¼ˆå»ºè­°ï¼‰**
- åœ¨å¾ŒçºŒ Step 4 ä¸­ï¼Œå°‡ Client ID å’Œ Secret å¯«å…¥ `values.yaml` çš„ `dex.config` å€å¡Š
- å®‰è£æ™‚ä¸€æ¬¡åˆ°ä½ï¼Œé©åˆè‡ªå‹•åŒ–éƒ¨ç½²

**æ–¹æ¡ˆ Bï¼šé€é UI è¨­å®š**
- å®‰è£å¾Œç™»å…¥ Argo CD UI â†’ `Settings â†’ SSO / OAuth`
- é¸æ“‡ GitLab ä¸¦å¡«å¯« Client IDã€Secretã€Redirect URI
- é©åˆäº‹å¾Œè£œå¼·æˆ–èª¿æ•´è¨­å®š

![](attachments/b8ce9bbd-f83d-4715-96e8-ca016638d3ef.png " =1874x907")

### Step 3ï¼šå»ºç«‹ GitLab Group Access Token

ç‚ºäº†è®“ Argo CD èƒ½å¤ è‡ªå‹•æ‹‰å– GitLab ä¸Šçš„ç¨‹å¼ç¢¼å’Œ Helm Chartï¼Œæˆ‘å€‘éœ€è¦çµ¦å®ƒä¸€æŠŠã€Œè®€å–æ¬Šé™é‘°åŒ™ã€ã€‚Group Access Token å°±æ˜¯é€™æŠŠé‘°åŒ™ï¼Œå®ƒå¯ä»¥è®“ Argo CD å­˜å–æ•´å€‹ GitLab Group åº•ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆï¼Œè€Œä¸ç”¨æ¯å€‹ repo éƒ½å–®ç¨è¨­å®šä¸€æ¬¡ã€‚

1. å‰å¾€ GitLab Group â†’ `Settings â†’ Access Tokens`
2. å»ºç«‹æ–° Tokenï¼š
   - **Name**ï¼š`argocd-group-readonly`
   - **Scopes**ï¼šå‹¾é¸ `read_repository` å’Œ `read_api`
   - **Role**ï¼šé¸æ“‡ `Reporter`
3. å„²å­˜å¾Œè¤‡è£½ Tokenï¼ˆåªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼‰

### Step 4ï¼šé…ç½® values.yaml

ç¾åœ¨è¦æŠŠå‰é¢æº–å‚™å¥½çš„ã€Œé€šè¡Œè­‰ã€ï¼ˆOAuthï¼‰å’Œã€Œè®€å–é‘°åŒ™ã€ï¼ˆGroup Tokenï¼‰å¯«é€² Argo CD çš„è¨­å®šæª”è£¡ã€‚é€™å€‹ `values.yaml` å°±åƒæ˜¯ Argo CD çš„ã€Œèº«åˆ†è­‰+é€šè¨ŠéŒ„ã€ï¼Œå‘Šè¨´å®ƒè‡ªå·±çš„å°å¤–ç¶²å€æ˜¯ä»€éº¼ã€è¦æ€éº¼è·Ÿ GitLab æºé€šã€å¯ä»¥å­˜å–å“ªäº› repoã€‚

ç·¨è¼¯ `values.yaml`ï¼Œæ•´åˆæ‰€æœ‰è¨­å®šï¼š

```yaml
configs:
  cm:
    # Argo CD å°å¤– URL
    url: http://<your-node-ip>:32009
    
    # GitLab SSO è¨­å®š
    dex.config: |
      connectors:
        - type: gitlab
          id: gitlab
          name: GitLab
          config:
            baseURL: https://gitlab.example.com
            clientID: <your-gitlab-oauth-client-id>
            clientSecret: <your-gitlab-oauth-client-secret>
            redirectURI: http://<your-node-ip>:32009/api/dex/callback
    
  # GitLab Repository èªè­‰ï¼ˆä½¿ç”¨ Group Access Tokenï¼‰
  credentialTemplates:
    gitlab-group-token:
      url: https://gitlab.example.com
      username: oauth2
      password: <your-gitlab-group-access-token>
      
  # é å…ˆè¨»å†Šçš„ Repository
  repositories:
    kong-api-gateway:
      url: https://gitlab.example.com/your-group/kong-api-gateway.git
      type: git
    argocd-deployment:
      url: https://gitlab.example.com/your-group/argocd-deployment.git
      type: git

# Server ç¶²è·¯è¨­å®š
server:
  service:
    type: NodePort
    nodePortHttp: 32009
    nodePortHttps: 32010
  
  # å…è¨± HTTPï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼‰
  extraArgs:
    - --insecure
```

> ğŸ’¡ **ç”Ÿç”¢ç’°å¢ƒå»ºè­°**ï¼šä½¿ç”¨ Ingress + TLS å–ä»£ NodePortï¼Œä¸¦ç§»é™¤ `--insecure` åƒæ•¸ã€‚

### Step 5ï¼šåŸ·è¡Œå®‰è£

è¨­å®šæª”æº–å‚™å¥½äº†ï¼Œç¾åœ¨å¯ä»¥æ­£å¼æŠŠ Argo CD ã€Œè“‹ã€åˆ° Kubernetes é›†ç¾¤ä¸Šã€‚é€™å€‹éç¨‹æœƒå»ºç«‹æ‰€æœ‰å¿…è¦çš„ Podã€Serviceã€ConfigMap ç­‰ç­‰ï¼Œç„¶å¾Œç­‰å®ƒå€‘å…¨éƒ¨å•Ÿå‹•å®Œæˆã€‚å°±åƒè“‹æˆ¿å­ä¸€æ¨£ï¼Œææ–™å‚™é½Šäº†å°±é–‹å§‹æ–½å·¥ï¼Œæœ€å¾Œé©—æ”¶ç¢ºèªèƒ½ä½äººã€‚

å¥—ç”¨è¨­å®šæª”ä¸¦å®‰è£ Argo CDï¼š

```bash
# å®‰è£ Argo CD
helm upgrade --install homelab-argo argo/argo-cd \
  --version 8.3.2 \
  -f values.yaml \
  -n argocd --create-namespace

# ç­‰å¾… Pod å°±ç·’
kubectl wait --for=condition=ready pod \
  -l app.kubernetes.io/name=argocd-server \
  -n argocd --timeout=300s

# å–å¾—åˆå§‹ admin å¯†ç¢¼
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d
```

ç™»å…¥å¾Œè«‹ç«‹å³ä¿®æ”¹ admin å¯†ç¢¼ã€‚

---

## æ¬Šé™ç®¡ç†

### Step 6ï¼šè¨­å®š RBAC èˆ‡ AppProject

Argo CD å®‰è£å¥½äº†ï¼Œä½†ç¾åœ¨å®ƒé‚„ä¸çŸ¥é“ã€Œå¯ä»¥ç®¡å“ªäº›è³‡æºã€ã€ã€Œå¯ä»¥éƒ¨ç½²åˆ°å“ªäº›åœ°æ–¹ã€ã€‚AppProject å°±åƒæ˜¯ä¸€ä»½ã€Œæˆæ¬Šæ¸…å–®ã€ï¼Œæ˜ç¢ºå®šç¾© Argo CD å¯ä»¥ç¢°å“ªäº› Kubernetes è³‡æºã€å¯ä»¥é€£åˆ°å“ªäº›é›†ç¾¤ã€å¯ä»¥å­˜å–å“ªäº› Git repoã€‚æ²’æœ‰é€™å€‹æˆæ¬Šï¼ŒArgo CD å°±æœƒå› ç‚ºæ¬Šé™ä¸è¶³è€Œç„¡æ³•æ­£å¸¸å·¥ä½œã€‚

å®‰è£å®Œæˆå¾Œï¼Œéœ€è¦é…ç½® AppProject ä¾†ç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„æ¬Šé™ç¯„åœã€‚

å»ºç«‹ `argocd-projects.yaml`ï¼š

```yaml
apiVersion: v1
kind: List
items:
# Default Project - åŸºæœ¬æ¬Šé™
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: default
    namespace: argocd
  spec:
    # å…è¨±æ‰€æœ‰ä¾†æº repo
    sourceRepos:
    - '*'
    
    # å…è¨±éƒ¨ç½²åˆ°æ‰€æœ‰å¢é›†èˆ‡ namespace
    destinations:
    - namespace: '*'
      server: '*'
    
    # å…è¨±æ“ä½œé›†ç¾¤ç´šè³‡æº
    clusterResourceWhitelist:
    - group: '*'
      kind: '*'
    
    # å…è¨±æ“ä½œå‘½åç©ºé–“ç´šè³‡æº
    namespaceResourceWhitelist:
    - group: '*'
      kind: '*'

# è‡ªè¨‚ Project - ä¾éœ€æ±‚èª¿æ•´
- apiVersion: argoproj.io/v1alpha1
  kind: AppProject
  metadata:
    name: your-project
    namespace: argocd
  spec:
    description: ä½ çš„å°ˆæ¡ˆæè¿°
    
    sourceRepos:
    - 'https://gitlab.example.com/your-group/*'
    
    destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
    
    # é›†ç¾¤ç´šè³‡æºç™½åå–®
    clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRole
    - group: 'rbac.authorization.k8s.io'
      kind: ClusterRoleBinding
    - group: 'apiextensions.k8s.io'
      kind: CustomResourceDefinition
    
    # å‘½åç©ºé–“ç´šè³‡æºç™½åå–®
    namespaceResourceWhitelist:
    - group: ''
      kind: ConfigMap
    - group: ''
      kind: Secret
    - group: ''
      kind: Service
    - group: ''
      kind: ServiceAccount
    - group: 'apps'
      kind: Deployment
    - group: 'apps'
      kind: StatefulSet
    - group: 'batch'
      kind: Job
    - group: 'batch'
      kind: CronJob
    - group: 'networking.k8s.io'
      kind: Ingress

# Argo CD Controller é¡å¤–çš„ RBAC æ¬Šé™ï¼ˆæ”¯æ´ metrics-server ç­‰ï¼‰
- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: argocd-application-controller-auth-delegator
    labels:
      app.kubernetes.io/component: application-controller
      app.kubernetes.io/name: argocd-application-controller
      app.kubernetes.io/part-of: argocd
  rules:
  # Auth delegation for metrics-server
  - apiGroups: ["authentication.k8s.io"]
    resources: ["tokenreviews"]
    verbs: ["create"]
  - apiGroups: ["authorization.k8s.io"]
    resources: ["subjectaccessreviews"]
    verbs: ["create"]
  # API Services management
  - apiGroups: ["apiregistration.k8s.io"]
    resources: ["apiservices"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: argocd-application-controller-auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: argocd-application-controller-auth-delegator
  subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: argocd
```

### å¥—ç”¨è¨­å®š

```bash
# å¥—ç”¨ AppProject èˆ‡ RBAC è¨­å®š
kubectl apply -f argocd-projects.yaml -n argocd

# é©—è­‰ Project æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get appprojects -n argocd

# é©—è­‰ RBAC æ˜¯å¦å»ºç«‹æˆåŠŸ
kubectl get clusterrole | grep argocd
kubectl get clusterrolebinding | grep argocd
```

### ç†è§£æ¬Šé™æ¶æ§‹

Argo CD èˆ‡ GitLab æ•´åˆæ¶‰åŠä¸‰å±¤æ¬Šé™ç®¡ç†ï¼š

**1. SSO ç™»å…¥ï¼ˆGitLab OAuthï¼‰**
- æ§åˆ¶ä½¿ç”¨è€…èº«åˆ†é©—è­‰èˆ‡æˆæ¬Š
- æ±ºå®šèª°å¯ä»¥å­˜å– Argo CD UI åŠå¯è¦‹çš„ Application ç¯„åœ
- æœ¬æ–‡å·²åœ¨ Step 4 çš„ `values.yaml` ä¸­å®Œæˆè¨­å®š

**2. Repository å­˜å–ï¼ˆGroup Access Tokenï¼‰**
- è®“ Argo CD è®€å– GitLab å€‰åº«çš„ç¨‹å¼ç¢¼èˆ‡ Helm Chart
- æ¡ç”¨ Group Access Token çµ±ä¸€ç®¡ç†æ•´å€‹ Group çš„æ¬Šé™
- å·²åœ¨ Step 4 çš„ `credentialTemplates` ä¸­å®Œæˆè¨­å®š

**3. Container Registryï¼ˆé¸ç”¨ï¼‰**
- è‹¥ä½¿ç”¨ GitLab Container Registry æ‹‰å–æ˜ åƒæª”ï¼Œéœ€é¡å¤–è¨­å®š
- å¯ä½¿ç”¨ Deploy Token å»ºç«‹ `imagePullSecrets`

> ğŸ’¡ **ç°¡å–®è¨˜æ†¶**ï¼šSSO ç®¡ã€Œäººã€ï¼ŒGroup Token ç®¡ã€Œç¨‹å¼ç¢¼ã€ï¼ŒRegistry Token ç®¡ã€Œæ˜ åƒæª”ã€ã€‚

![](attachments/b8ce9bbd-f83d-4715-96e8-ca016638d3ef.png " =1874x907")

---

## å¯¦æˆ°ç¯„ä¾‹

### æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç¸½è¦½

åœ–è¡¨èªªæ˜ ![](attachments/37293e96-21b9-4734-b8b8-8f657ecd65e6.png)

é€™å¼µåœ–ç‰‡æ˜¯ [Argo CD](https://argo-cd.readthedocs.io/en/stable/) çš„æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ç•«é¢ï¼Œç”¨ä¾†ç®¡ç† Kubernetes æ‡‰ç”¨ç¨‹å¼çš„éƒ¨ç½²ç‹€æ…‹ï¼š


* **æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š** `testapp`
* **APP HEALTHï¼ˆå¥åº·ç‹€æ…‹ï¼‰ï¼š** âœ… **Healthy** â†’ ä»£è¡¨æ‡‰ç”¨ç¨‹å¼ç›®å‰çš„æ‰€æœ‰è³‡æºéƒ½é‹ä½œæ­£å¸¸ã€‚
* **SYNC STATUSï¼ˆåŒæ­¥ç‹€æ…‹ï¼‰ï¼š** âœ… **Synced to HEAD (d227ef5)** â†’ è¡¨ç¤º Git å€‰åº«è£¡çš„è¨­å®šæª”å·²æˆåŠŸåŒæ­¥åˆ°å¢é›†ï¼Œæ²’æœ‰åå·®ã€‚
* **LAST SYNCï¼š** âœ… **Sync OK** â†’ æœ€è¿‘ä¸€æ¬¡åŒæ­¥æˆåŠŸï¼Œæ˜¯åœ¨ `18 hours ago`ï¼ˆ18 å°æ™‚å‰ï¼‰ç”± `mark.ku` å®Œæˆçš„ã€‚ â†’ æäº¤å‚™è¨»ç‚º `update config`ã€‚
* **Auto syncï¼š** âŒ **æœªå•Ÿç”¨è‡ªå‹•åŒæ­¥**ï¼ˆAuto sync is not enabledï¼‰


---

### ğŸŒ³ æ‡‰ç”¨ç¨‹å¼è³‡æºæ¶æ§‹åœ–è§£

é€™æ˜¯ä»¥ GitOps æ¨¡å¼éƒ¨ç½²çš„ Kubernetes æ‡‰ç”¨è³‡æºæ¨¹ç‹€åœ–ï¼š


1. **testappï¼ˆæ‡‰ç”¨ç¨‹å¼ï¼‰**
   * **nginx-contentï¼ˆConfigMapï¼‰**
   * **test-appï¼ˆNamespaceï¼‰**
   * **nginx-test-serviceï¼ˆServiceï¼‰**
   * **nginx-testï¼ˆDeploymentï¼‰**
     * **nginx-test-554867cd4bï¼ˆReplicaSetï¼‰**
       * **nginx-test-554867cd4b-65gtpï¼ˆPodï¼‰**
       * **nginx-test-554867cd4b-xgs9xï¼ˆPodï¼‰**

ğŸ“Œ æ‰€æœ‰è³‡æºå³ä¸Šè§’éƒ½æœ‰ âœ…ï¼Œè¡¨ç¤ºéƒ¨ç½²æˆåŠŸã€ç‹€æ…‹æ­£å¸¸ã€‚

---

## å¸¸ç”¨æŒ‡ä»¤åƒè€ƒ

### Helm ç›¸é—œ

```bash
# å®‰è£ Helmï¼ˆWindowsï¼‰
choco install kubernetes-helm

# å®‰è£/å‡ç´š Argo CD
helm upgrade --install argocd argo/argo-cd \
  --namespace argocd --create-namespace \
  -f values.yaml

# åŒ¯å‡ºç•¶å‰è¨­å®š
helm get values argocd -n argocd -o yaml > current-values.yaml
```

### Kubernetes ç›¸é—œ

```bash
# æŸ¥è©¢ Argo CD Service
kubectl get svc argocd-server -n argocd

# å°‡ Service æ”¹ç‚º NodePort
kubectl patch svc argocd-server -n argocd -p '{
  "spec": {
    "type": "NodePort",
    "ports": [
      {
        "port": 80,
        "targetPort": 8080,
        "nodePort": 32009
      }
    ]
  }
}'

# å–å¾—åˆå§‹ admin å¯†ç¢¼
kubectl -n argocd get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d

# åŒ¯å‡º AppProject è¨­å®š
kubectl get appprojects -n argocd -o yaml > argocd-projects.yaml
```

> âš ï¸ å–å¾— admin å¯†ç¢¼å¾Œï¼Œè«‹ç«‹å³ç™»å…¥ä¸¦ä¿®æ”¹å¯†ç¢¼ä»¥ç¢ºä¿å®‰å…¨ã€‚

---

## ç¸½çµ

é€éæœ¬æ–‡ï¼Œæ‚¨å·²ç¶“å®Œæˆï¼š

1. âœ… ç†è§£ GitOps èˆ‡ Argo CD çš„æ ¸å¿ƒæ¦‚å¿µ
2. âœ… ä½¿ç”¨ Helm å®Œæ•´å®‰è£èˆ‡é…ç½® Argo CD
3. âœ… æ•´åˆ GitLab SSO å¯¦ç¾å®‰å…¨çš„èº«åˆ†é©—è­‰
4. âœ… ä½¿ç”¨ Group Access Token ç®¡ç†å€‰åº«å­˜å–æ¬Šé™
5. âœ… è¨­å®š RBAC èˆ‡ AppProject æ§åˆ¶è³‡æºæ¬Šé™

**ä¸‹ä¸€æ­¥å»ºè­°**ï¼š

- å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ Applicationï¼Œå¯¦éš›é«”é©— GitOps å·¥ä½œæµç¨‹
- å•Ÿç”¨è‡ªå‹•åŒæ­¥åŠŸèƒ½ï¼Œå¯¦ç¾å®Œå…¨è‡ªå‹•åŒ–éƒ¨ç½²
- æ•´åˆ CI/CD Pipelineï¼Œå»ºç«‹å®Œæ•´çš„ DevOps æµç¨‹
- åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­é…ç½® Ingress + TLSï¼Œæå‡å®‰å…¨æ€§

## åƒè€ƒè³‡æ–™

- [Argo CD å®˜æ–¹æ–‡ä»¶](https://argo-cd.readthedocs.io/)
- [Argo CD Helm Chart](https://github.com/argoproj/argo-helm)
- [GitLab OAuth è¨­å®š](https://docs.gitlab.com/ee/integration/oauth_provider.html)
- [Argo CD å¯¦ä½œç¯„ä¾‹](https://blog.csdn.net/cr7258/article/details/122028096)
- [GitOps æœ€ä½³å¯¦è¸](https://ithelp.ithome.com.tw/articles/10266761)