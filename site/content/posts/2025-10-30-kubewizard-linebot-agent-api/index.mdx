---
title: KubeWizard x LINE Bot å¯¦æˆ°ç­†è¨˜ï¼šç”¨èŠå¤©ç®¡ç† Kubernetes
featured: true
date: 2025-10-30 10:00:00 +0800
thumbnail: kubewizard-linebot-agent-api.png
category: DevOps
author: Mark Ku
tags: ['KubeWizard', 'LINE Bot', 'Kubernetes', 'API', 'DevOps', 'Chatbot', 'Python', 'è‡ªå‹•åŒ–']
description: é€™ç¯‡æ˜¯æˆ‘æŠŠ KubeWizard æ”¹é€ æˆ LINE Bot Agent API çš„å¯¦æˆ°ç´€éŒ„ï¼Œè®“ä½ ç”¨æ‰‹æ©ŸèŠå¤©å°±èƒ½ç®¡ Kubernetesï¼Œé‚„èƒ½è‡ªå‹•åŒ–ã€æ“´å……å·¥å…·ï¼Œå®Œå…¨ä¸ç”¨é–‹é›»è…¦ã€‚
slug: kubewizard-linebot-agent-api
---

## å‰è¨€

ä»¥å‰ç®¡ Kubernetes éƒ½æ˜¯ `kubectl` æˆ– Dashboardï¼Œå‡ºé–€åœ¨å¤–é‚„è¦ VPNã€è¨˜æŒ‡ä»¤ï¼Œè¶…éº»ç…©ã€‚é€™æ¬¡æˆ‘ç›´æ¥æŠŠ KubeWizard æ”¹é€ æˆ LINE Bot Agent APIï¼Œè®“ä½ ç”¨æ‰‹æ©ŸèŠå¤©å°±èƒ½æŸ¥è³‡æºã€çœ‹ logã€é‡å•Ÿæœå‹™ï¼Œé‚„èƒ½è‡ªå‹•åŒ–ã€æ“´å……å·¥å…·ï¼Œç¶­é‹é«”é©—ç›´æ¥å‡ç´šã€‚

ä¸»è¦åŠŸèƒ½ï¼š
- æ–‡å­—äº’å‹•ç®¡ K8sï¼ˆæŸ¥è³‡æº / çœ‹ Logs / é‡å•Ÿï¼‰
- REST API äº‹ä»¶å…¥å£ï¼ˆPrometheus / GitOps / Webhookï¼‰
- å·¥å…·å¯æ“´å……ï¼ŒAI è¼”åŠ©ã€è‡ªå‹•åŒ–è…³æœ¬éš¨ä½ åŠ 
- å¤šäººç¨ç«‹è¨˜æ†¶ + æ™ºèƒ½ä¸Šä¸‹æ–‡

æ¨¡å‹æˆ‘é¸ Google Geminiï¼Œå› ç‚ºï¼š
- æœ‰ Free Tierï¼Œå¤ ç”¨
- è·Ÿ Python / FastAPI / LangChain æ•´åˆå¾ˆé †
- å¤šèªç³»ç†è§£åŠ›ä¸éŒ¯ï¼Œç¶­é‹å ´æ™¯å¾ˆå¤ ç”¨

Gemini API Rate limits è©³ç´°è«‹çœ‹å®˜æ–¹ï¼š[Gemini API Rate limits](https://ai.google.dev/gemini-api/docs/rate-limits)

![gemini rate limits](gemini-quota.png)
---

## ç”¨ LINE + Agent ç®¡ K8s æœ‰ä»€éº¼å¥½è™•ï¼Ÿ

### âœ… éš¨æ™‚éš¨åœ°
- ä¸ç”¨ VPNã€ä¸ç”¨ Terminalï¼Œæ‰‹æ©Ÿå°±èƒ½æå®š
- å¤šäºº session å„è‡ªè¨˜æ†¶ï¼Œäº’ä¸å¹²æ“¾

### ğŸ”— äº‹ä»¶å…¥å£æ•´åˆ
- REST API å¯æ¥ Prometheusã€GitLabã€Argo CDã€AlertManager Webhook
- å‘Šè­¦ä¾†äº†ç›´æ¥å› LINE å›è¦†è¨ºæ–·ã€çµ¦æ“ä½œé¸é …

### ğŸ§  æ™ºèƒ½æ“´å……
- Tools æ¨¡å¼ï¼šæŸ¥ K8sã€Pipelineã€Jiraã€Log åˆ†æã€Searchã€HTTP call å…¶ä»– API
- AI å¹«ä½ ç”Ÿ YAMLã€æ‘˜è¦éŒ¯èª¤ã€çµ¦ä¿®å¾©å»ºè­°

### ğŸ¯ å°è©±è¨˜æ†¶
- Redis å­˜ä¸Šä¸‹æ–‡ + Token Buffer è‡ªå‹•æ‘˜è¦
- ä½¿ç”¨è€…åˆ†æµï¼Œäº’ä¸å¹²æ“¾

---

## æ¶æ§‹ç¸½è¦½

æ•´é«”æµç¨‹ï¼šä½¿ç”¨è€…è¨Šæ¯ â†’ LINE â†’ Webhook â†’ Agent â†’ å·¥å…· â†’ å›è¦†

![ç³»çµ±æ¶æ§‹åœ–](flowchart.png)

æ¶æ§‹åˆ†å››å±¤ï¼š

| å±¤ç´š | è§’è‰² | èªªæ˜ |
|------|------|------|
| ä»‹é¢å±¤ | LINE Bot / REST API | å¤šå…¥å£ã€Webhookã€å‘Šè­¦/äº‹ä»¶æ³¨å…¥ |
| æ™ºèƒ½å±¤ | Agent + LLM | æ±ºç­–è¦ä¸è¦ç”¨å·¥å…·ã€æ•´åˆè¼¸å‡ºã€ç¶­æŒä¸Šä¸‹æ–‡ |
| å·¥å…·å±¤ | KubeTool / Search / RequestsGet / äººå·¥ä»‹å…¥ | æ’æ‹”å¼è¨­è¨ˆï¼Œæ“´å……å®¹æ˜“ã€æ¬Šé™éš”é›¢ |
| ç‹€æ…‹å±¤ | Redis / Kubernetes SDK | å°è©±è¨˜æ†¶ã€å¢é›†æ“ä½œã€è³‡æºå¿«ç…§ |

---

## ç‚ºä»€éº¼ç”¨ Python Kubernetes SDK ä¸ç›´æ¥å‘¼å« kubectlï¼Ÿ

| é¢å‘ | Python SDK | ç›´æ¥ kubectl |
|------|------------|--------------|
| å®‰å…¨æ€§ | é¿å…å­—ä¸²æ³¨å…¥ | éœ€ç‰¹åˆ¥è™•ç†æŒ‡ä»¤æ‹¼æ¥ |
| éŒ¯èª¤è™•ç† | çµæ§‹åŒ–ä¾‹å¤– | æ–‡å­—è§£æå›°é›£ |
| é«”ç© | è¼•é‡æ˜ åƒ | éœ€é¡å¤–å®‰è£ CLI |
| ç¨‹å¼åŒ–èƒ½åŠ› | ç‰©ä»¶æ“ä½œã€æ˜“å°è£ | éœ€è§£æè¼¸å‡ºå­—ä¸² |
| RBAC æ•´åˆ | åŸç”Ÿæ†‘è­‰/SA | éœ€æ›è¼‰ kubeconfig |

è‡ªå‹•åµæ¸¬ç’°å¢ƒï¼š
```python
def load_k8s_config():
    if os.path.exists("/var/run/secrets/kubernetes.io/serviceaccount/token"):
        config.load_incluster_config()
    else:
        config.load_kube_config()
```

å¸¸è¦‹æ˜ å°„ï¼š`kubectl get pods -n X` â†’ `v1.list_namespaced_pod(namespace=X)`ã€‚

---

## Step 1ï¼šå»ºç«‹ LINE Botï¼ˆå‰ç½®æº–å‚™ï¼‰

1. å‰å¾€ LINE Developersï¼š  
   https://developers.line.biz/console/

2. å»ºç«‹ Provider

3. å»ºç«‹ Messaging API Bot

4. å–å¾— Channel è¨­å®šä¸¦å¯«å…¥ `.env`ï¼š
```env
LINE_CHANNEL_SECRET=ä½ çš„_channel_secret
LINE_CHANNEL_ACCESS_TOKEN=ä½ çš„_access_token
```

5. è¨­å®š Webhook URLï¼Œä¾‹å¦‚ï¼š

```
https://your-domain.com/linebot/callback
```

![](linebot-console.png)
Webhook æ¸¬è©¦å¯ä»¥ç”¨ ngrok è®“æœ¬åœ°ç«¯å…¬é–‹æ¸¬è©¦ã€‚

### Webhook Settings å»ºè­°è¨­å®š

| é …ç›® | è¨­å®šå€¼ |
|-------|------------|
| Webhook URL | `https://example.com/linebot/callback` |
| Use webhook | âœ… å•Ÿç”¨ |

> éœ€ä½¿ç”¨ HTTPSã€‚æˆåŠŸå¾Œè«‹é»æ“Š Verify ç¢ºèªã€‚

---

## Step 2ï¼šæ”¹é€ æˆã€ŒLINE Bot Agent APIã€æ ¸å¿ƒå…ƒä»¶

é è¨­ KubeWizard åªèƒ½å•ä¸€å¥ç­”ä¸€å¥ï¼Œè¦è®ŠæˆçœŸæ­£å¥½ç”¨çš„ Agentï¼Œå¿…é ˆåŠ ä¸Šè¨˜æ†¶ã€å·¥å…·åˆ¤æ–·ã€å¤šå…¥å£ã€‚

### æ ¸å¿ƒè¨­è¨ˆæ¦‚å¿µ

| å…ƒä»¶ | åŠŸèƒ½ | æŠ€è¡“å¯¦ç¾ |
|------|--------|----------|
| Agent | åˆ†æè¨Šæ¯èˆ‡æ±ºç­–æ˜¯å¦ä½¿ç”¨ Tools | LangChain OpenAI Tools Agent |
| Tools | ä»¥æ’ä»¶å½¢å¼æä¾›åŠŸèƒ½ï¼ˆK8sã€Pipelineã€AI ç­‰ï¼‰ | LangChain BaseTool |
| Memory | ä½¿ç”¨ Redis å„²å­˜ä¸Šä¸‹æ–‡èˆ‡ä½¿ç”¨è€…ç‹€æ…‹ | RedisChatMessageHistory + ConversationTokenBufferMemory |
| API | æä¾› REST API èˆ‡ LINE Webhook | FastAPI |

### åŠŸèƒ½æ¨¡çµ„åŒ–ï¼ˆToolsï¼‰

æ¯å€‹åŠŸèƒ½éƒ½ç¨ç«‹æˆ Toolï¼Œæ“´å……è¶…æ–¹ä¾¿ã€‚ä»¥ä¸‹æ˜¯ KubeTool å¯¦ä½œï¼š

```python
from langchain_core.tools import BaseTool
from kubernetes import client, config
from pydantic import BaseModel, Field

class KubeInput(BaseModel):
    """Kubernetes å·¥å…·çš„åƒæ•¸æ¨¡å‹"""
    commands: str = Field(
        ...,
        example="kubectl get pods",
        description="è¦åŸ·è¡Œçš„ kubectl ç›¸é—œå‘½ä»¤"
    )

class KubeTool(BaseTool):
    """Kubernetes å·¥å…· - ä½¿ç”¨ Python SDK åŸ·è¡Œ K8s æ“ä½œ"""
    
    name: str = "KubeTool"
    description: str = """åœ¨ Kubernetes é›†ç¾¤ä¸ŠåŸ·è¡Œ k8s ç›¸é—œå‘½ä»¤çš„å·¥å…·ã€‚
    æ”¯æ´ get/describe/logs/list ç­‰æ“ä½œã€‚
    ç‰¹åˆ¥åŠŸèƒ½ï¼š
    - ä½¿ç”¨ 'kubectl list all' å¿«é€ŸæŸ¥çœ‹æ‰€æœ‰ namespace å’Œ pods æ¦‚è¦½
    - ä½¿ç”¨ 'kubectl list namespaces' æŸ¥çœ‹æ‰€æœ‰ namespace
    - ä½¿ç”¨ 'kubectl list pods' æŒ‰ namespace åˆ†çµ„æŸ¥çœ‹æ‰€æœ‰ pods
    """
    args_schema: Type[BaseModel] = KubeInput
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        # è‡ªå‹•åˆ¤æ–·ç’°å¢ƒä¸¦è¼‰å…¥é…ç½®
        try:
            config.load_incluster_config()  # Pod å…§ç’°å¢ƒ
            logger.info("ä½¿ç”¨é›†ç¾¤å…§é…ç½® (Pod ç’°å¢ƒ)")
        except:
            config.load_kube_config()  # æœ¬åœ°ç’°å¢ƒ
            logger.info("ä½¿ç”¨æœ¬åœ° kubeconfig é…ç½®")
        
        self.v1 = client.CoreV1Api()
        self.apps_v1 = client.AppsV1Api()
    
    def _run(self, commands: str) -> str:
        """åŸ·è¡Œ kubectl å‘½ä»¤ä¸¦è¿”å›çµæœ"""
        # è§£æå‘½ä»¤ä¸¦è½‰æ›ç‚º SDK API èª¿ç”¨
        # ä¾‹å¦‚ï¼škubectl get pods -n default
        # è½‰æ›ç‚ºï¼šself.v1.list_namespaced_pod(namespace="default")
        ...
```

### Agent åˆ¤æ–·é‚è¼¯

```python
# Agent åˆå§‹åŒ–
from langchain.agents import create_openai_tools_agent, AgentExecutor
from langchain_google_genai import ChatGoogleGenerativeAI

# å®šç¾©å¯ç”¨å·¥å…·
tools = [
    KubeTool(),
    SearchTool(),
    RequestsGet(),
    human_console_input()
]

# å‰µå»º Agent
agent = create_openai_tools_agent(
    llm=ChatGoogleGenerativeAI(model="gemini-2.0-flash"),
    tools=tools,
    prompt=system_prompt
)

agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    memory=memory,
    verbose=True
)

# åŸ·è¡Œæµç¨‹ï¼šä½¿ç”¨è€…å•é¡Œ â†’ Agent åˆ†æ â†’ é¸æ“‡å·¥å…· â†’ åŸ·è¡Œ â†’ å›å‚³çµæœ
result = agent_executor.invoke({"input": "åˆ—å‡ºæ‰€æœ‰ pods"})
```

## æˆ‘çš„ã€ŒVibe Codingã€è¿­ä»£å¿ƒå¾—ï¼ˆçœŸå¯¦è¸©é›·è¨˜éŒ„ï¼‰

é€™æ¬¡ä¸æ˜¯å…ˆå¯«ä¸€å †è¨­è¨ˆæ–‡ä»¶ï¼Œè€Œæ˜¯é‚Šåšé‚Šèª¿æ•´ï¼Œç”¨æˆ‘è‡ªå·±èªªçš„ã€ŒVibe Codingã€ç¯€å¥åœ¨è¿­ä»£ï¼Œå¤§æ¦‚æ˜¯é€™æ¨£ç©ï¼š

1. å…ˆè·‘å¾—èµ·ä¾†å†èªªï¼šå…ˆåšä¸€å€‹æœ€å°ç‰ˆçš„ `KubeAgent`ï¼Œåªæ¥ä¸€å€‹ `KubeTool`ï¼Œå¯ä»¥åœ¨ CLI å›ã€Œåˆ—å‡º podsã€å°±ç®—éé—œã€‚
2. è§€å¯Ÿæ¨¡å‹çš„ã€Œå€‹æ€§ã€ï¼šçœ‹å®ƒæœƒä¸æœƒäº‚è¬›ã€æœƒä¸æœƒè©²ç”¨å·¥å…·å»ä¸å»æŸ¥ï¼Œå¦‚æœæœƒï¼Œå°±åœ¨ Prompt è£¡è£œä¸€å¥ã€Œå…ˆåˆ†æå•é¡Œå†æ±ºå®šè¦ä¸è¦æŸ¥è©¢ã€ã€‚
3. ä¸€æ¬¡åªåŠ ä¸€å€‹èƒ½åŠ›ï¼šä¾‹å¦‚å…ˆåŠ  `search`ï¼Œå°±å°ˆå¿ƒæ¸¬ 2ï½3 å€‹æƒ…å¢ƒï¼Œç¢ºèªå®ƒçœŸçš„æœƒç”¨åˆ°ï¼Œå†åŠ ä¸‹ä¸€å€‹ `RequestsGet`ã€`human_console_input`ã€‚
4. å±éšªæ“ä½œå¦å¤–è™•ç†ï¼šç™¼ç¾åˆªé™¤ / é‡å•Ÿé€™ç¨®æŒ‡ä»¤ä¸å¤ªèƒ½å®Œå…¨äº¤çµ¦æ¨¡å‹å¾Œï¼Œæ‰æ‹†å‡ºä¸€å€‹ `KubeToolWithApprove`ï¼Œä¸€å®šè¦æœ‰äººæŒ‰ç¢ºèªæ‰æœƒåŸ·è¡Œã€‚
5. å°è©±è¶Šä¾†è¶Šé•·æ‰åŠ è¨˜æ†¶ï¼šä¸€é–‹å§‹ä¸ç”¨æ€¥è‘—ä¸Š Redisï¼Œç­‰çœŸçš„æ„Ÿè¦ºã€ŒèŠä¸€èŠæœƒå¿˜è¨˜å‰é¢èªªä»€éº¼ã€äº†ï¼Œå†æ¥å…¥ Redis + Token Bufferï¼Œé †ä¾¿çœ‹ä¸€ä¸‹ Token ç”¨é‡æœ‰æ²’æœ‰è®Šç©©å®šã€‚
6. çœŸçš„é‡åˆ°ç—›é»å†å„ªåŒ–ï¼šä¾‹å¦‚ API è®Šæ…¢ã€K8s æŸ¥å¤ªå¤šæ¬¡ï¼Œæ‰åŠ ã€Œé—œéµå­—åˆ¤æ–·æ‰æŸ¥æ•´é«”ç‹€æ…‹ã€é€™ç¨®æœ€ä½³åŒ–ï¼Œè€Œä¸æ˜¯ä¸€é–‹å§‹å°±æŠŠæ‰€æœ‰æƒ…å¢ƒè…¦è£œå®Œã€‚
7. æœ€å¾Œæ‰æ”¶æ–‚æˆ Helmï¼šç­‰å–®æ©Ÿ Docker / Compose éƒ½è·‘ç©©ï¼Œå†æŠŠç’°å¢ƒè®Šæ•¸ã€Secretsã€RBAC æ‰“åŒ…æˆ Helm Chartï¼Œè®Šæˆå¯ä»¥ä¸Ÿåˆ°ä»»ä½•å¢é›†çš„æ¨¡æ¿ã€‚

æ•´é«”å¿ƒæ³•å¾ˆç°¡å–®ï¼š

- å…ˆæœ‰ç”¨ï¼Œå†è®Šæ¼‚äº®ã€‚
- æ¯æ¬¡è¿­ä»£éƒ½åªè§£ä¸€å€‹çœŸå¯¦å•é¡Œï¼ˆä¾‹å¦‚ï¼šè¨˜æ†¶æ··åœ¨ä¸€èµ·ã€å›è¦†å¤ªé•·ã€èª¤åˆªè³‡æºï¼‰ã€‚
- ç”¨ log çœ‹ Agent åœ¨å¹¹å˜›ï¼šè©²ç”¨å·¥å…·æ²’ç”¨ã€ç”¨éŒ¯å·¥å…·ï¼Œé€šå¸¸ä»£è¡¨ Prompt / å·¥å…·æè¿°å¯ä»¥å†èª¿ä¸€ä¸‹ã€‚
- èƒ½ç”¨ SDK çš„åœ°æ–¹å°±ä¸è¦å†ç¡¬æ‹¼å­—ä¸²ï¼Œä¹‹å¾Œè¦ç¶­è­·æœƒè¼•é¬†å¾ˆå¤šã€‚

## æŠ€è¡“äº®é»ã€æŒ‘æˆ°èˆ‡è§£æ³•ï¼ˆç™½è©±ç‰ˆï¼‰

é€™æ®µå°±ç•¶æˆã€Œæˆ‘åœ¨å¯¦ä½œä¸­çœŸçš„é‡åˆ°çš„å‘ã€ï¼ŒæŒ‘å¹¾å€‹ä»£è¡¨æ€§çš„ä¾†èªªï¼š

1. **ä¸ç”¨ç›´æ¥è·‘ `kubectl`ï¼Œæ”¹ç”¨ Python SDK**  
  - å•é¡Œï¼šç”¨å­—ä¸²çµ„ `kubectl`ï¼Œå¾ˆå®¹æ˜“è¸©åˆ° shell æ³¨å…¥ã€éŒ¯èª¤è¨Šæ¯ä¹Ÿé›£è™•ç†ï¼Œé¡åƒé‚„è¦å†è£ä¸€å€‹ CLIã€‚  
  - åšæ³•ï¼šæŠŠå¸¸ç”¨æŒ‡ä»¤ï¼ˆä¾‹å¦‚ `kubectl get pods -n default`ï¼‰ç”¨ç¨‹å¼è§£æå¾Œï¼Œæ˜ å°„åˆ° Python SDK çš„å‘¼å«ï¼Œåƒæ˜¯ `v1.list_namespaced_pod(namespace="default")`ï¼Œæœ€å¾Œå†è‡ªå·±æ’ç‰ˆæˆè¡¨æ ¼ã€‚  
  - å¥½è™•ï¼šè¼¸å‡ºå¯æ§ã€å®‰å…¨æ€§æ¯”è¼ƒé«˜ï¼Œä¹Ÿæ¯”è¼ƒå¥½å°è£æˆ Toolã€‚å¯¦ä½œåœ¨ `tools/kubetool_sdk.py`ã€‚

2. **åŒä¸€å¥—ç¨‹å¼ï¼Œè¦èƒ½åœ¨æœ¬æ©Ÿè·Ÿ K8s è£¡éƒ½è·‘**  
  - å•é¡Œï¼šæœ¬æ©Ÿè¦è®€ `kubeconfig`ï¼Œä¸Ÿé€²å¢é›†è£¡åˆè¦ç”¨ ServiceAccountï¼Œå¦‚æœå¯«æ­»ï¼Œå¾ˆå®¹æ˜“å“ªé‚Šå¿˜è¨˜æ”¹ã€‚  
  - åšæ³•ï¼šå•Ÿå‹•æ™‚æª¢æŸ¥ Pod è£¡çš„ ServiceAccount token å­˜ä¸å­˜åœ¨ï¼Œå­˜åœ¨å°±ç”¨ `load_incluster_config()`ï¼Œæ²’æœ‰å°±é€€å› `load_kube_config()`ã€‚  
  - å¥½è™•ï¼šåŒä¸€ä»½ç¨‹å¼ç¢¼ï¼Œé–‹ç™¼ã€æ¸¬è©¦ã€ä¸Šç·šéƒ½å¯ä»¥å…±ç”¨ã€‚å¯¦ä½œé›†ä¸­åœ¨ `utils/k8s_config.py`ã€‚

3. **å°è©±è¨˜æ†¶æœƒä¸€ç›´é•·å¤§ï¼Œè¦æ§åˆ¶ Token æˆæœ¬**  
  - å•é¡Œï¼šè·Ÿ Bot èŠä¸€é™£å­ä¹‹å¾Œï¼Œæ­·å²è¨Šæ¯æœƒè®Šå¾ˆé•·ï¼Œå›æ‡‰è®Šæ…¢ã€Token è²»ç”¨ä¹Ÿæœƒä¸€èµ·é£†ã€‚  
  - åšæ³•ï¼šç”¨ Redis å­˜æ¯å€‹äººçš„å°è©±ï¼Œå†ç”¨ `ConversationTokenBufferMemory` æ§åˆ¶é•·åº¦ï¼Œè¶…éä¸€å®šç­†æ•¸å°±ç”¨æ¨¡å‹å¹«å¿™ç¸½çµï¼ŒæŠŠèˆŠè¨Šæ¯æ”¶æ–‚æˆä¸€æ®µæ‘˜è¦ã€‚  
  - å¥½è™•ï¼šä½¿ç”¨è€…æ„Ÿè¦ºé‚„æ˜¯æœ‰ã€Œè¨˜æ†¶ã€ï¼Œä½†å¾Œç«¯ä¸æœƒè¢«æ•´åŒ…æ­·å²æ‹–å®ã€‚ç›¸é—œé‚è¼¯åœ¨ `agents/kube_agent.py`ã€‚

4. **å¤šäººä¸€èµ·ç”¨ï¼Œè¨˜æ†¶ä¸èƒ½æ··åœ¨ä¸€èµ·**  
  - å•é¡Œï¼šå¦‚æœå¤§å®¶éƒ½å¯«é€²åŒä¸€å€‹ sessionï¼ŒBot æœƒè¨˜éŒ¯äººï¼Œä¸Šä¸€å¥å•çš„æ˜¯ Aï¼Œä¸‹ä¸€å¥å»æ¥ B çš„ä¸Šä¸‹æ–‡ã€‚  
  - åšæ³•ï¼šRedis çš„ key è£¡é¢å¸¶ `user_id`ï¼Œæ¯å€‹äººä¸€å€‹ç¨ç«‹çš„å°è©±ç©ºé–“ã€‚  
  - å¥½è™•ï¼šLINE ä¸Šæ¯å€‹äººçœ‹åˆ°çš„ Bot éƒ½åƒæ˜¯è‡ªå·±çš„å°åŠ©ç†ï¼Œä¸æœƒäº’ç›¸å¹²æ“¾ã€‚å¯¦ä½œä¸€æ¨£åœ¨ `agents/kube_agent.py`ã€‚

5. **å±éšªæ“ä½œä¸€å®šè¦ã€Œå‰è»Šã€**  
  - å•é¡Œï¼šåƒåˆª Podã€é‡å•Ÿ Deployment é€™ç¨®å‹•ä½œï¼Œå¦‚æœæ¨¡å‹è‡ªå·±æ±ºå®šå°±å»åšï¼Œé¢¨éšªå¾ˆå¤§ã€‚  
  - åšæ³•ï¼šæŠŠå·¥å…·æ‹†å…©ç¨®ï¼šæŸ¥è©¢ç”¨çš„ `KubeTool`ï¼ˆå®‰å…¨ï¼‰ï¼Œä»¥åŠéœ€è¦äººæŒ‰ç¢ºèªçš„ `KubeToolWithApprove`ã€‚çœŸçš„è¦å‹•æ‰‹ä¹‹å‰ï¼Œæœƒå…ˆå•ä¸€æ¬¡ã€‚  
  - å¥½è™•ï¼šæ—¥å¸¸æŸ¥ç‹€æ…‹å¾ˆé †ï¼ŒçœŸè¦æ”¹å‹•å¢é›†æ™‚é‚„æ˜¯æœƒç¶“éäººçœ¼ã€‚å¯¦ä½œåœ¨ `tools/kubetool_sdk.py`ã€‚

6. **ä¸è¦æ¯ä¸€é¡Œéƒ½æŸ¥æ•´å€‹å¢é›†**  
  - å•é¡Œï¼šå¦‚æœæ¯å€‹å•é¡Œéƒ½æŠŠæ‰€æœ‰ namespace / pods ç‹€æ…‹æŸ¥ä¸€è¼ªï¼Œæ—¢æ…¢åˆæµªè²»è³‡æºã€‚  
  - åšæ³•ï¼šåªæœ‰é‡åˆ°åƒã€Œåˆ—å‡ºã€ã€Œå…¨éƒ¨ã€ã€Œæœ‰å“ªäº›ã€é€™ç¨®é—œéµå­—ï¼Œæ‰å¹«å¿™åŠ ä¸Šæ•´é«”å¿«ç…§ï¼›ä¸€èˆ¬è¿½å•å°±åªæŸ¥è·Ÿä¸Šä¸€é¡Œæœ‰é—œçš„æ±è¥¿ã€‚  
  - å¥½è™•ï¼šå›æ‡‰é€Ÿåº¦æ¯”è¼ƒç©©ï¼Œä¹Ÿæ¯”è¼ƒä¸æœƒæ‰“çˆ† API / K8sã€‚é‚è¼¯åœ¨ `kube_agent.py` çš„è¼¸å…¥å‰è™•ç†ã€‚

7. **RBAC æ¬Šé™ç›¡é‡ç¸®å°**  
  - å•é¡Œï¼šçµ¦åˆ° cluster-admin å¾ˆæ–¹ä¾¿ï¼Œä½†é¢¨éšªä¹Ÿæœ€å¤§ã€‚  
  - åšæ³•ï¼šé è¨­ç”¨ Namespace Scoped çš„ Role å°±å¤ ç”¨ï¼Œéœ€è¦è·¨ namespace å†æ”¹æˆ ClusterRoleï¼Œé€™å…©ç¨®æ¨¡å¼éƒ½é€é Helm çš„ `values.yaml` æ§åˆ¶ã€‚  
  - å¥½è™•ï¼šå…ˆå¾å®‰å…¨ä¸€é»çš„è¨­å®šèµ·æ­¥ï¼Œæœ‰éœ€æ±‚å†å¾€å¤–æ”¾æ¬Šé™ã€‚ç›¸é—œç¯„ä¾‹åœ¨ `helm/values.yaml` èˆ‡ RBAC ç¯€ã€‚

8. **å›è¦†è¦è®“ã€Œç¶­é‹çš„äººã€å¥½è®€**  
  - å•é¡Œï¼šå¦‚æœåªä¸Ÿä¸€å¤§æ®µåŸå§‹è¼¸å‡ºçµ¦ä½¿ç”¨è€…ï¼Œæ‰‹æ©Ÿä¸Šå¾ˆé›£çœ‹ã€‚  
  - åšæ³•ï¼šåœ¨ Prompt è£¡å›ºå®šè¦æ±‚è¼¸å‡ºæ ¼å¼ï¼Œä¾‹å¦‚ç°¡å–®è¡¨æ ¼ï¼‹é‡é»æç¤ºï¼Œç›¡é‡è®“æœ€é‡è¦çš„è³‡è¨Šï¼ˆå“ªå€‹ Pod çˆ†ã€å“ªå€‹ Service æ²’å¾Œç«¯ï¼‰ä¸€çœ¼å°±çœ‹åˆ°ã€‚  
  - å¥½è™•ï¼šä¸ç”¨å†è‡ªå·±çœ¼åŠ›æƒ logï¼Œç›´æ¥å¯ä»¥åšä¸‹ä¸€æ­¥åˆ¤æ–·ã€‚æ ¼å¼æç¤ºå¯«åœ¨ `agents/kube_agent.py` çš„ system prompt è£¡ã€‚

é€™äº›å…¶å¯¦éƒ½ä¸æ˜¯ä»€éº¼é«˜æ·±çš„ã€ŒAI æŠ€è¡“ã€ï¼Œæ¯”è¼ƒåƒæ˜¯ï¼šæŠŠä¸€å€‹æœƒè¬›è©±çš„ Botï¼Œæ…¢æ…¢èª¿æ•´åˆ°çœŸçš„èƒ½åœ¨ç¶­é‹ç¾å ´æ´¾ä¸Šç”¨å ´ã€‚

## RBAC æ¬Šé™è¨­å®šï¼ˆå»ºè­°ï¼‰

ä»¥ä¸‹ç‚ºå»ºè­°çš„æœ€å°å¿…è¦æ¬Šé™ï¼Œæ”¯æ´ **Namespace Scoped** å’Œ **Cluster Wide** å…©ç¨®æ¨¡å¼ã€‚

### Namespace Scopedï¼ˆæ¨è–¦ï¼Œæœ€å°æ¬Šé™åŸå‰‡ï¼‰

**é©ç”¨å ´æ™¯ï¼š**
- åªéœ€è¦ç®¡ç†ç‰¹å®š namespace çš„è³‡æº
- ä¸éœ€è¦ cluster-admin æ¬Šé™å³å¯éƒ¨ç½²
- æ›´å®‰å…¨ã€æ›´ç¬¦åˆä¼æ¥­å®‰å…¨è¦ç¯„

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubewizard-bot
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kubewizard-bot-role
  namespace: default
rules:
  # Core è³‡æº
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints", "events", "configmaps", "secrets", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  # Pod logsï¼ˆåªéœ€è®€å–æ¬Šé™ï¼‰
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get", "list"]
  
  # Apps è³‡æº
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  # Batch è³‡æº
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  # Networking è³‡æº
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubewizard-bot-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: kubewizard-bot
    namespace: default
roleRef:
  kind: Role
  name: kubewizard-bot-role
  apiGroup: rbac.authorization.k8s.io
```

### Cluster Wideï¼ˆé€²éšç”¨ï¼‰

**é©ç”¨å ´æ™¯ï¼š**
- éœ€è¦è·¨ namespace ç®¡ç†è³‡æº
- éœ€è¦æŸ¥çœ‹ nodesã€namespaces ç­‰é›†ç¾¤ç´šåˆ¥è³‡æº
- éœ€è¦ cluster-admin æ¬Šé™ä¾†éƒ¨ç½²

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubewizard-bot
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubewizard-bot-cluster-role
rules:
  # Namespace ç´šåˆ¥è³‡æºï¼ˆæ‰€æœ‰ namespaceï¼‰
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints", "events", "configmaps", "secrets", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get", "list"]
  
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses", "networkpolicies"]
    verbs: ["get", "list", "watch"]
  
  # Cluster ç´šåˆ¥è³‡æºï¼ˆåªè®€ï¼‰
  - apiGroups: [""]
    resources: ["nodes", "namespaces", "persistentvolumes"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubewizard-bot-cluster-binding
subjects:
  - kind: ServiceAccount
    name: kubewizard-bot
    namespace: default
roleRef:
  kind: ClusterRole
  name: kubewizard-bot-cluster-role
  apiGroup: rbac.authorization.k8s.io
```

### Helm Chart é…ç½®ï¼ˆæ¨è–¦ï¼‰

å°ˆæ¡ˆå·²åŒ…å«å®Œæ•´çš„ Helm Chartï¼Œå¯é€é `values.yaml` è¼•é¬†é…ç½®ï¼š

```yaml
# values.yaml

# RBAC é…ç½®
rbac:
  # æ˜¯å¦å‰µå»º RBAC è³‡æº
  create: true
  
  # ä½¿ç”¨ Role (false) æˆ– ClusterRole (true)
  # è¨­ç‚º false å¯é¿å…éœ€è¦ cluster-admin æ¬Šé™
  clusterWide: false
  
  # è‡ªå®šç¾© RBAC è¦å‰‡
  rules:
    - apiGroups: [""]
      resources: ["pods", "services"]
      verbs: ["get", "list", "watch"]
```

**éƒ¨ç½²æ–¹å¼ï¼š**

```bash
# 1. Namespace Scoped éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰
helm install kubewizard ./helm \
  --set rbac.clusterWide=false \
  --set secrets.AI_GOOGLE_API_KEY="your-api-key" \
  --namespace default

# 2. Cluster Wide éƒ¨ç½²
helm install kubewizard ./helm \
  --set rbac.clusterWide=true \
  --set secrets.AI_GOOGLE_API_KEY="your-api-key" \
  --namespace default

# 3. é©—è­‰ RBAC æ¬Šé™
kubectl auth can-i list pods \
  --as=system:serviceaccount:default:kubewizard-bot \
  -n default
```

## Demo ç¤ºç¯„ï¼ˆæ–‡å­—ç‰ˆï¼‰

### ç¯„ä¾‹ 1ï¼šæŸ¥è©¢ Pods ç‹€æ…‹

**ä½ ï¼š** å¹«æˆ‘çœ‹ default namespace çš„ Pods  
**Botï¼š** 
```
ğŸ“¦ Namespace: default
================================
NAME                         READY   STATUS              RESTARTS   AGE
nginx-deployment-7d8f...     1/1     Running            0          2d
redis-master-0               1/1     Running            0          5d
payment-service-abc123       0/1     CrashLoopBackOff   5          10m

ç¸½è¨ˆ: 3 pods (2 Running, 0 Pending, 1 CrashLoopBackOff)
âš ï¸ ç™¼ç¾å•é¡Œ: payment-service-abc123 è™•æ–¼ CrashLoopBackOff ç‹€æ…‹
éœ€è¦æŸ¥çœ‹ Logs å—ï¼Ÿ
```

**ä½ ï¼š** çœ‹ä¸€ä¸‹é‚£å€‹ Crash çš„ Log  
**Botï¼š** 
```
ğŸ” payment-service-abc123 çš„æœ€è¿‘æ—¥èªŒï¼š

2025-11-22 10:30:15 [ERROR] Failed to connect to database
2025-11-22 10:30:15 [ERROR] Connection refused: mysql:3306
2025-11-22 10:30:15 [FATAL] Application startup failed

ğŸ’¡ å¯èƒ½åŸå› ï¼š
1. MySQL Service ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•
2. ç’°å¢ƒè®Šæ•¸é…ç½®éŒ¯èª¤ï¼ˆDB_HOSTï¼‰
3. ç¶²çµ¡ç­–ç•¥é˜»æ“‹é€£ç·š

å»ºè­°æª¢æŸ¥ï¼š
- kubectl get svc -n default | grep mysql
- ç¢ºèª Pod çš„ç’°å¢ƒè®Šæ•¸è¨­å®š
```

**ä½ ï¼š** å¹«æˆ‘é‡å•Ÿçœ‹çœ‹  
**Botï¼š** 
```
ğŸ”„ æ­£åœ¨é‡å•Ÿ Deployment: payment-service

âœ… å·²åŸ·è¡Œï¼škubectl rollout restart deployment/payment-service -n default
â³ ç­‰å¾…æ–° Pod å•Ÿå‹•ä¸­...

ğŸ“Š æ›´æ–°ç‹€æ…‹ï¼š
- èˆŠç‰ˆ Pods: æ­£åœ¨çµ‚æ­¢
- æ–°ç‰ˆ Pods: æ­£åœ¨å‰µå»º
- é è¨ˆå®Œæˆæ™‚é–“: ~30 ç§’

æˆ‘æœƒæŒçºŒç›£æ§ç‹€æ…‹ï¼Œç¨å¾Œå›å ±çµæœã€‚
```

### ç¯„ä¾‹ 2ï¼šè¨ºæ–·ç¶²è·¯å•é¡Œ

**ä½ ï¼š** ç‚ºä»€éº¼æˆ‘çš„ Ingress ç„¡æ³•è¨ªå•ï¼Ÿ  
**Botï¼š** è®“æˆ‘å¹«ä½ è¨ºæ–· Ingress å•é¡Œã€‚

```
ğŸ” è¨ºæ–·æ­¥é©Ÿï¼š

1ï¸âƒ£ æª¢æŸ¥ Ingress è³‡æº
âœ… Ingress 'my-app' å·²å­˜åœ¨
âœ… Ingress Controller æ­£å¸¸é‹è¡Œ

2ï¸âƒ£ æª¢æŸ¥ Service
âœ… Service 'my-app-svc' å·²å­˜åœ¨ (ClusterIP: 10.96.1.100)

3ï¸âƒ£ æª¢æŸ¥ Pod
âš ï¸ å•é¡Œç™¼ç¾ï¼šService å¾Œç«¯æ²’æœ‰å¯ç”¨çš„ Podï¼

EndpointSlice è³‡è¨Šï¼š
- my-app-svc: 0/3 endpoints ready

ğŸ“‹ å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š
1. æª¢æŸ¥ Deployment çš„ selector æ˜¯å¦èˆ‡ Service åŒ¹é…
2. æª¢æŸ¥ Pod çš„ labels æ˜¯å¦æ­£ç¢º
3. åŸ·è¡Œï¼škubectl describe service my-app-svc -n default

éœ€è¦æˆ‘å¹«ä½ åŸ·è¡Œé€™äº›æª¢æŸ¥å—ï¼Ÿ
```

### ç¯„ä¾‹ 3ï¼šæ™ºèƒ½ä¸Šä¸‹æ–‡è¨˜æ†¶

**ä½ ï¼š** åˆ—å‡ºæ‰€æœ‰ namespace  
**Botï¼š** 
```
ğŸ“‹ æ‰€æœ‰ Namespacesï¼š
1. default
2. kube-system
3. kube-public
4. production
5. staging
6. monitoring

ç¸½è¨ˆ: 6 å€‹ namespaces
```

**ä½ ï¼š** production è£¡é¢æœ‰ä»€éº¼ï¼Ÿ  
**Botï¼š** *(æ™ºèƒ½è¨˜æ†¶å‰ä¸€å¥çš„ "production" namespace)*
```
ğŸ“¦ Namespace: production
================================

Deployments:
- api-gateway (3/3 Ready)
- user-service (2/2 Ready)
- order-service (5/5 Ready)

Services:
- api-gateway-svc (LoadBalancer)
- user-service-svc (ClusterIP)
- order-service-svc (ClusterIP)

ç¸½è¨ˆ: 3 Deployments, 3 Services, 10 Pods (å…¨éƒ¨æ­£å¸¸)
```

**ä½ ï¼š** é‡å•Ÿ api-gateway  
**Botï¼š** *(è¨˜å¾—æˆ‘å€‘åœ¨è«‡è«– production namespace çš„ api-gateway)*
```
ç¢ºèªè¦é‡å•Ÿ production namespace çš„ api-gateway å—ï¼Ÿ
é€™æœƒå°è‡´çŸ­æš«çš„æœå‹™ä¸­æ–·ã€‚

[å·²ç¢ºèª]

ğŸ”„ æ­£åœ¨åŸ·è¡Œï¼škubectl rollout restart deployment/api-gateway -n production
âœ… é‡å•ŸæˆåŠŸï¼æ–° Pods å·²å•Ÿå‹•ä¸¦å°±ç·’ã€‚
```

![å¯¦éš›æ“ä½œæˆªåœ– 1](result-1.png)
![å¯¦éš›æ“ä½œæˆªåœ– 2](result-2.png)
---

## çµèª

é€™ç¯‡ç­†è¨˜ç¤ºç¯„æ€éº¼æŠŠ KubeWizard æ•´åˆåˆ° LINE Botï¼Œæ‰“é€ å‡ºèƒ½èŠå¤©ç®¡ K8s çš„åŠ©ç†ï¼Œé‡é»ï¼š

### ğŸ“š åƒè€ƒè³‡æ–™

- [å¿«é€Ÿé–‹å§‹æŒ‡å—](https://github.com/markku636/kubewizard/blob/main/QUICKSTART.md)
- [LINE Bot æ•´åˆæ–‡æª”](https://github.com/markku636/kubewizard/blob/main/kubewizard_linebot/LINE_BOT_README.md)
- [Kubernetes é…ç½®èªªæ˜](https://github.com/markku636/kubewizard/blob/main/docs/K8S_CONFIG_GUIDE.md)
- [Helm Chart éƒ¨ç½²æŒ‡å—](https://github.com/markku636/kubewizard/blob/main/helm/DEPLOYMENT.md)

### ç‰¹åˆ¥æ„Ÿè¬ä»¥ä¸‹é–‹æºå°ˆæ¡ˆï¼š
- [LangChain](https://python.langchain.com/) - å¼·å¤§çš„ LLM æ‡‰ç”¨æ¡†æ¶
- [Google Gemini](https://ai.google.dev/) - å„ªç§€çš„ AI æ¨¡å‹
- [Kubernetes Python Client](https://github.com/kubernetes-client/python) - å®˜æ–¹ Python SDK
- [FastAPI](https://fastapi.tiangolo.com/) - ç¾ä»£åŒ–çš„ Web æ¡†æ¶


