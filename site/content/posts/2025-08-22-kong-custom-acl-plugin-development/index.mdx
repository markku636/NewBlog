---
featured: true
title: Kong Custom ACL å¥—ä»¶é–‹ç™¼æ•™å­¸ï¼šå¾é›¶é–‹å§‹æ‰“é€  API æ¬Šé™ç®¡ç†ç³»çµ±
slug: kong-custom-acl-plugin-development
category: DevOps
thumbnail: kong-custom-acl-plugin-development.png
date: 2025-08-20 01:01:00 +0800
tags: ['Kong', 'API Gateway', 'Custom Plugin', 'Lua', 'PostgreSQL', 'æ¬Šé™ç®¡ç†', 'DevOps', 'æ•™å­¸']
description: è·Ÿè‘—æ­¥é©Ÿå­¸ç¿’å¦‚ä½•é–‹ç™¼ Kong Custom ACL å¥—ä»¶ï¼Œå¾åŸºç¤æ¦‚å¿µåˆ°å®Œæ•´å¯¦ä½œï¼Œæ‰“é€ å°ˆå±¬çš„ API æ¬Šé™ç®¡ç†ç³»çµ±ã€‚
author: Mark Ku
---

# Kong Custom ACL å¥—ä»¶é–‹ç™¼æ•™å­¸ï¼šå¾é›¶é–‹å§‹æ‰“é€  API æ¬Šé™ç®¡ç†ç³»çµ±

## ğŸ¯ å­¸ç¿’ç›®æ¨™

åœ¨é€™ç¯‡æ•™å­¸ä¸­ï¼Œä½ å°‡å­¸æœƒï¼š
- äº†è§£ Kong æ’ä»¶ç³»çµ±çš„åŸºæœ¬æ¦‚å¿µ
- è¨­è¨ˆç°¡å–®çš„æ¬Šé™ç®¡ç†è³‡æ–™åº«
- é–‹ç™¼è‡ªè¨‚ ACL æ’ä»¶
- éƒ¨ç½²å’Œæ¸¬è©¦æ’ä»¶åŠŸèƒ½

## ğŸ“‹ å‰ç½®æº–å‚™

åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºä¿ä½ å·²ç¶“å®‰è£ï¼š
- Docker å’Œ Docker Compose
- åŸºæœ¬çš„ Lua ç¨‹å¼è¨­è¨ˆæ¦‚å¿µ
- PostgreSQL è³‡æ–™åº«åŸºç¤çŸ¥è­˜

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šäº†è§£å°ˆæ¡ˆæ¶æ§‹

### å°ˆæ¡ˆçµæ§‹
```
custom-acl/
â”œâ”€â”€ handler.lua      # ä¸»è¦é‚è¼¯è™•ç†
â”œâ”€â”€ schema.lua       # é…ç½®å®šç¾©
â”œâ”€â”€ api.lua          # ç®¡ç† API
â”œâ”€â”€ init.sql         # è³‡æ–™åº«åˆå§‹åŒ–
â”œâ”€â”€ Dockerfile       # å®¹å™¨åŒ–é…ç½®
â””â”€â”€ docker-compose.yml
```

### ç³»çµ±æµç¨‹åœ–
```

ç”¨æˆ¶è«‹æ±‚ â†’ Kong Gateway â†’ Custom ACL æ’ä»¶ â†’ æª¢æŸ¥æ¬Šé™ â†’ å…è¨±/æ‹’çµ•
                â†“
            PostgreSQL è³‡æ–™åº«
```

---

## ğŸ—„ï¸ ç¬¬äºŒæ­¥ï¼šè¨­è¨ˆè³‡æ–™åº«çµæ§‹

### å»ºç«‹æ¬Šé™ç®¡ç†è¡¨

```sql:custom-acl/init.sql
-- å»ºç«‹å®¢æˆ¶ API æ¬Šé™è¡¨
CREATE TABLE IF NOT EXISTS customer_api_permissions (
    id SERIAL PRIMARY KEY,
    customer_id VARCHAR(100) NOT NULL,
    service_id VARCHAR(100),
    route_id VARCHAR(100),
    api_path VARCHAR(500) NOT NULL,
    method VARCHAR(10) DEFAULT 'GET',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by VARCHAR(100) DEFAULT 'system',
    updated_by VARCHAR(100) DEFAULT 'system'
);

-- å»ºç«‹ç´¢å¼•æå‡æŸ¥è©¢æ•ˆèƒ½
CREATE INDEX IF NOT EXISTS idx_customer_permissions_customer_id 
ON customer_api_permissions(customer_id);

CREATE INDEX IF NOT EXISTS idx_customer_permissions_api_path 
ON customer_api_permissions(api_path);

CREATE INDEX IF NOT EXISTS idx_customer_permissions_active 
ON customer_api_permissions(is_active);

-- æ’å…¥æ¸¬è©¦è³‡æ–™
INSERT INTO customer_api_permissions (customer_id, api_path, method, is_active) VALUES
('customer_001', '/api/users', 'GET', true),
('customer_001', '/api/orders', 'POST', true),
('customer_002', '/api/products', 'GET', true),
('customer_002', '/api/analytics', 'GET', false);
```

**èªªæ˜ï¼š**
- `customer_id`ï¼šå®¢æˆ¶è­˜åˆ¥ç¢¼
- `api_path`ï¼šAPI è·¯å¾‘
- `method`ï¼šHTTP æ–¹æ³•
- `is_active`ï¼šæ¬Šé™æ˜¯å¦å•Ÿç”¨
- å»ºç«‹ç´¢å¼•è®“æŸ¥è©¢æ›´å¿«

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šé–‹ç™¼æ ¸å¿ƒè™•ç†å™¨

### å»ºç«‹ handler.lua

```lua:custom-acl/handler.lua
local kong_meta = require "kong.meta"
local cjson = require "cjson.safe"
local postgres = require "resty.postgres"

local kong = kong
local _M = {}

local CustomAclHandler = {
  PRIORITY = 1000,  -- åŸ·è¡Œå„ªå…ˆé †åº
  VERSION = "1.0.0",
}

-- æ­¥é©Ÿ 1ï¼šå¾ Kong å–å¾—å®¢æˆ¶ ID
local function extract_customer_id_from_keyauth()
  local consumer = kong.client.get_consumer()
  if consumer and consumer.custom_id then
    kong.log.debug("å–å¾—åˆ°å®¢æˆ¶ ID: ", consumer.custom_id)
    return consumer.custom_id
  end
  return nil
end

-- æ­¥é©Ÿ 2ï¼šé€£æ¥è³‡æ–™åº«
local function get_postgres_connection()
  local config = {
    host = os.getenv("KONG_PG_HOST") or "kong-database",
    port = tonumber(os.getenv("KONG_PG_PORT")) or 5432,
    database = os.getenv("KONG_PG_DATABASE") or "kong",
    user = os.getenv("KONG_PG_USER") or "kong",
    password = os.getenv("KONG_PG_PASSWORD") or "kong"
  }

  local db, err = postgres:new()
  if not db then
    return nil, "ç„¡æ³•å»ºç«‹è³‡æ–™åº«é€£æ¥: " .. tostring(err)
  end

  db:set_timeout(5000)
  
  local ok, err = db:connect(config.host, config.port, config.database, config.user, config.password)
  if not ok then
    return nil, "é€£æ¥è³‡æ–™åº«å¤±æ•—: " .. tostring(err)
  end

  return db
end

-- æ­¥é©Ÿ 3ï¼šæª¢æŸ¥æ¬Šé™
local function check_permissions(customer_id, api_path)
  local query = string.format([[
    SELECT id, api_path, is_active
    FROM customer_api_permissions
    WHERE customer_id = '%s' AND is_active = true
  ]], customer_id)

  kong.log.debug("æª¢æŸ¥æ¬Šé™: ", customer_id, " -> ", api_path)

  local db, err = get_postgres_connection()
  if not db then
    return false, "è³‡æ–™åº«é€£æ¥å¤±æ•—: " .. tostring(err)
  end

  local res, err = db:query(query)
  db:close()

  if not res or #res == 0 then
    return false, "ç„¡æ¬Šé™è¨˜éŒ„"
  end

  -- æª¢æŸ¥è·¯å¾‘æ˜¯å¦åŒ¹é…
  for _, permission in ipairs(res) do
    if permission.is_active and permission.api_path then
      -- å®Œå…¨åŒ¹é…æˆ–è·¯å¾‘å‰ç¶´åŒ¹é…
      if permission.api_path == api_path or 
         string.sub(api_path, 1, string.len(permission.api_path)) == permission.api_path then
        kong.log.notice("âœ… æ¬Šé™é€šé: ", permission.id)
        return true, "æ¬Šé™åŒ¹é…: " .. permission.id
      end
    end
  end

  return false, "ç„¡åŒ¹é…æ¬Šé™"
end

-- ä¸»è¦è™•ç†å‡½æ•¸
function CustomAclHandler:access(conf)
  kong.log.notice("é–‹å§‹ ACL æ¬Šé™æª¢æŸ¥")

  -- æ­¥é©Ÿ 1ï¼šå–å¾—å®¢æˆ¶ ID
  local customer_id = extract_customer_id_from_keyauth()
  if not customer_id then
    return kong.response.exit(403, {
      error = "éœ€è¦å®¢æˆ¶ ID",
      message = "è«‹å…ˆé€šéèº«ä»½é©—è­‰"
    })
  end

  -- æ­¥é©Ÿ 2ï¼šå–å¾—è«‹æ±‚è·¯å¾‘
  local api_path = kong.request.get_path()
  kong.log.debug("æª¢æŸ¥è·¯å¾‘: ", customer_id, " -> ", api_path)

  -- æ­¥é©Ÿ 3ï¼šæª¢æŸ¥æ¬Šé™
  local allowed, reason = check_permissions(customer_id, api_path)

  if not allowed then
    kong.log.warn("âŒ æ¬Šé™æ‹’çµ•: ", customer_id, " -> ", api_path)
    return kong.response.exit(conf.error_code or 403, {
      error = conf.error_message or "å­˜å–è¢«æ‹’çµ•",
      customer_id = customer_id,
      api_path = api_path,
      reason = reason
    })
  end

  -- æ­¥é©Ÿ 4ï¼šæ¬Šé™é€šé
  kong.log.notice("âœ… æ¬Šé™æª¢æŸ¥é€šé: ", reason)
end

return CustomAclHandler
```

**ç¨‹å¼ç¢¼èªªæ˜ï¼š**
1. **å–å¾—å®¢æˆ¶ ID**ï¼šå¾ Kong çš„èº«ä»½é©—è­‰æ’ä»¶å–å¾—å®¢æˆ¶è­˜åˆ¥ç¢¼
2. **é€£æ¥è³‡æ–™åº«**ï¼šå»ºç«‹ PostgreSQL é€£æ¥
3. **æª¢æŸ¥æ¬Šé™**ï¼šæŸ¥è©¢è³‡æ–™åº«æª¢æŸ¥å®¢æˆ¶æ˜¯å¦æœ‰æ¬Šé™å­˜å–è©² API
4. **è¿”å›çµæœ**ï¼šæ ¹æ“šæ¬Šé™æª¢æŸ¥çµæœå…è¨±æˆ–æ‹’çµ•è«‹æ±‚

---

## âš™ï¸ ç¬¬å››æ­¥ï¼šå®šç¾©æ’ä»¶é…ç½®

### å»ºç«‹ schema.lua

```lua:custom-acl/schema.lua
local typedefs = require "kong.db.schema.typedefs"

return {
    name = "custom-acl",
    fields = {
        { protocols = typedefs.protocols_http },
        { config = {
            type = "record",
            fields = {
                -- éŒ¯èª¤å›æ‡‰è¨­å®š
                { error_code = { type = "number", default = 403 }},
                { error_message = { type = "string", default = "å­˜å–è¢«æ‹’çµ•" }},
                
                -- æ—¥èªŒè¨­å®š
                { enable_logging = { type = "boolean", default = true }},
                
                -- é™¤éŒ¯æ¨¡å¼
                { debug = { type = "boolean", default = false }}
            }
        }}
    }
}
```

**é…ç½®èªªæ˜ï¼š**
- `error_code`ï¼šæ¬Šé™æ‹’çµ•æ™‚çš„ HTTP ç‹€æ…‹ç¢¼
- `error_message`ï¼šæ¬Šé™æ‹’çµ•æ™‚çš„éŒ¯èª¤è¨Šæ¯
- `enable_logging`ï¼šæ˜¯å¦å•Ÿç”¨è©³ç´°æ—¥èªŒ
- `debug`ï¼šæ˜¯å¦å•Ÿç”¨é™¤éŒ¯æ¨¡å¼

---

## ğŸŒ ç¬¬äº”æ­¥ï¼šå»ºç«‹ç®¡ç† API

### å»ºç«‹ api.lua

```lua:custom-acl/api.lua
local cjson = require "cjson"
local postgres = require "resty.postgres"

-- è³‡æ–™åº«é€£æ¥å‡½æ•¸
local function get_postgres_connection()
    local config = {
        host = os.getenv("KONG_PG_HOST") or "kong-database",
        port = tonumber(os.getenv("KONG_PG_PORT")) or 5432,
        database = os.getenv("KONG_PG_DATABASE") or "kong",
        user = os.getenv("KONG_PG_USER") or "kong",
        password = os.getenv("KONG_PG_PASSWORD") or "kong"
    }

    local db, err = postgres:new()
    if not db then
        return nil, err
    end
    
    db:set_timeout(5000)
    
    local ok, err = db:connect(config.host, config.port, config.database, config.user, config.password)
    if not ok then
        return nil, err
    end
    
    return db
end

-- åŸ·è¡ŒæŸ¥è©¢
local function execute_query(query, params)
    local db, err = get_postgres_connection()
    if not db then
        return nil, err
    end
    
    local res, err = db:query(query, params)
    db:close()
    
    if not res then
        return nil, err
    end
    
    return res
end

return {
  -- æŸ¥è©¢æ¬Šé™åˆ—è¡¨
  ["/custom-acl/permissions"] = {
    GET = function(self, dao_factory, helpers)
      local customer_id = kong.request.get_query()["customer_id"]
      
      if not customer_id then
        return kong.response.exit(400, { error = "éœ€è¦æä¾› customer_id åƒæ•¸" })
      end
      
      local query = [[
        SELECT id, customer_id, api_path, method, is_active, created_at
        FROM customer_api_permissions 
        WHERE customer_id = $1 AND is_active = true
        ORDER BY created_at DESC
      ]]
      
      local res, err = execute_query(query, {customer_id})
      if not res then
        return kong.response.exit(500, { 
          error = "è³‡æ–™åº«æŸ¥è©¢å¤±æ•—",
          details = tostring(err)
        })
      end
      
      return kong.response.exit(200, {
        customer_id = customer_id,
        permissions = res,
        total = #res
      })
    end,
    
    -- æ–°å¢æ¬Šé™
    POST = function(self, dao_factory, helpers)
      local body = kong.request.get_body()
      
      if not body.customer_id then
        return kong.response.exit(400, { error = "éœ€è¦æä¾› customer_id" })
      end
      
      if not body.api_path then
        return kong.response.exit(400, { error = "éœ€è¦æä¾› api_path" })
      end
      
      local insert_query = [[
        INSERT INTO customer_api_permissions 
        (customer_id, api_path, method, is_active, created_by)
        VALUES ($1, $2, $3, $4, $5)
        RETURNING id, customer_id, api_path, method, is_active, created_at
      ]]
      
      local res, err = execute_query(insert_query, {
        body.customer_id,
        body.api_path,
        body.method or 'GET',
        body.is_active ~= false,
        body.created_by or 'system'
      })
      
      if not res then
        return kong.response.exit(500, { 
          error = "å»ºç«‹æ¬Šé™å¤±æ•—",
          details = tostring(err)
        })
      end
      
      return kong.response.exit(201, {
        message = "æ¬Šé™å»ºç«‹æˆåŠŸ",
        permission = res[1]
      })
    end
  },
  
  -- æ¸¬è©¦ API
  ["/custom-acl/test"] = {
    GET = function(self, dao_factory, helpers)
      return kong.response.exit(200, {
        message = "Custom ACL æ’ä»¶é‹ä½œæ­£å¸¸ï¼",
        timestamp = ngx.time(),
        version = "1.0.0"
      })
    end
  }
}
```

**API åŠŸèƒ½èªªæ˜ï¼š**
- `GET /custom-acl/permissions`ï¼šæŸ¥è©¢å®¢æˆ¶æ¬Šé™åˆ—è¡¨
- `POST /custom-acl/permissions`ï¼šæ–°å¢å®¢æˆ¶æ¬Šé™
- `GET /custom-acl/test`ï¼šæ¸¬è©¦æ’ä»¶æ˜¯å¦æ­£å¸¸é‹ä½œ

---

## ğŸ³ ç¬¬å…­æ­¥ï¼šå®¹å™¨åŒ–éƒ¨ç½²

### å»ºç«‹ Dockerfile

```dockerfile:custom-acl/Dockerfile
# ä½¿ç”¨å®˜æ–¹ Kong æ˜ åƒ
FROM kong:3.4

# å®‰è£å¿…è¦å·¥å…·
USER root
RUN apk add --no-cache postgresql-client

# è¤‡è£½æ’ä»¶æª”æ¡ˆ
COPY custom-acl /usr/local/share/lua/5.1/kong/plugins/custom-acl
RUN chown -R kong:kong /usr/local/share/lua/5.1/kong/plugins/custom-acl

# å°‡æ’ä»¶åŠ å…¥ Kong æ’ä»¶åˆ—è¡¨
RUN sed -i '/local plugins *= *{/a\    "custom-acl",' /usr/local/share/lua/5.1/kong/constants.lua

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV KONG_PLUGINS=bundled,custom-acl

# åˆ‡æ›å› kong ç”¨æˆ¶
USER kong

# å•Ÿå‹•å‘½ä»¤
CMD ["kong", "docker-start"]
```

### å»ºç«‹ docker-compose.yml

```yaml:custom-acl/docker-compose.yml
version: '3.8'

services:
  # PostgreSQL è³‡æ–™åº«
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kong
    volumes:
      - kong-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kong-net

  # Kong API Gateway
  kong:
    build: .
    container_name: kong-gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PORT: 5432
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PLUGINS: bundled,custom-acl
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
    ports:
      - "8000:8000"  # Proxy
      - "8001:8001"  # Admin API
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - kong-net

volumes:
  kong-data:

networks:
  kong-net:
    driver: bridge
```

---

## ğŸš€ ç¬¬ä¸ƒæ­¥ï¼šéƒ¨ç½²å’Œæ¸¬è©¦

### 1. å•Ÿå‹•æœå‹™

```bash
# å»ºç«‹ä¸¦å•Ÿå‹•æ‰€æœ‰æœå‹™
docker-compose up --build

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose ps
```

### 2. æª¢æŸ¥è³‡æ–™åº«

```bash
# é€£æ¥åˆ°è³‡æ–™åº«å®¹å™¨
docker exec -it kong-database psql -U kong -d kong

# æª¢æŸ¥è¡¨æ˜¯å¦å»ºç«‹
\dt customer_api_permissions

# æŸ¥çœ‹æ¸¬è©¦è³‡æ–™
SELECT * FROM customer_api_permissions;
```

### 3. æ¸¬è©¦æ’ä»¶

```bash
# æ¸¬è©¦æ’ä»¶æ˜¯å¦æ­£å¸¸é‹ä½œ
curl http://localhost:8001/custom-acl/test

# æŸ¥è©¢æ¬Šé™åˆ—è¡¨
curl "http://localhost:8001/custom-acl/permissions?customer_id=customer_001"

# æ–°å¢æ¬Šé™
curl -X POST http://localhost:8001/custom-acl/permissions \
  -H "Content-Type: application/json" \
  -d '{
    "customer_id": "customer_003",
    "api_path": "/api/test",
    "method": "GET",
    "is_active": true
  }'
```

---

## ğŸ” ç¬¬å…«æ­¥ï¼šå¸¸è¦‹å•é¡Œæ’è§£

### å•é¡Œ 1ï¼šæ’ä»¶ç„¡æ³•è¼‰å…¥
**ç—‡ç‹€ï¼š** Kong å•Ÿå‹•æ™‚å‡ºç¾æ’ä»¶è¼‰å…¥éŒ¯èª¤
**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# æª¢æŸ¥æ’ä»¶æª”æ¡ˆæ¬Šé™
docker exec -it kong-gateway ls -la /usr/local/share/lua/5.1/kong/plugins/custom-acl

# æª¢æŸ¥ Kong æ—¥èªŒ
docker-compose logs kong
```

### å•é¡Œ 2ï¼šè³‡æ–™åº«é€£æ¥å¤±æ•—
**ç—‡ç‹€ï¼š** æ’ä»¶ç„¡æ³•é€£æ¥è³‡æ–™åº«
**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# æª¢æŸ¥è³‡æ–™åº«æœå‹™ç‹€æ…‹
docker-compose ps kong-database

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
docker exec -it kong-gateway env | grep KONG_PG
```

### å•é¡Œ 3ï¼šæ¬Šé™æª¢æŸ¥ä¸æ­£ç¢º
**ç—‡ç‹€ï¼š** æœ‰æ¬Šé™çš„è«‹æ±‚è¢«æ‹’çµ•
**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# æª¢æŸ¥è³‡æ–™åº«ä¸­çš„æ¬Šé™è³‡æ–™
docker exec -it kong-database psql -U kong -d kong -c "SELECT * FROM customer_api_permissions WHERE customer_id = 'your_customer_id';"

# æª¢æŸ¥ Kong æ—¥èªŒä¸­çš„æ¬Šé™æª¢æŸ¥éç¨‹
docker-compose logs kong | grep "æ¬Šé™æª¢æŸ¥"
```
---

## ğŸ‰ æ­å–œå®Œæˆï¼

ä½ å·²ç¶“æˆåŠŸå­¸æœƒå¦‚ä½•é–‹ç™¼ Kong Custom ACL æ’ä»¶ï¼é€™å€‹å°ˆæ¡ˆæ¶µè“‹äº†ï¼š
- âœ… è³‡æ–™åº«è¨­è¨ˆ
- âœ… æ’ä»¶é–‹ç™¼
- âœ… å®¹å™¨åŒ–éƒ¨ç½²
- âœ… æ¸¬è©¦é©—è­‰

### ç›¸é—œè³‡æº
- [Kong å®˜æ–¹æ–‡ä»¶](https://docs.konghq.com/)
- [Lua ç¨‹å¼è¨­è¨ˆæŒ‡å—](https://www.lua.org/pil/)
- [PostgreSQL æ•™å­¸](https://www.postgresql.org/docs/)




